# 手麻用血查询字段血缘关系说明

## 数据库环境配置
- **查询引擎**: Presto
- **统一库名**: `hid0101_orcl_operaanesthisa_emrhis`
- **逻辑删除**: 所有表都需添加 `isdeleted = '0'` 筛选条件

## 核心表结构关系图

```
SAM_APPLY (手术申请表) - 主表
    ├── SAM_APPLY_OP (手术操作表) [sam_apply_id]
    ├── SAM_ANAR_ENENT (麻醉事件表) [sam_apply_id] 
    └── HRM_EMPLOYEE (员工表) [医生ID关联]

血制品相关：
SAM_ANAR_ENENT
    ├── BTM_BP_CATALOG (血制品目录) [btm_bp_catalog_id]
    └── BTM_SPEC_DICT (血制品规格) [btm_spec_dict_id]

字典表：
    └── PUB_SSJB (手术级别字典) [s_ssjb_dm]
```

## 详细字段血缘关系

### 1. 患者基本信息
| 输出字段 | 源表 | 源字段 | 数据类型 | 说明 |
|---------|------|--------|----------|------|
| 患者姓名 | SAM_APPLY | PATIENT_NAME | VARCHAR(30) | 直接获取 |
| 患者ID | SAM_APPLY | PERSON_INFO_ID | VARCHAR(20) | 患者唯一标识 |
| 性别 | SAM_APPLY | S_XB_DM | VARCHAR(1) | 1=男,2=女,其他=未知 |
| 年龄 | SAM_APPLY | AGE | INTEGER | 申请时年龄 |
| 床号 | SAM_APPLY | BED_NO | VARCHAR(10) | 患者床位号 |

### 2. 医生信息
| 输出字段 | 关联路径 | 说明 |
|---------|----------|------|
| 开单医生 | SAM_APPLY.REQ_DOCTOR_ID → HRM_EMPLOYEE.ID → NAME | 申请医生姓名 |
| 主刀医生 | SAM_APPLY_OP.OPERATOR_DOCTOR_ID → HRM_EMPLOYEE.ID → NAME | 实际手术医生 |
| 麻醉医师 | SAM_APPLY_OP.NARCOTIC_DOCTOR_ID → HRM_EMPLOYEE.ID → NAME | 麻醉负责医生 |

### 3. 手术信息
| 输出字段 | 源表 | 源字段 | 格式化说明 |
|---------|------|--------|------------|
| 手术日期 | SAM_APPLY_OP | OPERATOR_BEGIN_DATE | date_format('%Y-%m-%d') |
| 手术开始时间 | SAM_APPLY_OP | OPERATOR_BEGIN_DATE | date_format('%H:%i:%s') |
| 手术结束时间 | SAM_APPLY_OP | OPERATOR_END_DATE | date_format('%H:%i:%s') |
| 手术名称 | SAM_APPLY_OP | OPERATION_NAME | 直接获取 |
| 手术分级 | SAM_APPLY_OP.S_SSJB_DM → PUB_SSJB.S_SSJB_CMC | 关联字典表获取名称 |

### 4. 手术用血信息
| 输出字段 | 关联路径 | 筛选条件 | 说明 |
|---------|----------|----------|------|
| 输血品种 | SAM_ANAR_ENENT.BTM_BP_CATALOG_ID → BTM_BP_CATALOG.PRODUCT_NAME | S_MZSJLB_DM='04' | 按关键词分类 |
| 输血量 | SAM_ANAR_ENENT | SINGLE_DOSE | 直接获取 |
| 输血单位 | SAM_ANAR_ENENT | SINGLE_DOSE_UNIT | 计量单位 |
| 输血时间 | SAM_ANAR_ENENT | EXEC_DATE | 执行时间 |

## 血制品分类逻辑

```sql
CASE 
    WHEN bp.product_name LIKE '%红细胞%' OR bp.product_name LIKE '%RBC%' THEN '红细胞'
    WHEN bp.product_name LIKE '%血浆%' OR bp.product_name LIKE '%PLASMA%' THEN '血浆' 
    WHEN bp.product_name LIKE '%血小板%' OR bp.product_name LIKE '%PLT%' THEN '血小板'
    WHEN bp.product_name LIKE '%冷沉淀%' OR bp.product_name LIKE '%CRYO%' THEN '冷沉淀'
    ELSE bp.product_name  -- 其他血制品显示原名
END
```

## 核心筛选条件

### 业务过滤条件
```sql
WHERE t.health_service_org_id = 'HXSSMZK'     -- 医疗机构
    AND t.oper_type = 'ROOM_OPER'             -- 手术类型：手术室手术
    AND t.is_reject = '2'                     -- 未拒收：2=已接收
    AND t.s_sssyzt_dm = '90'                 -- 手术状态：90=已完成
    AND ae.s_mzsjlb_dm = '04'                -- 麻醉事件类别：04=输血事件
```

### 技术过滤条件  
```sql
AND t.isdeleted = '0'          -- 手术申请表逻辑删除
AND sao.isdeleted = '0'        -- 手术操作表逻辑删除  
AND ae.isdeleted = '0'         -- 麻醉事件表逻辑删除
AND bp.isdeleted = '0'         -- 血制品目录表逻辑删除
AND req_doc.isdeleted = '0'    -- 员工表逻辑删除
```

## 关联关系说明

### 主表关联
```sql
-- 主表：手术申请
FROM sam_apply t

-- 手术操作信息（一对多）
LEFT JOIN sam_apply_op sao ON t.id = sao.sam_apply_id

-- 用血事件信息（一对多）
LEFT JOIN sam_anar_enent ae ON t.id = ae.sam_apply_id AND ae.s_mzsjlb_dm = '04'
```

### 字典表关联
```sql
-- 医生姓名
LEFT JOIN hrm_employee req_doc ON t.req_doctor_id = req_doc.id
LEFT JOIN hrm_employee op_doc ON sao.operator_doctor_id = op_doc.id

-- 手术级别
LEFT JOIN pub_ssjb sl ON sao.s_ssjb_dm = sl.s_ssjb_dm

-- 血制品信息
LEFT JOIN btm_bp_catalog bp ON ae.btm_bp_catalog_id = bp.id
LEFT JOIN btm_spec_dict bs ON ae.btm_spec_dict_id = bs.id
```

## 性能优化建议

### 1. 索引建议
```sql
-- 推荐在以下字段建立索引：
sam_apply: health_service_org_id, oper_type, s_sssyzt_dm, operator_begin_date
sam_apply_op: sam_apply_id, operator_begin_date  
sam_anar_enent: sam_apply_id, s_mzsjlb_dm, exec_date
hrm_employee: id
```

### 2. 查询优化
- 使用时间范围限制减少数据量
- 避免不必要的LEFT JOIN
- 优先使用WHERE条件过滤

### 3. 数据一致性检查
```sql
-- 检查孤立记录
SELECT COUNT(*) FROM sam_apply_op sao 
LEFT JOIN sam_apply t ON sao.sam_apply_id = t.id 
WHERE t.id IS NULL;

-- 检查缺失的血制品信息
SELECT COUNT(*) FROM sam_anar_enent ae 
WHERE ae.s_mzsjlb_dm = '04' AND ae.btm_bp_catalog_id IS NULL;
```

## 常见问题和解决方案

### 1. 数据重复问题
**原因**: 一个手术可能有多个手术操作记录或多次用血记录
**解决**: 在统计时使用 DISTINCT 或者按需求决定是否需要明细行

### 2. 时间字段为空
**原因**: 手术可能尚未开始或者数据录入不完整
**解决**: 使用 LEFT JOIN 保留所有申请记录，时间字段允许为空

### 3. 医生姓名显示为空
**原因**: 医生ID在HRM_EMPLOYEE表中不存在或已被逻辑删除
**解决**: 检查数据一致性，必要时显示医生ID

### 4. 血制品分类不准确
**原因**: 血制品名称格式不标准或包含特殊字符
**解决**: 完善CASE WHEN逻辑，增加更多匹配规则

## 扩展功能

### 统计分析查询
1. 按科室统计用血情况
2. 按血制品类型统计用量
3. 按手术级别分析用血率
4. 按时间段分析用血趋势

### 报表筛选条件
- 时间范围筛选
- 科室筛选  
- 手术级别筛选
- 医生筛选
- 血制品类型筛选 
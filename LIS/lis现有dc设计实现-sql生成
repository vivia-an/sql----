-- =============================================
-- LISæ ‡æœ¬ä¸»è¡¨æ•°æ®é›†æˆSQL - åŸºäºè¡€ç¼˜å…³ç³»ä¿®æ­£ç‰ˆæœ¬
-- åº“å: hid0101_orcl_lis_dbo
-- æºè¡¨: lis_inspection_sample
-- å­—æ®µå­˜åœ¨æ€§å·²éªŒè¯ï¼Œä¸å­˜åœ¨å­—æ®µç”¨ç©ºå­—ç¬¦ä¸²æ›¿ä»£
-- =============================================
create view datacenter_db.lis_sample_main as
SELECT
    cast('HID0101' as varchar(65535)) as "LIS_Sample_Main_MedOrgCode",        -- åŒ»ç–—æœºæ„ä»£ç ï¼Œæ¥æºï¼šæ ‡å‡†åŒ–
    cast('å››å·å¤§å­¦åè¥¿åŒ»é™¢' as varchar(65535)) as "LIS_Sample_Main_MedOrgName", -- åŒ»ç–—æœºæ„åç§°ï¼Œæ¥æºï¼šæ ‡å‡†åŒ–
    cast(COALESCE(null, '') as varchar(65535)) as "LIS_Sample_Main_EmpiID",   -- äººå‘˜å”¯ä¸€æ ‡è¯†IDï¼Œå­—æ®µæœªæ‰¾åˆ°
    cast(COALESCE(null, '') as varchar(65535)) as "LIS_Sample_Main_EmpiNo",   -- äººå‘˜å”¯ä¸€å·ï¼Œå­—æ®µæœªæ‰¾åˆ°
    -- åŒ»å˜±ID âœ…è¡€ç¼˜ï¼šLIS_REQUISITION_ITEM.his_id
    CAST(COALESCE( replace( ri."his_id",'--','||'), '') AS VARCHAR(65535)) as "LIS_Sample_Main_HISID", -- åŒ»å˜±ID âœ…è¡€ç¼˜ï¼šLIS_REQUISITION_ITEM.his_id
        CAST(COALESCE(s."inspection_id", '') AS VARCHAR(65535)) as "LIS_Sample_Main_SampleID", -- æ ‡æœ¬ID(æ¡ç å·)ï¼Œæ¥æºï¼šlis_inspection_sample.inspection_id
    CAST(COALESCE(s."inspection_date", '') AS VARCHAR(65535)) as "LIS_Sample_Main_InspectionDate", -- æ£€éªŒæ—¥æœŸ(YYYYMMDD)ï¼Œæ¥æºï¼šlis_inspection_sample.inspection_date
    CAST(COALESCE(s."outpatient_id", '') AS VARCHAR(65535)) as "LIS_Sample_Main_PersID", -- ç—…äººæ ‡è¯†ï¼Œæ¥æºï¼šlis_inspection_sample.outpatient_id
    CAST(COALESCE(pa."paadm_admno", '') AS VARCHAR(65535)) as "LIS_Sample_Main_VisitID", -- å°±è¯Šå·ï¼Œæ¥æºï¼špa_adm.paadm_admno
    CAST(CASE s."patient_type"
        WHEN '2' THEN 'é—¨è¯Š'
        WHEN '3' THEN 'ä½é™¢æ€¥è¯Š'
        WHEN '4' THEN 'é—¨è¯Šæ€¥è¯Š'
        WHEN '5' THEN 'ä½“æ£€'
        WHEN '6' THEN 'å¤–é™¢'
        WHEN '7' THEN 'å…¶ä»–'
        WHEN '8' THEN 'ç§‘ç ”'
        ELSE 'å…¶ä»–'
    END AS VARCHAR(65535)) as "LIS_Sample_Main_VisitTypeName", -- å°±è¯Šç±»å‹åç§°ï¼Œæ¥æºï¼šlis_inspection_sample.patient_type
    CAST(COALESCE(s."patient_dept", '') AS VARCHAR(65535)) as "LIS_Sample_Main_DeptID", -- ç”³è¯·ç§‘å®¤IDï¼Œæ¥æºï¼šlis_inspection_sample.patient_dept
    CAST(COALESCE(s."patient_dept_name", '') AS VARCHAR(65535)) as "LIS_Sample_Main_DeptName", -- ç”³è¯·ç§‘å®¤åç§°ï¼Œæ¥æºï¼šlis_inspection_sample.patient_dept_name
    CAST(COALESCE(s."group_id", '') AS VARCHAR(65535)) as "LIS_Sample_Main_ProfGroupCode", -- äºšä¸“ä¸šç»„ä»£ç ï¼Œæ¥æºï¼šlis_inspection_sample.group_id
    CAST(COALESCE(pg."PGROUP_NAME", 'å…¶ä»–') AS VARCHAR(65535)) as "LIS_Sample_Main_ProfGroupName", -- äºšä¸“ä¸šç»„åç§°ï¼Œæ¥æºï¼šlis5_inspection_pgroup.PGROUP_NAME
    CAST(COALESCE(s."sample_class", '') AS VARCHAR(65535)) as "LIS_Sample_Main_SampleTypeID", -- æ ‡æœ¬ç±»å‹IDï¼Œæ¥æºï¼šlis_inspection_sample.sample_class
    CAST(COALESCE(s."sample_class", '') AS VARCHAR(65535)) as "LIS_Sample_Main_SampleTypeCode", -- æ ‡æœ¬ç±»å‹ä»£ç ï¼Œæ¥æºï¼šlis_inspection_sample.sample_class
    CAST(COALESCE(s."sample_class_name", '') AS VARCHAR(65535)) as "LIS_Sample_Main_SampleTypeName", -- æ ‡æœ¬ç±»å‹åç§°ï¼Œæ¥æºï¼šlis_inspection_sample.sample_class_name
    CAST(COALESCE(s."requisition_time", '') AS VARCHAR(65535)) as "LIS_Sample_Main_RequisitionDtTm", -- ç”³è¯·æ—¶é—´ï¼Œæ¥æºï¼šlis_inspection_sample.requisition_time
    CAST(COALESCE(s."sampling_person", '') AS VARCHAR(65535)) as "LIS_Sample_Main_SamplingPersName", -- é‡‡é›†äººå‘˜å§“åï¼Œæ¥æºï¼šlis_inspection_sample.sampling_person
    CAST(COALESCE(s."sampling_time", '') AS VARCHAR(65535)) as "LIS_Sample_Main_SamplingDtTm", -- é‡‡é›†æ—¶é—´ï¼Œæ¥æºï¼šlis_inspection_sample.sampling_time
    CAST(COALESCE(s."test_order_name", '') AS VARCHAR(65535)) as "LIS_Sample_Main_SamplingContent", -- é‡‡é›†å†…å®¹(æ£€éªŒç›®çš„)ï¼Œæ¥æºï¼šlis_inspection_sample.test_order_name
    CAST(COALESCE(s."incept_person", '') AS VARCHAR(65535)) as "LIS_Sample_Main_ReceivePersName", -- æ¥æ”¶äººå‘˜å§“åï¼Œæ¥æºï¼šlis_inspection_sample.incept_person
    CAST(COALESCE(s."incept_time", '') AS VARCHAR(65535)) as "LIS_Sample_Main_ReceiveDtTm", -- æ¥æ”¶æ—¶é—´ï¼Œæ¥æºï¼šlis_inspection_sample.incept_time
    CAST(COALESCE(s."inspection_person", '') AS VARCHAR(65535)) as "LIS_Sample_Main_InspectionPersName", -- æ£€éªŒäººå‘˜å§“åï¼Œæ¥æºï¼šlis_inspection_sample.inspection_person
    cast('' as varchar(65535)) as "LIS_Sample_Main_ReportPersName", -- æŠ¥å‘Šäººå‘˜å§“åï¼Œå­—æ®µæœªæ‰¾åˆ°
    cast('' as varchar(65535)) as "LIS_Sample_Main_ReportDtTm",     -- æŠ¥å‘Šæ—¶é—´ï¼Œå­—æ®µæœªæ‰¾åˆ°
    cast('' as varchar(65535)) as "LIS_Sample_Main_ReportContent",  -- æŠ¥å‘Šå†…å®¹ï¼Œå­—æ®µæœªæ‰¾åˆ°
    CAST(COALESCE(s."check_person", '') AS VARCHAR(65535)) as "LIS_Sample_Main_CheckPersName", -- å®¡æ ¸äººå‘˜å§“åï¼Œæ¥æºï¼šlis_inspection_sample.check_person
    CAST(COALESCE(s."check_time", '') AS VARCHAR(65535)) as "LIS_Sample_Main_CheckDtTm", -- å®¡æ ¸æ—¶é—´ï¼Œæ¥æºï¼šlis_inspection_sample.check_time
    CAST(COALESCE(s."remark", '') AS VARCHAR(65535)) as "LIS_Sample_Main_CheckContent", -- å®¡æ ¸å†…å®¹(å¤‡æ³¨)ï¼Œæ¥æºï¼šlis_inspection_sample.remark
    CASE s."inspection_state"
        WHEN 'audited' THEN 'å·²å®¡æ ¸'
        WHEN 'sent' THEN 'å·²å‘é€'
        WHEN 'finished' THEN 'å·²å®Œæˆ'
        WHEN 'reported' THEN 'å·²æŠ¥å‘Š'
        WHEN 'inspecting' THEN 'æ£€éªŒä¸­'
        ELSE 'æœªçŸ¥'
    END as "LIS_Sample_Main_SampleStatusName", -- æ ‡æœ¬çŠ¶æ€åç§°ï¼Œæ¥æºï¼šlis_inspection_sample.inspection_state
    CASE WHEN s."charge_type" LIKE '%é‡‘å¡%' OR s."charge_type" LIKE '%VIP%'
         THEN 'Y' ELSE 'N' END as "LIS_Sample_Main_IsGoldenCard", -- æ˜¯å¦é‡‘å¡(Y/N)ï¼Œæ¥æºï¼šlis_inspection_sample.charge_type
    CAST(COALESCE(s."input_person", '') AS VARCHAR(65535)) as "LIS_Sample_Main_InputPersName", -- ç™»è®°äººå‘˜å§“åï¼Œæ¥æºï¼šlis_inspection_sample.input_person
    CAST(COALESCE(s."input_time", '') AS VARCHAR(65535)) as "LIS_Sample_Main_InputDtTm", -- ç™»è®°æ—¶é—´ï¼Œæ¥æºï¼šlis_inspection_sample.input_time
    cast('8' as varchar(65535)) as "LIS_Sample_Main_DataSourceFlag", -- æ•°æ®æ¥æºæ ‡è¯†ï¼Œæ¥æºï¼šæ ‡å‡†åŒ–
    cast('hid0101_orcl_lis_dbo.lis_inspection_sample' as varchar(65535)) as "LIS_Sample_Main_DSTable", -- æ•°æ®æºè¡¨ï¼Œæ¥æºï¼šæ ‡å‡†åŒ–
    cast('inspection_id' as varchar(65535)) as "LIS_Sample_Main_DSTableKey", -- æ•°æ®æºè¡¨ä¸»é”®ï¼Œæ¥æºï¼šæ ‡å‡†åŒ–
    CAST(COALESCE(s."inspection_id", '') AS VARCHAR(65535)) as "LIS_Sample_Main_DSTableValue", -- æ•°æ®æºè¡¨ä¸»é”®å€¼ï¼Œæ¥æºï¼šlis_inspection_sample.inspection_id
    CAST(current_timestamp AS VARCHAR(19)) as "LIS_Sample_Main_LastUpdateDtTm", -- æœ€åæ›´æ–°æ—¶é—´ï¼Œæ¥æºï¼šç³»ç»Ÿæ—¶é—´
    CAST(current_timestamp AS VARCHAR(19)) as "LIS_Sample_Main_DataCreateDtTm",  -- æ•°æ®åˆ›å»ºæ—¶é—´ï¼Œæ¥æºï¼šç³»ç»Ÿæ—¶é—´
    '0' as "LIS_Sample_Main_IsDeleted"

FROM hid0101_orcl_lis_dbo.lis_inspection_sample s
LEFT JOIN hid0101_cache_his_dhcapp_sqluser.pa_adm pa
    ON s."patient_id" = pa."rowkey"
    AND pa."isdeleted" = '0'
-- åŒ»å˜±ä¿¡æ¯å…³è” âœ…è¡€ç¼˜ï¼šLIS_REQUISITION_ITEMè¡¨è·å–åŒ»å˜±ID
LEFT JOIN hid0101_orcl_lis_dbo.lis_requisition_item ri
    ON s."requisition_id" = ri."requisition_id"                      -- æ ‡æœ¬ä¿¡æ¯å…³è”åŒ»å˜±ä¿¡æ¯ âœ…è¡€ç¼˜ï¼šlis_inspection_sample.requisition_id = lis_requisition_item.requisition_id
    AND ri."isdeleted" = '0'
LEFT JOIN hid0101_orcl_lis_dbo.lis_inspection_group g 
    ON s."group_id" = g."GROUP_ID" 
    AND g."isdeleted" = '0'
LEFT JOIN hid0101_orcl_lis_xhsystem1.lis5_inspection_pgroup pg 
    ON g."INSPECTION_DEPT" = pg."PGROUP_ID" 
    AND pg."isdeleted" = '0'
WHERE s."inspection_date" >= CAST(DATE_FORMAT(DATE_ADD('day', -1, NOW()), '%Y%m%d') AS VARCHAR(65535))
    AND s."inspection_id" IS NOT NULL
    AND s."isdeleted" = '0';



-- =============================================
-- LISåŒ»å˜±ä¸»è¡¨æ•°æ®é›†æˆSQL - åŸºäºè¡€ç¼˜å…³ç³»ä¿®æ­£ç‰ˆæœ¬  
-- è¡€ç¼˜ä¾æ®ï¼šLISè¡€ç¼˜22æ–‡æ¡£V2.0
-- ä¸»è¡¨ï¼šlis_inspection_sample (æ£€éªŒæ ‡æœ¬ä¿¡æ¯è¡¨)
-- =============================================
create view datacenter_db.dwd_lis_order_main as
SELECT
    -- åŸºç¡€æ ‡è¯†ä¿¡æ¯ ğŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    cast('HID0101' as varchar(65535)) as "LIS_Order_Main_MedOrgCode",       -- åŒ»ç–—æœºæ„ä»£ç  ğŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    cast('å››å·å¤§å­¦åè¥¿åŒ»é™¢' as varchar(65535)) as "LIS_Order_Main_MedOrgName", -- åŒ»ç–—æœºæ„åç§° ğŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    cast(null as varchar(65535)) as "LIS_Order_Main_EmpiID",                -- äººå‘˜å”¯ä¸€æ ‡è¯†ID ğŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    cast(null as varchar(65535)) as "LIS_Order_Main_EmpiNo",                -- äººå‘˜å”¯ä¸€å· ğŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    CAST(COALESCE(s."outpatient_id", '') AS VARCHAR(65535)) as "LIS_Order_Main_PersID",                    -- ç—…äººæ ‡è¯† âœ…è¡€ç¼˜ï¼šå–lis_inspection_sample.outpatient_idä½œä¸ºç—…äººæ ‡è¯†
    cast(COALESCE(null, '') as varchar(65535)) as "LIS_Order_Main_PersNo",                -- äººå‘˜å· ğŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    CAST(COALESCE(s."inspection_id", '') AS VARCHAR(65535)) as "LIS_Order_Main_ReqID",                     -- ç”³è¯·å•ID âœ…è¡€ç¼˜ï¼šlis_inspection_sample.inspection_idï¼ˆæ£€éªŒIDä½œä¸ºç”³è¯·å•IDï¼‰
    CAST(COALESCE( replace( ri."his_id",'--','||'), '') AS VARCHAR(65535)) as "LIS_Order_Main_HISID",                      -- åŒ»å˜±ID âœ…è¡€ç¼˜ï¼šLIS_REQUISITION_ITEM.his_id
    CAST(COALESCE(s."inspection_id", '') AS VARCHAR(65535)) as "LIS_Order_Main_SampleID",                  -- æ ‡æœ¬ID âœ…è¡€ç¼˜ï¼šlis_inspection_sample.inspection_idï¼ˆæ ‡æœ¬å”¯ä¸€æ ‡è¯†ï¼‰
    CAST(COALESCE(pa."paadm_admno", '') AS VARCHAR(65535)) as "LIS_Order_Main_VisitID",                    -- å°±è¯Šå· âœ…è¡€ç¼˜ï¼šé€šè¿‡pa_adm.paadm_admnoè·å–å°±è¯Šå·
    CAST(COALESCE(s."outpatient_id", '') AS VARCHAR(65535)) as "LIS_Order_Main_VisitNo",                   -- å°±è¯Šå· âœ…è¡€ç¼˜ï¼šlis_inspection_sample.outpatient_id
    cast(null as varchar(65535)) as "LIS_Order_Main_RegID",                 -- æŒ‚å·ID ğŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    cast(null as varchar(65535)) as "LIS_Order_Main_RegNo",                 -- æŒ‚å·å· ğŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    
    -- ç”³è¯·ç›¸å…³å­—æ®µ âœ…è¡€ç¼˜éªŒè¯
    CAST(COALESCE(s."inspection_date", '') AS VARCHAR(65535)) as "LIS_Order_Main_InspectionDate",           -- æ£€éªŒæ—¥æœŸ âœ…è¡€ç¼˜ï¼šlis_inspection_sample.inspection_dateï¼ˆYYYYMMDDæ ¼å¼ï¼‰
    CAST(COALESCE(s."requisition_time", '') AS VARCHAR(65535)) as "LIS_Order_Main_ReqDtTm",                -- ç”³è¯·æ—¶é—´ âœ…è¡€ç¼˜ï¼šlis_inspection_sample.requisition_timeï¼ˆç”³è¯·æ—¶é—´ï¼‰
    CAST(COALESCE(s."patient_dept", '') AS VARCHAR(65535)) as "LIS_Order_Main_ReqDeptCode",                -- ç”³è¯·ç§‘å®¤ä»£ç  âœ…è¡€ç¼˜ï¼šlis_inspection_sample.patient_deptï¼ˆç”³è¯·ç§‘å®¤IDï¼‰
    CAST(COALESCE(s."patient_dept_name", '') AS VARCHAR(65535)) as "LIS_Order_Main_ReqDeptName",           -- ç”³è¯·ç§‘å®¤åç§° âœ…è¡€ç¼˜ï¼šlis_inspection_sample.patient_dept_name
    CAST(COALESCE(s."requisition_person", '') AS VARCHAR(65535)) as "LIS_Order_Main_ReqDoctorCode",        -- ç”³è¯·åŒ»ç”Ÿä»£ç  âœ…è¡€ç¼˜ï¼šlis_inspection_sample.requisition_personï¼ˆå¼€å•äººå‘˜ï¼‰
    CAST(COALESCE(s."requisition_person", '') AS VARCHAR(65535)) as "LIS_Order_Main_ReqDoctorName",        -- ç”³è¯·åŒ»ç”Ÿå§“å âœ…è¡€ç¼˜ï¼šlis_inspection_sample.requisition_person
    cast(null as varchar(65535)) as "LIS_Order_Main_ReqNurseCode",          -- ç”³è¯·æŠ¤å£«ä»£ç  ğŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    cast(null as varchar(65535)) as "LIS_Order_Main_ReqNurseName",          -- ç”³è¯·æŠ¤å£«å§“å ğŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    
    -- å°±è¯Šç±»å‹ä¿¡æ¯ âœ…è¡€ç¼˜éªŒè¯
    CAST(CASE s."patient_type"
        WHEN '2' THEN 'é—¨è¯Š'
        WHEN '3' THEN 'ä½é™¢æ€¥è¯Š'
        WHEN '4' THEN 'é—¨è¯Šæ€¥è¯Š'
        WHEN '5' THEN 'ä½“æ£€'
        WHEN '6' THEN 'å¤–é™¢'
        WHEN '7' THEN 'å…¶ä»–'
        WHEN '8' THEN 'ç§‘ç ”'
        ELSE 'å…¶ä»–'
    END AS VARCHAR(65535)) as "LIS_Order_Main_VisitTypeName",                            -- å°±è¯Šç±»å‹åç§° âœ…è¡€ç¼˜ï¼šlis_inspection_sample.patient_typeï¼ˆæ‚£è€…ç±»å‹æšä¸¾å€¼ï¼‰
    
    -- ç§‘å®¤ä¿¡æ¯ âœ…è¡€ç¼˜éªŒè¯
    CAST(COALESCE(s."patient_dept", '') AS VARCHAR(65535)) as "LIS_Order_Main_DeptID",                     -- ç”³è¯·ç§‘å®¤ID âœ…è¡€ç¼˜ï¼šlis_inspection_sample.patient_dept
    CAST(COALESCE(s."patient_dept_name", '') AS VARCHAR(65535)) as "LIS_Order_Main_DeptName",              -- ç”³è¯·ç§‘å®¤åç§° âœ…è¡€ç¼˜ï¼šlis_inspection_sample.patient_dept_name
    CAST(COALESCE(s."group_id", '') AS VARCHAR(65535)) as "LIS_Order_Main_ProfGroupCode",                  -- äºšä¸“ä¸šç»„ä»£ç  âœ…è¡€ç¼˜ï¼šlis_inspection_sample.group_id
    -- ğŸ”¥ä¸‰è¡¨å…³è”è·å–äºšä¸“ä¸šç»„åç§°ï¼ˆé‡è¦è¡€ç¼˜å…³ç³»ï¼‰
    CAST(COALESCE(pg."PGROUP_NAME", 'å…¶ä»–ä¸“ä¸šç»„') AS VARCHAR(65535)) as "LIS_Order_Main_ProfGroupName", -- äºšä¸“ä¸šç»„åç§° âœ…è¡€ç¼˜ï¼šä¸‰è¡¨å…³è” s.group_idâ†’g.GROUP_IDâ†’g.INSPECTION_DEPTâ†’pg.PGROUP_IDâ†’pg.PGROUP_NAME
    
    -- æ ‡æœ¬ç±»å‹ä¿¡æ¯ âœ…è¡€ç¼˜éªŒè¯
    CAST(COALESCE(s."sample_class", '') AS VARCHAR(65535)) as "LIS_Order_Main_SampleTypeID",               -- æ ‡æœ¬ç±»å‹ID âœ…è¡€ç¼˜ï¼šlis_inspection_sample.sample_class
    CAST(COALESCE(s."sample_class", '') AS VARCHAR(65535)) as "LIS_Order_Main_SampleTypeCode",             -- æ ‡æœ¬ç±»å‹ä»£ç  âœ…è¡€ç¼˜ï¼šlis_inspection_sample.sample_class
    CAST(COALESCE(s."sample_class_name", '') AS VARCHAR(65535)) as "LIS_Order_Main_SampleTypeName",        -- æ ‡æœ¬ç±»å‹åç§° âœ…è¡€ç¼˜ï¼šlis_inspection_sample.sample_class_name
    
    -- é‡‡é›†ã€æ¥æ”¶ã€æ£€éªŒäººå‘˜ä¿¡æ¯ âœ…è¡€ç¼˜éªŒè¯
    CAST(COALESCE(s."sampling_person", '') AS VARCHAR(65535)) as "LIS_Order_Main_SamplingPersName",        -- é‡‡é›†äººå‘˜å§“å âœ…è¡€ç¼˜ï¼šlis_inspection_sample.sampling_person
    CAST(COALESCE(s."sampling_time", '') AS VARCHAR(65535)) as "LIS_Order_Main_SamplingDtTm",              -- é‡‡é›†æ—¶é—´ âœ…è¡€ç¼˜ï¼šlis_inspection_sample.sampling_time
    CAST(COALESCE(s."test_order_name", '') AS VARCHAR(65535)) as "LIS_Order_Main_SamplingContent",         -- é‡‡é›†å†…å®¹(æ£€éªŒç›®çš„) âœ…è¡€ç¼˜ï¼šlis_inspection_sample.test_order_name
    CAST(COALESCE(s."incept_person", '') AS VARCHAR(65535)) as "LIS_Order_Main_ReceivePersName",           -- æ¥æ”¶äººå‘˜å§“å âœ…è¡€ç¼˜ï¼šlis_inspection_sample.incept_person
    CAST(COALESCE(s."incept_time", '') AS VARCHAR(65535)) as "LIS_Order_Main_ReceiveDtTm",                 -- æ¥æ”¶æ—¶é—´ âœ…è¡€ç¼˜ï¼šlis_inspection_sample.incept_time
    CAST(COALESCE(s."inspection_person", '') AS VARCHAR(65535)) as "LIS_Order_Main_InspectionPersName",    -- æ£€éªŒäººå‘˜å§“å âœ…è¡€ç¼˜ï¼šlis_inspection_sample.inspection_person
    
    -- æŠ¥å‘Šäººå‘˜ä¿¡æ¯ âœ…è¡€ç¼˜éªŒè¯ï¼ˆå­—æ®µä¸å­˜åœ¨ä½¿ç”¨ç©ºå€¼ï¼‰
    cast(null as varchar(65535)) as "LIS_Order_Main_ReportPersName",        -- æŠ¥å‘Šäººå‘˜å§“å ğŸš¨è¡€ç¼˜ï¼šlis_inspection_sample.issued_personï¼ˆå­—æ®µä¸å­˜åœ¨ï¼‰
    cast(null as timestamp) as "LIS_Order_Main_ReportDtTm",          -- æŠ¥å‘Šæ—¶é—´ ğŸš¨è¡€ç¼˜ï¼šlis_inspection_sample.issued_timeï¼ˆå­—æ®µä¸å­˜åœ¨ï¼‰
    cast(null as varchar(65535)) as "LIS_Order_Main_ReportContent",         -- æŠ¥å‘Šå†…å®¹ ğŸš¨è¡€ç¼˜ï¼šlis_inspection_sample.internal_remarkï¼ˆå­—æ®µä¸å­˜åœ¨ï¼‰
    
    -- å®¡æ ¸äººå‘˜ä¿¡æ¯ âœ…è¡€ç¼˜éªŒè¯
    CAST(COALESCE(s."check_person", '') AS VARCHAR(65535)) as "LIS_Order_Main_CheckPersName",              -- å®¡æ ¸äººå‘˜å§“å âœ…è¡€ç¼˜ï¼šlis_inspection_sample.check_person
    CAST(COALESCE(s."check_time", '') AS VARCHAR(65535)) as "LIS_Order_Main_CheckDtTm",                    -- å®¡æ ¸æ—¶é—´ âœ…è¡€ç¼˜ï¼šlis_inspection_sample.check_time
    CAST(COALESCE(s."remark", '') AS VARCHAR(65535)) as "LIS_Order_Main_CheckContent",                     -- å®¡æ ¸å†…å®¹(å¤‡æ³¨) âœ…è¡€ç¼˜ï¼šlis_inspection_sample.remark
    
    -- å…¶ä»–å­—æ®µ âœ…è¡€ç¼˜éªŒè¯
    CAST(CASE s."inspection_state"
        WHEN 'audited' THEN 'å·²å®¡æ ¸'
        WHEN 'sent' THEN 'å·²å‘é€'
        WHEN 'finished' THEN 'å·²å®Œæˆ'
        WHEN 'reported' THEN 'å·²æŠ¥å‘Š'
        WHEN 'inspecting' THEN 'æ£€éªŒä¸­'
        ELSE 'æœªçŸ¥'
    END AS VARCHAR(65535)) as "LIS_Order_Main_SampleStatusName",                        -- æ ‡æœ¬çŠ¶æ€åç§° âœ…è¡€ç¼˜ï¼šlis_inspection_sample.inspection_stateï¼ˆçŠ¶æ€æšä¸¾å€¼ï¼‰
    CAST(CASE WHEN s."charge_type" LIKE '%é‡‘å¡%' OR s."charge_type" LIKE '%VIP%'
         THEN 'Y' ELSE 'N' END AS VARCHAR(65535)) as "LIS_Order_Main_IsGoldenCard",     -- æ˜¯å¦é‡‘å¡(Y/N) âœ…è¡€ç¼˜ï¼šlis_inspection_sample.charge_typeï¼ˆæ”¶è´¹ç±»åˆ«åˆ¤æ–­ï¼‰
    CAST(COALESCE(s."input_person", '') AS VARCHAR(65535)) as "LIS_Order_Main_InputPersName",              -- ç™»è®°äººå‘˜å§“å âœ…è¡€ç¼˜ï¼šlis_inspection_sample.input_person
    CAST(COALESCE(s."input_time", '') AS VARCHAR(65535)) as "LIS_Order_Main_InputDtTm",                    -- ç™»è®°æ—¶é—´ âœ…è¡€ç¼˜ï¼šlis_inspection_sample.input_time
    
    -- ç³»ç»Ÿå­—æ®µ ğŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–ï¼ŒåŸºäºè¡€ç¼˜å…³ç³»ä¿®æ­£
    cast('8' as varchar(65535)) as "LIS_Order_Main_DataSourceFlag",         -- æ•°æ®æ¥æºæ ‡è¯† ğŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    cast('hid0101_orcl_lis_dbo.lis_inspection_sample' as varchar(65535)) as "LIS_Order_Main_DSTable", -- æ•°æ®æºè¡¨ âœ…è¡€ç¼˜ï¼šä¸»è¡¨ä¿®æ­£ä¸ºlis_inspection_sample
    cast('inspection_id' as varchar(65535)) as "LIS_Order_Main_DSTableKey", -- æ•°æ®æºè¡¨ä¸»é”® âœ…è¡€ç¼˜ï¼šä¸»é”®ä¿®æ­£ä¸ºinspection_id
    cast(s."inspection_id" as varchar(65535)) as "LIS_Order_Main_DSTableValue", -- æ•°æ®æºè¡¨ä¸»é”®å€¼ âœ…è¡€ç¼˜ï¼šlis_inspection_sample.inspection_id
    CAST(current_timestamp AS VARCHAR(19)) as "LIS_Order_Main_LastUpdateDtTm", -- æœ€åæ›´æ–°æ—¶é—´ ğŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    CAST(current_timestamp AS VARCHAR(19)) as "LIS_Order_Main_DataCreateDtTm"  -- æ•°æ®åˆ›å»ºæ—¶é—´ ğŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–

-- è¡€ç¼˜å…³ç³»ï¼šåŸºäºLISè¡€ç¼˜22æ–‡æ¡£V2.0çš„è¡¨å…³è”
FROM hid0101_orcl_lis_dbo.lis_inspection_sample s                     -- ä¸»è¡¨ï¼šæ£€éªŒæ ‡æœ¬ä¿¡æ¯è¡¨ âœ…è¡€ç¼˜ï¼šlis_inspection_sampleä½œä¸ºä¸»è¡¨
-- ğŸ”¥ä¸‰è¡¨å…³è”è·å–äºšä¸“ä¸šç»„åç§°ï¼ˆé‡è¦è¡€ç¼˜å…³ç³»ï¼‰
LEFT JOIN hid0101_orcl_lis_dbo.lis_inspection_group g 
    ON s."group_id" = g."GROUP_ID"                                    -- ç¬¬ä¸€å±‚å…³è” âœ…è¡€ç¼˜ï¼šlis_inspection_sample.group_id = lis_inspection_group.GROUP_ID
    AND g."isdeleted" = '0'
LEFT JOIN hid0101_orcl_lis_xhsystem1.lis5_inspection_pgroup pg 
    ON g."INSPECTION_DEPT" = pg."PGROUP_ID"                           -- ç¬¬äºŒå±‚å…³è” âœ…è¡€ç¼˜ï¼šlis_inspection_group.INSPECTION_DEPT = lis5_inspection_pgroup.PGROUP_ID
    AND pg."isdeleted" = '0'
-- ç”³è¯·ä¿¡æ¯å…³è”ï¼ˆå¦‚éœ€è¦ï¼‰
LEFT JOIN hid0101_orcl_lis_dbo.lis_requisition_info r
    ON s."requisition_id" = r."requisition_id"                       -- æ ‡æœ¬ä¿¡æ¯å…³è”ç”³è¯·ä¿¡æ¯ âœ…è¡€ç¼˜ï¼šlis_inspection_sample.requisition_id = lis_requisition_info.requisition_id
    AND r."isdeleted" = '0'
-- åŒ»å˜±ä¿¡æ¯å…³è” âœ…è¡€ç¼˜ï¼šLIS_REQUISITION_ITEMè¡¨è·å–åŒ»å˜±ID
LEFT JOIN hid0101_orcl_lis_dbo.lis_requisition_item ri
    ON s."requisition_id" = ri."requisition_id"                      -- æ ‡æœ¬ä¿¡æ¯å…³è”åŒ»å˜±ä¿¡æ¯ âœ…è¡€ç¼˜ï¼šlis_inspection_sample.requisition_id = lis_requisition_item.requisition_id
    AND ri."isdeleted" = '0'
-- æ·»åŠ å°±è¯Šå·å…³è”ï¼ˆè¡€ç¼˜è§„åˆ™ï¼‰
LEFT JOIN hid0101_cache_his_dhcapp_sqluser.pa_adm pa
    ON s."patient_id" = pa."rowkey"
    AND pa."isdeleted" = '0'

WHERE s."isdeleted" = '0'                                             -- é€»è¾‘åˆ é™¤æ¡ä»¶ âœ…è¡€ç¼˜ï¼šæ‰€æœ‰è¡¨å¿…åŠ 
    AND s."inspection_id" IS NOT NULL;                               -- ä¸»é”®éç©ºæ¡ä»¶ âœ…è¡€ç¼˜ï¼šç¡®ä¿æ•°æ®å®Œæ•´æ€§

-- =============================================
-- è¡€ç¼˜å…³ç³»ä¿®æ­£æ€»ç»“ï¼ˆåŸºäºLISè¡€ç¼˜22æ–‡æ¡£V2.0ï¼‰
-- =============================================
-- 
-- ğŸ”¥ä¸»è¦è¡€ç¼˜å…³ç³»å˜æ›´ï¼š
-- 1. ä¸»è¡¨å˜æ›´ï¼šlis_requisition_info â†’ lis_inspection_sampleï¼ˆæ£€éªŒæ ‡æœ¬ä¿¡æ¯è¡¨ä½œä¸ºä¸»è¡¨ï¼‰
-- 2. ä¸»é”®å˜æ›´ï¼šrequisition_id â†’ inspection_idï¼ˆæ£€éªŒIDä½œä¸ºä¸»é”®ï¼‰
-- 3. æ–°å¢ä¸‰è¡¨å…³è”è·å–äºšä¸“ä¸šç»„åç§°ï¼š
--    lis_inspection_sample.group_id â†’ lis_inspection_group.GROUP_ID â†’ lis_inspection_group.INSPECTION_DEPT â†’ lis5_inspection_pgroup.PGROUP_ID â†’ lis5_inspection_pgroup.PGROUP_NAME
-- 
-- âœ…è¡€ç¼˜éªŒè¯å­—æ®µï¼š
-- - åŒ»ç–—æœºæ„ä¿¡æ¯ï¼šå…¬å…±å­—æ®µæ ‡å‡†åŒ–
-- - æ‚£è€…æ ‡è¯†ï¼špatient_idï¼ˆä½é™¢å·å…³è”ï¼‰ï¼Œoutpatient_idï¼ˆå°±è¯Šå·å…³è”ï¼‰
-- - ç”³è¯·ä¿¡æ¯ï¼šrequisition_time, patient_dept, patient_dept_name, requisition_person
-- - ç§‘å®¤ä¿¡æ¯ï¼špatient_dept, patient_dept_name, group_id, PGROUP_NAMEï¼ˆä¸‰è¡¨å…³è”ï¼‰
-- - æ ‡æœ¬ä¿¡æ¯ï¼šsample_class, sample_class_name, inspection_date
-- - äººå‘˜ä¿¡æ¯é“¾è·¯ï¼šsampling_person â†’ incept_person â†’ inspection_person â†’ check_person â†’ input_person
-- - æ—¶é—´ä¿¡æ¯é“¾è·¯ï¼šrequisition_time â†’ sampling_time â†’ incept_time â†’ check_time â†’ input_time
-- - çŠ¶æ€ä¿¡æ¯ï¼špatient_typeï¼ˆæšä¸¾å€¼ï¼‰, inspection_stateï¼ˆæšä¸¾å€¼ï¼‰, charge_typeï¼ˆé‡‘å¡åˆ¤æ–­ï¼‰
-- 
-- ğŸš¨å­—æ®µä¸å­˜åœ¨æ ‡è¯†ï¼š
-- - æŠ¥å‘Šäººå‘˜ä¿¡æ¯ï¼šissued_person, issued_time, internal_remarkï¼ˆè¡€ç¼˜æ–‡æ¡£ç¡®è®¤ä¸å­˜åœ¨ï¼‰
-- 
-- ğŸ“‹åº“åè§„èŒƒï¼š
-- - ä¸»åº“ï¼šhid0101_orcl_lis_dbo
-- - ç³»ç»Ÿå­—å…¸åº“ï¼šhid0101_orcl_lis_xhsystem1
-- 
-- =============================================


-- =============================================
-- LISå·¥ä½œé‡è®°å½•è¡¨æ•°æ®é›†æˆSQL
-- åº“å: hid0101_orcl_lis_dbo
-- å·¥ä½œé‡å†…æ¶µ: ç™»è®°æˆ–æŠ¥å‘Šæ•°ï¼ˆREG/RPTä¸¤ç§å·¥ä½œç±»å‹ï¼‰
-- æ•°æ®æº: lis_inspection_sampleï¼ˆæ£€éªŒæ ‡æœ¬ä¿¡æ¯è¡¨ï¼‰
-- =============================================

-- =============================================
-- LISå·¥ä½œé‡è®°å½•è¡¨æ•°æ®é›†æˆSQL - åŸºäºLISè¡€ç¼˜22 V3.0ä¿®æ­£ç‰ˆæœ¬
-- ä¸»è¡¨ï¼šlis_inspection_sample (æ£€éªŒæ ‡æœ¬ä¿¡æ¯è¡¨)
-- è¡€ç¼˜ä¾æ®ï¼šLISè¡€ç¼˜22æ–‡æ¡£V3.0 ç”µå­ç—…å†è¯„çº§SQLè¡€ç¼˜éªŒè¯ç‰ˆ
-- =============================================

-- ç™»è®°å·¥ä½œé‡è®°å½• âœ…è¡€ç¼˜éªŒè¯ç‰ˆæœ¬

create view datacenter_db.dwd_lis_work_record as
SELECT
    -- åŸºç¡€æ ‡è¯†ä¿¡æ¯ ğŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    cast('HID0101' as varchar(65535)) as "LIS_Work_Record_MedOrgCode",        -- åŒ»ç–—æœºæ„ä»£ç  ğŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    cast('å››å·å¤§å­¦åè¥¿åŒ»é™¢' as varchar(65535)) as "LIS_Work_Record_MedOrgName",   -- åŒ»ç–—æœºæ„åç§° ğŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    
    -- å·¥ä½œè®°å½•æ ¸å¿ƒä¿¡æ¯ âœ…è¡€ç¼˜ï¼šlis_inspection_sample
    CAST(CONCAT(s."inspection_id", '_REG') AS VARCHAR(65535)) as "LIS_Work_Record_WorkID",      -- å·¥ä½œè®°å½•ID âœ…è¡€ç¼˜ï¼šlis_inspection_sample.inspection_idæ„é€ 
    CAST(COALESCE(s."inspection_id", '') AS VARCHAR(65535)) as "LIS_Work_Record_SampleID",      -- æ ‡æœ¬ID âœ…è¡€ç¼˜ï¼šlis_inspection_sample.inspection_id
    CAST('REG' AS VARCHAR(65535)) as "LIS_Work_Record_WorkTypeID",                              -- å·¥ä½œç±»å‹ID âœ…å›ºå®šå€¼
    CAST('REG' AS VARCHAR(65535)) as "LIS_Work_Record_WorkTypeCode",                            -- å·¥ä½œç±»å‹ä»£ç  âœ…å›ºå®šå€¼
    CAST('ç™»è®°' AS VARCHAR(65535)) as "LIS_Work_Record_WorkTypeName",                           -- å·¥ä½œç±»å‹åç§° âœ…å›ºå®šå€¼
    1 as "LIS_Work_Record_WorkCount",                                   -- å·¥ä½œé‡è®¡æ•° âœ…å›ºå®šå€¼
    
    -- ç§‘å®¤ä¿¡æ¯ âœ…è¡€ç¼˜ï¼šlis_inspection_sampleï¼ˆè¡€ç¼˜éªŒè¯å­˜åœ¨ï¼‰
    CAST(COALESCE(s."patient_dept", '') AS VARCHAR(65535)) as "LIS_Work_Record_DeptID",                       -- ç§‘å®¤ID âœ…è¡€ç¼˜ï¼šlis_inspection_sample.patient_dept
    CAST(COALESCE(s."patient_dept", '') AS VARCHAR(65535)) as "LIS_Work_Record_DeptCode",                     -- ç§‘å®¤ä»£ç  âœ…è¡€ç¼˜ï¼šlis_inspection_sample.patient_dept
    CAST(COALESCE(s."patient_dept_name", '') AS VARCHAR(65535)) as "LIS_Work_Record_DeptName",                -- ç§‘å®¤åç§° âœ…è¡€ç¼˜ï¼šlis_inspection_sample.patient_dept_name
    CAST(COALESCE(s."group_id", '') AS VARCHAR(65535)) as "LIS_Work_Record_ProfGroupID",                      -- äºšä¸“ä¸šç»„ID âœ…è¡€ç¼˜ï¼šlis_inspection_sample.group_id
    CAST(COALESCE(s."group_id", '') AS VARCHAR(65535)) as "LIS_Work_Record_ProfGroupCode",                    -- äºšä¸“ä¸šç»„ä»£ç  âœ…è¡€ç¼˜ï¼šlis_inspection_sample.group_id
    
    -- ğŸ”¥äºšä¸“ä¸šç»„åç§°é€šè¿‡ä¸‰è¡¨å…³è”è·å–ï¼ˆé‡è¦è¡€ç¼˜å…³ç³» - LISè¡€ç¼˜22 V3.0éªŒè¯ï¼‰
    CAST(COALESCE(pg1."PGROUP_NAME", 'å…¶ä»–ä¸“ä¸šç»„') AS VARCHAR(65535)) as "LIS_Work_Record_ProfGroupName", -- äºšä¸“ä¸šç»„åç§° âœ…è¡€ç¼˜ï¼šä¸‰è¡¨å…³è” s.group_idâ†’g.GROUP_IDâ†’g.INSPECTION_DEPTâ†’pg.PGROUP_IDâ†’pg.PGROUP_NAME
    
    -- æ“ä½œäººå‘˜ä¿¡æ¯ï¼ˆç™»è®°äººå‘˜ï¼‰âœ…è¡€ç¼˜ï¼šlis_inspection_sample
    CAST(COALESCE(s."input_person", '') AS VARCHAR(65535)) as "LIS_Work_Record_OperatorID",                   -- æ“ä½œäººå‘˜ID âœ…è¡€ç¼˜ï¼šlis_inspection_sample.input_person
    CAST(COALESCE(s."input_person", '') AS VARCHAR(65535)) as "LIS_Work_Record_OperatorCode",                 -- æ“ä½œäººå‘˜ä»£ç  âœ…è¡€ç¼˜ï¼šlis_inspection_sample.input_person
    CAST(COALESCE(s."input_person", '') AS VARCHAR(65535)) as "LIS_Work_Record_OperatorName",                 -- æ“ä½œäººå‘˜å§“å âœ…è¡€ç¼˜ï¼šlis_inspection_sample.input_person
    
    -- æ—¶é—´ä¿¡æ¯ï¼ˆç™»è®°æ—¶é—´ï¼‰âœ…è¡€ç¼˜ï¼šlis_inspection_sample
    CAST(SUBSTRING(s."input_time", 1, 10) AS VARCHAR(65535)) as "LIS_Work_Record_WorkDate",     -- å·¥ä½œæ—¥æœŸ âœ…è¡€ç¼˜ï¼šlis_inspection_sample.input_timeæå–
    CAST(COALESCE(s."input_time", '') AS VARCHAR(65535)) as "LIS_Work_Record_WorkDtTm",                       -- å·¥ä½œæ—¶é—´ âœ…è¡€ç¼˜ï¼šlis_inspection_sample.input_time
    
    -- æ ‡å‡†æ‰©å±•å­—æ®µ âœ…è¡€ç¼˜ï¼šlis_inspection_sample
    s."requisition_id" as "LIS_Work_Record_ExtStr1",                    -- æ‰©å±•1(ç”³è¯·å•ID) âœ…è¡€ç¼˜ï¼šlis_inspection_sample.requisition_id
    s."patient_type" as "LIS_Work_Record_ExtStr2",                      -- æ‰©å±•2(æ‚£è€…ç±»å‹) âœ…è¡€ç¼˜ï¼šlis_inspection_sample.patient_type
    s."inspection_date" as "LIS_Work_Record_ExtStr3",                   -- æ‰©å±•3(æ£€éªŒæ—¥æœŸ) âœ…è¡€ç¼˜ï¼šlis_inspection_sample.inspection_date
    '' as "LIS_Work_Record_ExtStr4",                                    -- æ‰©å±•4 ğŸš¨å­—æ®µä¸å­˜åœ¨
    '' as "LIS_Work_Record_ExtStr5",                                    -- æ‰©å±•5 ğŸš¨å­—æ®µä¸å­˜åœ¨
    '' as "LIS_Work_Record_ExtStr6",                                    -- æ‰©å±•6 ğŸš¨å­—æ®µä¸å­˜åœ¨
    COALESCE(CAST(s."workload" AS DOUBLE), 1) as "LIS_Work_Record_ExtNum1", -- æ‰©å±•7(å·¥ä½œé‡) âœ…è¡€ç¼˜ï¼šlis_inspection_sample.workloadï¼ˆæ–°å‘ç°å­—æ®µï¼‰
    1 as "LIS_Work_Record_ExtNum2",                                     -- æ‰©å±•8 ğŸš¨å­—æ®µä¸å­˜åœ¨ï¼Œå›ºå®šå€¼1
    s."sampling_time" as "LIS_Work_Record_ExtDate1",                    -- æ‰©å±•9(é‡‡æ ·æ—¶é—´) âœ…è¡€ç¼˜ï¼šlis_inspection_sample.sampling_time
    CAST(NULL AS TIMESTAMP) as "LIS_Work_Record_ExtDate2",              -- æ‰©å±•10 ğŸš¨å­—æ®µä¸å­˜åœ¨
    
    -- æ•°æ®ç®¡ç†å­—æ®µ ğŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    cast('8' as varchar) as "LIS_Work_Record_DataSourceFlag",          -- æ•°æ®æ¥æºæ ‡è¯† ğŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    cast('hid0101_orcl_lis_dbo.lis_inspection_sample' as varchar) as "LIS_Work_Record_DSTable", -- æ¥å…¥æ•°æ®æºçš„è¡¨ ğŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    cast('inspection_id' as varchar) as "LIS_Work_Record_DSTableKey",   -- æ¥å…¥æ•°æ®æºçš„key ğŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    cast(s."inspection_id" as varchar) as "LIS_Work_Record_DSTableValue", -- æ¥å…¥æ•°æ®æºçš„keyå€¼ ğŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    cast('0' as varchar) as "LIS_Work_Record_IsDeleted",               -- æ•°æ®ç‰©ç†åˆ é™¤æ ‡è¯† ğŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    CAST(current_timestamp AS VARCHAR(19)) as "LIS_Work_Record_LastUpdateDtTm", -- æœ€åæ›´æ–°æ—¶é—´ ğŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    CAST(current_timestamp AS VARCHAR(19)) as "LIS_Work_Record_DataCreateDtTm"  -- æ•°æ®åˆ›å»ºæ—¶é—´ ğŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–

-- ğŸ”¥è¡€ç¼˜å…³ç³»ï¼šåŸºäºLISè¡€ç¼˜22æ–‡æ¡£V3.0çš„è¡¨å…³è”
FROM hid0101_orcl_lis_dbo.lis_inspection_sample s                       -- ä¸»è¡¨ï¼šæ£€éªŒæ ‡æœ¬ä¿¡æ¯è¡¨ âœ…è¡€ç¼˜ï¼šlis_inspection_sampleä½œä¸ºä¸»è¡¨
-- ğŸ”¥ä¸‰è¡¨å…³è”è·å–äºšä¸“ä¸šç»„åç§°ï¼ˆé‡è¦è¡€ç¼˜å…³ç³» - LISè¡€ç¼˜22 V3.0éªŒè¯ï¼‰
LEFT JOIN hid0101_orcl_lis_dbo.lis_inspection_group g1 
    ON s."group_id" = g1."GROUP_ID"                                     -- ç¬¬ä¸€å±‚å…³è” âœ…è¡€ç¼˜ï¼šlis_inspection_sample.group_id = lis_inspection_group.GROUP_ID
    AND g1."isdeleted" = '0'
LEFT JOIN hid0101_orcl_lis_xhsystem1.lis5_inspection_pgroup pg1 
    ON g1."INSPECTION_DEPT" = pg1."PGROUP_ID"                           -- ç¬¬äºŒå±‚å…³è” âœ…è¡€ç¼˜ï¼šlis_inspection_group.INSPECTION_DEPT = lis5_inspection_pgroup.PGROUP_ID
    AND pg1."isdeleted" = '0'
WHERE s."isdeleted" = '0'                                               -- é€»è¾‘åˆ é™¤æ¡ä»¶ âœ…è¡€ç¼˜ï¼šæ‰€æœ‰è¡¨å¿…åŠ 
  AND s."input_time" IS NOT NULL                                        -- ç™»è®°æ—¶é—´éç©º âœ…è¡€ç¼˜ï¼šç¡®ä¿ç™»è®°å·¥ä½œé‡æ•°æ®å®Œæ•´æ€§
  AND s."input_person" IS NOT NULL                                      -- ç™»è®°äººå‘˜éç©º âœ…è¡€ç¼˜ï¼šç¡®ä¿ç™»è®°å·¥ä½œé‡æ•°æ®å®Œæ•´æ€§

UNION ALL

-- æŠ¥å‘Šå·¥ä½œé‡è®°å½• âœ…è¡€ç¼˜éªŒè¯ç‰ˆæœ¬
SELECT
    -- åŸºç¡€æ ‡è¯†ä¿¡æ¯ ğŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    cast('HID0101' as varchar) as "LIS_Work_Record_MedOrgCode",        -- åŒ»ç–—æœºæ„ä»£ç  ğŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    cast('å››å·å¤§å­¦åè¥¿åŒ»é™¢' as varchar) as "LIS_Work_Record_MedOrgName",   -- åŒ»ç–—æœºæ„åç§° ğŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–ï¼ˆä¿®æ­£åŒ»ç–—æœºæ„åç§°ï¼‰
    
    -- å·¥ä½œè®°å½•æ ¸å¿ƒä¿¡æ¯ âœ…è¡€ç¼˜ï¼šlis_inspection_sample
    CONCAT(s."inspection_id", '_RPT') as "LIS_Work_Record_WorkID",      -- å·¥ä½œè®°å½•ID âœ…è¡€ç¼˜ï¼šlis_inspection_sample.inspection_idæ„é€ 
    s."inspection_id" as "LIS_Work_Record_SampleID",                    -- æ ‡æœ¬ID âœ…è¡€ç¼˜ï¼šlis_inspection_sample.inspection_id
    'RPT' as "LIS_Work_Record_WorkTypeID",                              -- å·¥ä½œç±»å‹ID âœ…å›ºå®šå€¼
    'RPT' as "LIS_Work_Record_WorkTypeCode",                            -- å·¥ä½œç±»å‹ä»£ç  âœ…å›ºå®šå€¼
    'æŠ¥å‘Š' as "LIS_Work_Record_WorkTypeName",                           -- å·¥ä½œç±»å‹åç§° âœ…å›ºå®šå€¼
    1 as "LIS_Work_Record_WorkCount",                                   -- å·¥ä½œé‡è®¡æ•° âœ…å›ºå®šå€¼
    
    -- ç§‘å®¤ä¿¡æ¯ âœ…è¡€ç¼˜ï¼šlis_inspection_sampleï¼ˆè¡€ç¼˜éªŒè¯å­˜åœ¨ï¼‰
    s."patient_dept" as "LIS_Work_Record_DeptID",                       -- ç§‘å®¤ID âœ…è¡€ç¼˜ï¼šlis_inspection_sample.patient_dept
    s."patient_dept" as "LIS_Work_Record_DeptCode",                     -- ç§‘å®¤ä»£ç  âœ…è¡€ç¼˜ï¼šlis_inspection_sample.patient_dept
    s."patient_dept_name" as "LIS_Work_Record_DeptName",                -- ç§‘å®¤åç§° âœ…è¡€ç¼˜ï¼šlis_inspection_sample.patient_dept_name
    s."group_id" as "LIS_Work_Record_ProfGroupID",                      -- äºšä¸“ä¸šç»„ID âœ…è¡€ç¼˜ï¼šlis_inspection_sample.group_id
    s."group_id" as "LIS_Work_Record_ProfGroupCode",                    -- äºšä¸“ä¸šç»„ä»£ç  âœ…è¡€ç¼˜ï¼šlis_inspection_sample.group_id
    
    -- ğŸ”¥äºšä¸“ä¸šç»„åç§°é€šè¿‡ä¸‰è¡¨å…³è”è·å–ï¼ˆé‡è¦è¡€ç¼˜å…³ç³» - LISè¡€ç¼˜22 V3.0éªŒè¯ï¼‰
    COALESCE(pg2."PGROUP_NAME", 'å…¶ä»–ä¸“ä¸šç»„') as "LIS_Work_Record_ProfGroupName", -- äºšä¸“ä¸šç»„åç§° âœ…è¡€ç¼˜ï¼šä¸‰è¡¨å…³è” s.group_idâ†’g.GROUP_IDâ†’g.INSPECTION_DEPTâ†’pg.PGROUP_IDâ†’pg.PGROUP_NAME
    
    -- æ“ä½œäººå‘˜ä¿¡æ¯ï¼ˆæŠ¥å‘Šäººå‘˜=å®¡æ ¸äººå‘˜ï¼‰âœ…è¡€ç¼˜ï¼šlis_inspection_sample
    s."check_person" as "LIS_Work_Record_OperatorID",                   -- æ“ä½œäººå‘˜ID âœ…è¡€ç¼˜ï¼šlis_inspection_sample.check_person
    s."check_person" as "LIS_Work_Record_OperatorCode",                 -- æ“ä½œäººå‘˜ä»£ç  âœ…è¡€ç¼˜ï¼šlis_inspection_sample.check_person
    s."check_person" as "LIS_Work_Record_OperatorName",                 -- æ“ä½œäººå‘˜å§“å âœ…è¡€ç¼˜ï¼šlis_inspection_sample.check_person
    
    -- æ—¶é—´ä¿¡æ¯ï¼ˆæŠ¥å‘Šæ—¶é—´=å®¡æ ¸æ—¶é—´ï¼‰âœ…è¡€ç¼˜ï¼šlis_inspection_sample
    SUBSTRING(s."check_time", 1, 10) as "LIS_Work_Record_WorkDate",     -- å·¥ä½œæ—¥æœŸ âœ…è¡€ç¼˜ï¼šlis_inspection_sample.check_timeæå–
    s."check_time" as "LIS_Work_Record_WorkDtTm",                       -- å·¥ä½œæ—¶é—´ âœ…è¡€ç¼˜ï¼šlis_inspection_sample.check_time
    
    -- æ ‡å‡†æ‰©å±•å­—æ®µ âœ…è¡€ç¼˜ï¼šlis_inspection_sample
    s."requisition_id" as "LIS_Work_Record_ExtStr1",                    -- æ‰©å±•1(ç”³è¯·å•ID) âœ…è¡€ç¼˜ï¼šlis_inspection_sample.requisition_id
    s."patient_type" as "LIS_Work_Record_ExtStr2",                      -- æ‰©å±•2(æ‚£è€…ç±»å‹) âœ…è¡€ç¼˜ï¼šlis_inspection_sample.patient_type
    s."inspection_date" as "LIS_Work_Record_ExtStr3",                   -- æ‰©å±•3(æ£€éªŒæ—¥æœŸ) âœ…è¡€ç¼˜ï¼šlis_inspection_sample.inspection_date
    '' as "LIS_Work_Record_ExtStr4",                                    -- æ‰©å±•4 ğŸš¨å­—æ®µä¸å­˜åœ¨
    '' as "LIS_Work_Record_ExtStr5",                                    -- æ‰©å±•5 ğŸš¨å­—æ®µä¸å­˜åœ¨
    '' as "LIS_Work_Record_ExtStr6",                                    -- æ‰©å±•6 ğŸš¨å­—æ®µä¸å­˜åœ¨
    COALESCE(CAST(s."workload" AS DOUBLE), 1) as "LIS_Work_Record_ExtNum1", -- æ‰©å±•7(å·¥ä½œé‡) âœ…è¡€ç¼˜ï¼šlis_inspection_sample.workloadï¼ˆæ–°å‘ç°å­—æ®µï¼‰
    1 as "LIS_Work_Record_ExtNum2",                                     -- æ‰©å±•8 ğŸš¨å­—æ®µä¸å­˜åœ¨ï¼Œå›ºå®šå€¼1
    s."sampling_time" as "LIS_Work_Record_ExtDate1",                    -- æ‰©å±•9(é‡‡æ ·æ—¶é—´) âœ…è¡€ç¼˜ï¼šlis_inspection_sample.sampling_time
    CAST(NULL AS TIMESTAMP) as "LIS_Work_Record_ExtDate2",              -- æ‰©å±•10 ğŸš¨å­—æ®µä¸å­˜åœ¨
    
    -- æ•°æ®ç®¡ç†å­—æ®µ ğŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    cast('8' as varchar) as "LIS_Work_Record_DataSourceFlag",          -- æ•°æ®æ¥æºæ ‡è¯† ğŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    cast('hid0101_orcl_lis_dbo.lis_inspection_sample' as varchar) as "LIS_Work_Record_DSTable", -- æ¥å…¥æ•°æ®æºçš„è¡¨ ğŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    cast('inspection_id' as varchar) as "LIS_Work_Record_DSTableKey",   -- æ¥å…¥æ•°æ®æºçš„key ğŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    cast(s."inspection_id" as varchar) as "LIS_Work_Record_DSTableValue", -- æ¥å…¥æ•°æ®æºçš„keyå€¼ ğŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    cast('0' as varchar) as "LIS_Work_Record_IsDeleted",               -- æ•°æ®ç‰©ç†åˆ é™¤æ ‡è¯† ğŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    CAST(current_timestamp AS VARCHAR(19)) as "LIS_Work_Record_LastUpdateDtTm", -- æœ€åæ›´æ–°æ—¶é—´ ğŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    CAST(current_timestamp AS VARCHAR(19)) as "LIS_Work_Record_DataCreateDtTm"  -- æ•°æ®åˆ›å»ºæ—¶é—´ ğŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–

-- ğŸ”¥è¡€ç¼˜å…³ç³»ï¼šåŸºäºLISè¡€ç¼˜22æ–‡æ¡£V3.0çš„è¡¨å…³è”
FROM hid0101_orcl_lis_dbo.lis_inspection_sample s                       -- ä¸»è¡¨ï¼šæ£€éªŒæ ‡æœ¬ä¿¡æ¯è¡¨ âœ…è¡€ç¼˜ï¼šlis_inspection_sampleä½œä¸ºä¸»è¡¨
-- ğŸ”¥ä¸‰è¡¨å…³è”è·å–äºšä¸“ä¸šç»„åç§°ï¼ˆé‡è¦è¡€ç¼˜å…³ç³» - LISè¡€ç¼˜22 V3.0éªŒè¯ï¼‰
LEFT JOIN hid0101_orcl_lis_dbo.lis_inspection_group g2 
    ON s."group_id" = g2."GROUP_ID"                                     -- ç¬¬ä¸€å±‚å…³è” âœ…è¡€ç¼˜ï¼šlis_inspection_sample.group_id = lis_inspection_group.GROUP_ID
    AND g2."isdeleted" = '0'
LEFT JOIN hid0101_orcl_lis_xhsystem1.lis5_inspection_pgroup pg2 
    ON g2."INSPECTION_DEPT" = pg2."PGROUP_ID"                           -- ç¬¬äºŒå±‚å…³è” âœ…è¡€ç¼˜ï¼šlis_inspection_group.INSPECTION_DEPT = lis5_inspection_pgroup.PGROUP_ID
    AND pg2."isdeleted" = '0'
WHERE s."isdeleted" = '0'                                               -- é€»è¾‘åˆ é™¤æ¡ä»¶ âœ…è¡€ç¼˜ï¼šæ‰€æœ‰è¡¨å¿…åŠ 
  AND s."check_time" IS NOT NULL                                        -- å®¡æ ¸æ—¶é—´éç©º âœ…è¡€ç¼˜ï¼šç¡®ä¿æŠ¥å‘Šå·¥ä½œé‡æ•°æ®å®Œæ•´æ€§
  AND s."check_person" IS NOT NULL;                                     -- å®¡æ ¸äººå‘˜éç©º âœ…è¡€ç¼˜ï¼šç¡®ä¿æŠ¥å‘Šå·¥ä½œé‡æ•°æ®å®Œæ•´æ€§

-- =============================================
-- è¡€ç¼˜å…³ç³»ä¿®æ­£æ€»ç»“ï¼ˆåŸºäºLISè¡€ç¼˜22æ–‡æ¡£V3.0ï¼‰
-- =============================================
-- 
-- ğŸ”¥ä¸»è¦è¡€ç¼˜å…³ç³»ä¿®æ­£ï¼š
-- 1. å­—æ®µåè§„èŒƒï¼šæ‰€æœ‰å­—æ®µåç»Ÿä¸€ä½¿ç”¨å°å†™åŠ åŒå¼•å·æ ¼å¼ (å¦‚ï¼šinspection_idè€ŒéINSPECTION_ID)
-- 2. åŒ»ç–—æœºæ„åç§°ç»Ÿä¸€ï¼šä¿®æ­£ä¸º"å››å·å¤§å­¦åè¥¿åŒ»é™¢"
-- 3. å·¥ä½œé‡å­—æ®µåˆ©ç”¨ï¼šåˆ©ç”¨æ–°å‘ç°çš„workloadå­—æ®µä½œä¸ºExtNum1ï¼ˆåŸå›ºå®šå€¼1æ”¹ä¸ºå®é™…å·¥ä½œé‡å€¼ï¼‰
-- 4. ä¸‰è¡¨å…³è”éªŒè¯ï¼šäºšä¸“ä¸šç»„åç§°è·å–æ–¹å¼ä¸è¡€ç¼˜æ–‡æ¡£å®Œå…¨ä¸€è‡´
-- 
-- âœ…è¡€ç¼˜éªŒè¯å­—æ®µå®Œæ•´æ˜ å°„ï¼š
-- - æ ¸å¿ƒæ ‡è¯†ï¼šinspection_idï¼ˆæ ‡æœ¬IDä½œä¸ºä¸»é”®ï¼‰
-- - ç§‘å®¤ä¿¡æ¯ï¼špatient_dept, patient_dept_name, group_id, PGROUP_NAMEï¼ˆä¸‰è¡¨å…³è”ï¼‰
-- - äººå‘˜ä¿¡æ¯ï¼šinput_personï¼ˆç™»è®°ï¼‰, check_personï¼ˆæŠ¥å‘Š=å®¡æ ¸ï¼‰
-- - æ—¶é—´ä¿¡æ¯ï¼šinput_timeï¼ˆç™»è®°ï¼‰, check_timeï¼ˆæŠ¥å‘Š=å®¡æ ¸ï¼‰
-- - æ‰©å±•ä¿¡æ¯ï¼šrequisition_id, patient_type, inspection_date, sampling_time
-- - æ–°å‘ç°å­—æ®µï¼šworkloadï¼ˆå·¥ä½œé‡ç»Ÿè®¡å€¼ï¼‰
-- 
-- ğŸ“‹åº“åè§„èŒƒï¼ˆLISè¡€ç¼˜22 V3.0ç¡®è®¤ï¼‰ï¼š
-- - ä¸»åº“ï¼šhid0101_orcl_lis_dboï¼ˆæ£€éªŒæ ‡æœ¬ä¿¡æ¯è¡¨ï¼‰
-- - ç³»ç»Ÿå­—å…¸åº“ï¼šhid0101_orcl_lis_xhsystem1ï¼ˆäºšä¸“ä¸šç»„è¡¨ï¼‰
-- 
-- =============================================
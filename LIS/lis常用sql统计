-- =============================================
-- LIS äºšä¸“ä¸šç»„å·¥ä½œé‡ç»Ÿè®¡æŸ¥è¯¢
-- åŠŸèƒ½ï¼šæŒ‰äºšä¸“ä¸šç»„ç»Ÿè®¡æ£€éªŒæ•°é‡ã€æ”¶è´¹é‡‘é¢ã€å·¥ä½œé‡
-- æ—¶é—´èŒƒå›´ï¼š2025å¹´7æœˆ1æ—¥-11æ—¥
-- æ•°æ®æ¥æºï¼šLIS_INSPECTION_SAMPLE (æ£€éªŒæ ‡æœ¬ä¿¡æ¯è¡¨)
-- =============================================

-- è¯´æ˜Žï¼šå·²å°†NVLå‡½æ•°æ”¹ä¸ºPrestoçš„COALESCEå‡½æ•°ï¼Œä¸”æ‰€æœ‰è¡¨å‡åŠ ä¸Šisdeleted='0'çš„é€»è¾‘åˆ é™¤æ¡ä»¶
-- hid0101_orcl_lis_dboåº“åæœªæ¶‰åŠæ‰‹æœ¯éº»é†‰ï¼Œæ— éœ€æ›¿æ¢
-- å­—æ®µå‡ä¸ºvarcharç±»åž‹ï¼Œé‡‘é¢ä¸Žå·¥ä½œé‡å­—æ®µå¦‚ä¸ºæ•°å€¼è¯·ç¡®ä¿æ•°æ®æºä¸ºæ•°å€¼å­—ç¬¦ä¸²ï¼Œå¦åˆ™ç»Ÿè®¡ä¼šæœ‰é—®é¢˜
-- æ£€æŸ¥å­—æ®µæ¥æºï¼šSAMPLE_CHARGEã€WORKLOADã€PGROUP_NAMEå‡å­˜åœ¨äºŽå¯¹åº”è¡¨

SELECT 
    C."PGROUP_NAME" AS "äºšä¸“ä¸šç»„åç§°",                                 -- æ¥æºï¼šlis5_inspection_pgroup.PGROUP_NAME
    COUNT(A."INSPECTION_ID") AS "æ£€éªŒå•æ•°é‡",                         -- æ¥æºï¼šlis_inspection_sample.INSPECTION_ID
    SUM(COALESCE(CAST(A."SAMPLE_CHARGE" AS DOUBLE), 0)) AS "æ ‡æœ¬æ”¶è´¹æ€»é‡‘é¢", -- æ¥æºï¼šlis_inspection_sample.SAMPLE_CHARGE
    SUM(COALESCE(CAST(A."WORKLOAD" AS DOUBLE), 0)) AS "å·¥ä½œé‡æ€»è®¡"         -- æ¥æºï¼šlis_inspection_sample.WORKLOAD
FROM hid0101_orcl_lis_dbo.lis_inspection_sample A
LEFT JOIN hid0101_orcl_lis_dbo.lis_inspection_group B
    ON A."GROUP_ID" = B."GROUP_ID" AND B."isdeleted" = '0'
LEFT JOIN hid0101_orcl_lis_xhsystem1.lis5_inspection_pgroup C
    ON B."INSPECTION_DEPT" = C."PGROUP_ID" AND C."isdeleted" = '0'
WHERE 
    A."isdeleted" = '0'
    AND A."CHECK_TIME" IS NOT NULL
    AND A."INSPECTION_DATE" >= '20250701'
    AND A."INSPECTION_DATE" <= '20250711'
GROUP BY 
    C."PGROUP_NAME";




-- =============================================
-- LISæ ‡æœ¬ä¸»è¡¨æ•°æ®é›†æˆSQL - åŸºäºŽè¡€ç¼˜å…³ç³»ä¿®æ­£ç‰ˆæœ¬
-- åº“å: hid0101_orcl_lis_dbo
-- æºè¡¨: lis_inspection_sample
-- å­—æ®µå­˜åœ¨æ€§å·²éªŒè¯ï¼Œä¸å­˜åœ¨å­—æ®µç”¨ç©ºå­—ç¬¦ä¸²æ›¿ä»£
-- =============================================
SELECT
    cast('HID0101' as varchar) as "LIS_Sample_Main_MedOrgCode",        -- åŒ»ç–—æœºæž„ä»£ç  ðŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    cast('å››å·å¤§å­¦åŽè¥¿åŒ»é™¢' as varchar) as "LIS_Sample_Main_MedOrgName", -- åŒ»ç–—æœºæž„åç§° ðŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    cast(null as varchar) as "LIS_Sample_Main_EmpiID",                 -- äººå‘˜å”¯ä¸€æ ‡è¯†ID ðŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    cast(null as varchar) as "LIS_Sample_Main_EmpiNo",                 -- äººå‘˜å”¯ä¸€å· ðŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    s."inspection_id" as "LIS_Sample_Main_SampleID",                   -- æ ‡æœ¬ID(æ¡ç å·) âœ…å­˜åœ¨
    s."inspection_date" as "LIS_Sample_Main_InspectionDate",           -- æ£€éªŒæ—¥æœŸ(YYYYMMDD) âœ…å­˜åœ¨
    s."patient_id" as "LIS_Sample_Main_PersID",                        -- ç—…äººID âœ…å­˜åœ¨ï¼Œå°±æ˜¯ä½é™¢å·å…³è”åˆ°ç—…äººä¿¡æ¯
    s."outpatient_id" as "LIS_Sample_Main_VisitID",                   -- å°±è¯ŠIDÂ  âœ…å­˜åœ¨ å°±æ˜¯å°±è¯Šå·å…³è”åˆ°å°±è¯ŠÂ 
    CASE s."patient_type"
        WHEN '1' THEN 'é—¨è¯Š'
        WHEN '2' THEN 'ä½é™¢'
        WHEN '3' THEN 'æ€¥è¯Š'
        WHEN '4' THEN 'ä½“æ£€'
        ELSE 'å…¶ä»–'
    END as "LIS_Sample_Main_VisitTypeName",                            -- å°±è¯Šç±»åž‹åç§° âœ…å­˜åœ¨
    s."patient_dept" as "LIS_Sample_Main_DeptID",                     -- ç”³è¯·ç§‘å®¤ID âœ…å­˜åœ¨
    s."patient_dept_name" as "LIS_Sample_Main_DeptName",              -- ç”³è¯·ç§‘å®¤åç§° âœ…å­˜åœ¨
    s."group_id" as "LIS_Sample_Main_ProfGroupCode",                  -- äºšä¸“ä¸šç»„ä»£ç  âœ…å­˜åœ¨
    -- äºšä¸“ä¸šç»„åç§°é€šè¿‡è¡¨å…³è”èŽ·å–(ä¿®æ­£ä¸ºæ­£ç¡®çš„å®žçŽ°æ–¹å¼)
    COALESCE(pg."PGROUP_NAME", 'å…¶ä»–') as "LIS_Sample_Main_ProfGroupName", -- äºšä¸“ä¸šç»„åç§° âœ…é€šè¿‡è¡¨å…³è”èŽ·å–
    s."sample_class" as "LIS_Sample_Main_SampleTypeID",               -- æ ‡æœ¬ç±»åž‹ID âœ…å­˜åœ¨
    s."sample_class" as "LIS_Sample_Main_SampleTypeCode",             -- æ ‡æœ¬ç±»åž‹ä»£ç  âœ…å­˜åœ¨
    s."sample_class_name" as "LIS_Sample_Main_SampleTypeName",        -- æ ‡æœ¬ç±»åž‹åç§° âœ…å­˜åœ¨
    s."requisition_time" as "LIS_Sample_Main_RequisitionDtTm",        -- ç”³è¯·æ—¶é—´ âœ…å­˜åœ¨
    -- é‡‡é›†äººå‘˜ä¿¡æ¯ âœ…è¡€ç¼˜éªŒè¯é€šè¿‡
    s."sampling_person" as "LIS_Sample_Main_SamplingPersName",        -- é‡‡é›†äººå‘˜å§“å âœ…å­˜åœ¨
    s."sampling_time" as "LIS_Sample_Main_SamplingDtTm",              -- é‡‡é›†æ—¶é—´ âœ…å­˜åœ¨
    s."test_order_name" as "LIS_Sample_Main_SamplingContent",         -- é‡‡é›†å†…å®¹(æ£€éªŒç›®çš„) âœ…å­˜åœ¨
    -- æŽ¥æ”¶äººå‘˜ä¿¡æ¯ âœ…è¡€ç¼˜éªŒè¯é€šè¿‡
    s."incept_person" as "LIS_Sample_Main_ReceivePersName",           -- æŽ¥æ”¶äººå‘˜å§“å âœ…å­˜åœ¨
    s."incept_time" as "LIS_Sample_Main_ReceiveDtTm",                 -- æŽ¥æ”¶æ—¶é—´ âœ…å­˜åœ¨
    -- æ£€éªŒäººå‘˜ä¿¡æ¯ âœ…è¡€ç¼˜éªŒè¯é€šè¿‡
    s."inspection_person" as "LIS_Sample_Main_InspectionPersName",    -- æ£€éªŒäººå‘˜å§“å âœ…å­˜åœ¨
    -- âŒæŠ¥å‘Šäººå‘˜ä¿¡æ¯ - å­—æ®µä¸å­˜åœ¨ï¼Œä½¿ç”¨ç©ºå­—ç¬¦ä¸²æ›¿ä»£
    '' as "LIS_Sample_Main_ReportPersName",                          -- æŠ¥å‘Šäººå‘˜å§“å ðŸš¨å­—æ®µä¸å­˜åœ¨: issued_person
    CAST(NULL AS TIMESTAMP) as "LIS_Sample_Main_ReportDtTm",          -- æŠ¥å‘Šæ—¶é—´ ðŸš¨å­—æ®µä¸å­˜åœ¨: issued_time
    '' as "LIS_Sample_Main_ReportContent",                           -- æŠ¥å‘Šå†…å®¹ ðŸš¨å­—æ®µä¸å­˜åœ¨: Internal_remark
    -- å®¡æ ¸äººå‘˜ä¿¡æ¯ âœ…è¡€ç¼˜éªŒè¯é€šè¿‡
    s."check_person" as "LIS_Sample_Main_CheckPersName",              -- å®¡æ ¸äººå‘˜å§“å âœ…å­˜åœ¨
    s."check_time" as "LIS_Sample_Main_CheckDtTm",                    -- å®¡æ ¸æ—¶é—´ âœ…å­˜åœ¨
    s."remark" as "LIS_Sample_Main_CheckContent",                     -- å®¡æ ¸å†…å®¹(å¤‡æ³¨) âœ…å­˜åœ¨
    -- å…¶ä»–å­—æ®µ âœ…è¡€ç¼˜éªŒè¯é€šè¿‡
    CASE s."inspection_state"
        WHEN 'audited' THEN 'å·²å®¡æ ¸'
        WHEN 'sent' THEN 'å·²å‘é€'
        WHEN 'finished' THEN 'å·²å®Œæˆ'
        WHEN 'reported' THEN 'å·²æŠ¥å‘Š'
        WHEN 'inspecting' THEN 'æ£€éªŒä¸­'
        ELSE 'æœªçŸ¥'
    END as "LIS_Sample_Main_SampleStatusName",                        -- æ ‡æœ¬çŠ¶æ€åç§° âœ…å­˜åœ¨
    CASE WHEN s."charge_type" LIKE '%é‡‘å¡%' OR s."charge_type" LIKE '%VIP%'
         THEN 'Y' ELSE 'N' END as "LIS_Sample_Main_IsGoldenCard",     -- æ˜¯å¦é‡‘å¡(Y/N) âœ…å­˜åœ¨
    s."input_person" as "LIS_Sample_Main_InputPersName",              -- ç™»è®°äººå‘˜å§“å âœ…å­˜åœ¨
    s."input_time" as "LIS_Sample_Main_InputDtTm",                    -- ç™»è®°æ—¶é—´ âœ…å­˜åœ¨
    -- æ•°æ®ç®¡ç†å­—æ®µ ðŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    cast('8' as varchar) as "LIS_Sample_Main_DataSourceFlag",        -- æ•°æ®æ¥æºæ ‡è¯† ðŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–  
    cast('hid0101_orcl_lis_dbo.lis_inspection_sample' as varchar) as "LIS_Sample_Main_DSTable", -- æ•°æ®æºè¡¨ ðŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    cast('inspection_id' as varchar) as "LIS_Sample_Main_DSTableKey", -- æ•°æ®æºè¡¨ä¸»é”® ðŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    cast(s."inspection_id" as varchar) as "LIS_Sample_Main_DSTableValue", -- æ•°æ®æºè¡¨ä¸»é”®å€¼ ðŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    cast(current_timestamp as varchar) as "LIS_Sample_Main_LastUpdateDtTm", -- æœ€åŽæ›´æ–°æ—¶é—´ ðŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–  
    cast(current_timestamp as varchar) as "LIS_Sample_Main_DataCreateDtTm"  -- æ•°æ®åˆ›å»ºæ—¶é—´ ðŸ”„å…¬å…±å­—æ®µæ ‡å‡†åŒ–
    
FROM hid0101_orcl_lis_dbo.lis_inspection_sample s
-- æ·»åŠ äºšä¸“ä¸šç»„è¡¨å…³è”(ä¿®æ­£ä¸ºæ­£ç¡®çš„å®žçŽ°æ–¹å¼)
LEFT JOIN hid0101_orcl_lis_dbo.lis_inspection_group g 
    ON s."group_id" = g."GROUP_ID" 
    AND g."isdeleted" = '0'
LEFT JOIN hid0101_orcl_lis_xhsystem1.lis5_inspection_pgroup pg 
    ON g."INSPECTION_DEPT" = pg."PGROUP_ID" 
    AND pg."isdeleted" = '0'
WHERE s."inspection_date" >= CAST(DATE_FORMAT(DATE_ADD('day', -1, NOW()), '%Y%m%d') AS VARCHAR)
    AND s."inspection_id" IS NOT NULL
    AND s."isdeleted" = '0';  






-- å®žéªŒåŒ»å­¦ç§‘å„äºšä¸“ä¸šç»„ç»Ÿè®¡ï¼ˆä¿®æ­£å·¥ä½œé‡è®¡ç®—å¹¶æŒ‰ç§‘å®¤æ±‡æ€»ï¼ŒåŒ…å«é‡‘å¡ç»Ÿè®¡ï¼‰ æŠ¥è¡¨æ ¸å¯¹å®Œæˆã€‚
WITH correct_workload AS (
    -- ä½¿ç”¨åŽŸå§‹Oracleè½¬Prestoçš„é€»è¾‘è®¡ç®—æ­£ç¡®çš„å·¥ä½œé‡ï¼ˆæ€»ä½“ï¼‰
    SELECT 
        t."GROUP_ID" as "äºšä¸“ä¸šç»„ä»£ç ",
        COUNT(DISTINCT t."inspection_id") as "æ ‡æœ¬æ•°",
        SUM(COALESCE(CAST(b."workload" AS DOUBLE), 0)) as "å·¥ä½œé‡"
    FROM hid0101_orcl_lis_dbo.lis_inspection_sample t
    INNER JOIN hid0101_orcl_lis_dbo.lis_inspection_sample_charge b
        ON t."inspection_id" = b."inspection_id"
        AND b."isdeleted" = '0'
    WHERE  t."inspection_date" BETWEEN '20240801' AND '20240831'
        AND t."isdeleted" = '0'
    GROUP BY t."GROUP_ID"
),
golden_card_workload AS (
    -- é‡‘å¡ç±»åž‹çš„å·¥ä½œé‡å’Œæ ‡æœ¬æ•°è®¡ç®—
    SELECT 
        t."GROUP_ID" as "äºšä¸“ä¸šç»„ä»£ç ",
        COUNT(DISTINCT t."inspection_id") as "é‡‘å¡æ ‡æœ¬æ•°",
        SUM(COALESCE(CAST(b."workload" AS DOUBLE), 0)) as "é‡‘å¡å·¥ä½œé‡"
    FROM hid0101_orcl_lis_dbo.lis_inspection_sample t
    INNER JOIN hid0101_orcl_lis_dbo.lis_inspection_sample_charge b
        ON t."inspection_id" = b."inspection_id"
        AND b."isdeleted" = '0'
    WHERE  t."inspection_date" BETWEEN '20240801' AND '20240831'
        AND t."isdeleted" = '0'
        AND (t."patient_type" = '9' OR t."charge_type" LIKE '%é‡‘å¡%' OR t."charge_type" LIKE '%VIP%')  -- é‡‘å¡ç±»åž‹ç­›é€‰
    GROUP BY t."GROUP_ID"
),
dc_data AS (
    -- DCè¡¨èŽ·å–ç§‘å®¤åç§°ä¿¡æ¯
    SELECT 
        m."LIS_Sample_Main_ProfGroupCode" as "äºšä¸“ä¸šç»„ä»£ç ",
        m."LIS_Sample_Main_ProfGroupName" as "ç§‘å®¤åç§°"
    FROM datacenter_db.lis_sample_main m
    WHERE m."LIS_Sample_Main_InspectionDate" >= '20240801' 
        AND m."LIS_Sample_Main_InspectionDate" <= '20240831'
        AND m."LIS_Sample_Main_IsDeleted" = '0'
       
    GROUP BY 
        m."LIS_Sample_Main_ProfGroupCode",
        m."LIS_Sample_Main_ProfGroupName"
),
group_level AS (
    -- å…³è”ä¸‰ä¸ªæ•°æ®æºï¼ŒèŽ·å–äºšä¸“ä¸šç»„çº§åˆ«æ•°æ®
    SELECT 
        cw."äºšä¸“ä¸šç»„ä»£ç ",
        dc."ç§‘å®¤åç§°",
        cw."æ ‡æœ¬æ•°",
        cw."å·¥ä½œé‡" as "é¡¹ç›®æ•°",
        COALESCE(gc."é‡‘å¡æ ‡æœ¬æ•°", 0) as "é‡‘å¡æ ‡æœ¬æ•°",
        COALESCE(gc."é‡‘å¡å·¥ä½œé‡", 0) as "é‡‘å¡é¡¹ç›®æ•°"
    FROM correct_workload cw
    LEFT JOIN dc_data dc
        ON cw."äºšä¸“ä¸šç»„ä»£ç " = dc."äºšä¸“ä¸šç»„ä»£ç "
    LEFT JOIN golden_card_workload gc
        ON cw."äºšä¸“ä¸šç»„ä»£ç " = gc."äºšä¸“ä¸šç»„ä»£ç "
)
-- æœ€ç»ˆæŒ‰ç§‘å®¤åç§°æ±‡æ€»
SELECT 
    "ç§‘å®¤åç§°",
    SUM("æ ‡æœ¬æ•°") as "æ ‡æœ¬æ•°",
    SUM("é¡¹ç›®æ•°") as "é¡¹ç›®æ•°", 
    SUM("é‡‘å¡æ ‡æœ¬æ•°") as "é‡‘å¡æ ‡æœ¬æ•°",
    SUM("é‡‘å¡é¡¹ç›®æ•°") as "é‡‘å¡é¡¹ç›®æ•°"
FROM group_level
WHERE "ç§‘å®¤åç§°" IS NOT NULL
GROUP BY "ç§‘å®¤åç§°"
ORDER BY "ç§‘å®¤åç§°", "æ ‡æœ¬æ•°" DESC;
    
# æŽ¥ä¸‹æ¥åŸºäºŽä¸Šè¾¹çš„sqlï¼ŒåŠ å…¥æ”¶å…¥è®¡ç®—ï¼Œæ”¶å…¥æ˜¯éœ€è¦å…³è”åˆ°æ”¶å…¥ä¸»é¢˜çš„ï¼Œæ”¶å…¥ä¸»é¢˜ï¼Œselect orderno,totalfee  from m1.mdr_income limit 11 å…¶ä¸­ orderno æ˜¯ datacenter_db.lis_sample_main ä¸­çš„ åŒ»å˜±id, éœ€è¦ dcä¸­è¿™ä¸ªåŒ»å˜±idåŽ»é‡åŽå…³è”è¿™ä¸ªmdr_income ç„¶åŽæ‹¿åˆ° totalfee ç„¶åŽè®¡ç®—æ€»æ”¶å…¥ï¼Œå•ä½è·Ÿä¸Šè¾¹ç§‘å®¤ä¸€è‡´


-- å®žéªŒåŒ»å­¦ç§‘å„ç§‘å®¤æ”¶å…¥ç»Ÿè®¡ï¼ˆåŸºäºŽDCè¡¨å…³è”æ”¶å…¥ä¸»é¢˜ï¼‰ï¼Œæ”¶å…¥
WITH unique_orders AS (
    -- ç¬¬ä¸€æ­¥ï¼šä»ŽDCè¡¨ä¸­æŒ‰ç§‘å®¤å’ŒåŒ»å˜±IDåŽ»é‡ï¼ŒèŽ·å–åŸºç¡€æ•°æ®
    SELECT DISTINCT
        "LIS_Sample_Main_ProfGroupName" as "ç§‘å®¤åç§°",
        "LIS_Sample_Main_HISID" as "åŒ»å˜±ID",
        "LIS_Sample_Main_IsGoldenCard" as "æ˜¯å¦é‡‘å¡",
        "LIS_Sample_Main_ProfGroupCode" as "äºšä¸“ä¸šç»„ä»£ç "
    FROM datacenter_db.lis_sample_main
    WHERE "LIS_Sample_Main_InspectionDate" >= '20240801' 
        AND "LIS_Sample_Main_InspectionDate" <= '20240831'
        AND "LIS_Sample_Main_IsDeleted" = '0'
        AND "LIS_Sample_Main_HISID" IS NOT NULL
        AND "LIS_Sample_Main_HISID" != ''
        -- ç­›é€‰ç‰¹å®šäºšä¸“ä¸šç»„
        AND "LIS_Sample_Main_ProfGroupCode" 
),
income_data AS (
    -- ç¬¬äºŒæ­¥ï¼šå…³è”æ”¶å…¥ä¸»é¢˜è¡¨èŽ·å–æ”¶å…¥æ•°æ®
    SELECT 
        u."ç§‘å®¤åç§°",
        u."æ˜¯å¦é‡‘å¡",
        COALESCE(CAST(i.totalfee AS DOUBLE), 0) as "æ”¶å…¥é‡‘é¢"
    FROM unique_orders u
    LEFT JOIN m1.mdr_income i
        ON u."åŒ»å˜±ID" = i.orderno
)
-- ç¬¬ä¸‰æ­¥ï¼šæŒ‰ç§‘å®¤æ±‡æ€»æ”¶å…¥
SELECT 
    "ç§‘å®¤åç§°",
    ROUND(SUM("æ”¶å…¥é‡‘é¢"), 2) as "æ€»æ”¶å…¥",
    ROUND(SUM(CASE WHEN "æ˜¯å¦é‡‘å¡" = 'Y' THEN "æ”¶å…¥é‡‘é¢" ELSE 0 END), 2) as "é‡‘å¡æ€»æ”¶å…¥"
FROM income_data
WHERE "ç§‘å®¤åç§°" IS NOT NULL 
    AND "ç§‘å®¤åç§°" != ''
GROUP BY "ç§‘å®¤åç§°"
ORDER BY "æ€»æ”¶å…¥" DESC

####  åˆå¹¶ç‰ˆæœ¬ ï¼Œåˆå¹¶ä»¥ä¸Šä¿©ä¸ªsql,å…³è”å…³ç³»æ˜¯ é€šè¿‡ç§‘å®¤è¿›è¡Œå…³è” --------- ä»¥ä¸‹æ˜¯æ ¹æ®äºšä¸“ä¸šè®¡ç®—çš„ç›¸å½“äºŽæ˜Žç»†è¡¨ï¼Œ

-- å®žéªŒåŒ»å­¦ç§‘å„ç§‘å®¤ç»¼åˆç»Ÿè®¡ï¼ˆå·¥ä½œé‡+æ”¶å…¥ç»Ÿè®¡åˆå¹¶ç‰ˆï¼‰- ä¿®æ”¹æ”¶å…¥èŽ·å–æ–¹å¼
WITH correct_workload AS (
    -- ä½¿ç”¨åŽŸå§‹Oracleè½¬Prestoçš„é€»è¾‘è®¡ç®—æ­£ç¡®çš„å·¥ä½œé‡ï¼ˆæ€»ä½“ï¼‰
    SELECT 
        t."GROUP_ID" as "äºšä¸“ä¸šç»„ä»£ç ",
        COUNT(DISTINCT t."inspection_id") as "æ ‡æœ¬æ•°",
        SUM(COALESCE(CAST(b."workload" AS DOUBLE), 0)) as "å·¥ä½œé‡"
    FROM hid0101_orcl_lis_dbo.lis_inspection_sample t
    INNER JOIN hid0101_orcl_lis_dbo.lis_inspection_sample_charge b
        ON t."inspection_id" = b."inspection_id"
        AND b."isdeleted" = '0'
    WHERE t."inspection_date" BETWEEN '20240801' AND '20240831'
        AND t."isdeleted" = '0'
    GROUP BY t."GROUP_ID"
),
golden_card_workload AS (
    -- é‡‘å¡ç±»åž‹çš„å·¥ä½œé‡å’Œæ ‡æœ¬æ•°è®¡ç®—
    SELECT 
        t."GROUP_ID" as "äºšä¸“ä¸šç»„ä»£ç ",
        COUNT(DISTINCT t."inspection_id") as "é‡‘å¡æ ‡æœ¬æ•°",
        SUM(COALESCE(CAST(b."workload" AS DOUBLE), 0)) as "é‡‘å¡å·¥ä½œé‡"
    FROM hid0101_orcl_lis_dbo.lis_inspection_sample t
    INNER JOIN hid0101_orcl_lis_dbo.lis_inspection_sample_charge b
        ON t."inspection_id" = b."inspection_id"
        AND b."isdeleted" = '0'
    WHERE t."inspection_date" BETWEEN '20240801' AND '20240831'
        AND t."isdeleted" = '0'
        AND (t."patient_type" = '9' OR t."charge_type" LIKE '%é‡‘å¡%' OR t."charge_type" LIKE '%VIP%')  -- é‡‘å¡ç±»åž‹ç­›é€‰
    GROUP BY t."GROUP_ID"
),
-- ä¿®æ”¹æ”¶å…¥èŽ·å–æ–¹å¼ï¼šç›´æŽ¥ä»Žlis_inspection_sampleèŽ·å–SAMPLE_CHARGE
income_data AS (
    SELECT 
        A."GROUP_ID" as "äºšä¸“ä¸šç»„ä»£ç ",
        -- æ€»æ”¶å…¥ï¼šç›´æŽ¥ä½¿ç”¨SAMPLE_CHARGEå­—æ®µ
        SUM(COALESCE(CAST(A."SAMPLE_CHARGE" AS DOUBLE), 0)) as "æ€»æ”¶å…¥",
        -- é‡‘å¡æ”¶å…¥ï¼šæŒ‰é‡‘å¡æ¡ä»¶ç­›é€‰çš„SAMPLE_CHARGE
        SUM(CASE 
            WHEN (A."patient_type" = '9' OR A."charge_type" LIKE '%é‡‘å¡%' OR A."charge_type" LIKE '%VIP%') 
            THEN COALESCE(CAST(A."SAMPLE_CHARGE" AS DOUBLE), 0) 
            ELSE 0 
        END) as "é‡‘å¡æ€»æ”¶å…¥"
    FROM hid0101_orcl_lis_dbo.lis_inspection_sample A
    WHERE A."inspection_date" BETWEEN '20240801' AND '20240831'
        AND A."isdeleted" = '0'
        AND A."CHECK_TIME" IS NOT NULL
    GROUP BY A."GROUP_ID"
),
dc_data AS (
    -- DCè¡¨èŽ·å–ç§‘å®¤åç§°ä¿¡æ¯
    SELECT 
        m."LIS_Sample_Main_ProfGroupCode" as "äºšä¸“ä¸šç»„ä»£ç ",
        m."LIS_Sample_Main_ProfGroupName" as "ç§‘å®¤åç§°"
    FROM datacenter_db.lis_sample_main m
    WHERE m."LIS_Sample_Main_InspectionDate" >= '20240801' 
        AND m."LIS_Sample_Main_InspectionDate" <= '20240831'
        AND m."LIS_Sample_Main_IsDeleted" = '0'
    GROUP BY 
        m."LIS_Sample_Main_ProfGroupCode",
        m."LIS_Sample_Main_ProfGroupName"
),
group_level AS (
    -- å…³è”ä¸‰ä¸ªæ•°æ®æºï¼ŒèŽ·å–äºšä¸“ä¸šç»„çº§åˆ«æ•°æ®
    SELECT 
        cw."äºšä¸“ä¸šç»„ä»£ç ",
        dc."ç§‘å®¤åç§°",
        cw."æ ‡æœ¬æ•°",
        cw."å·¥ä½œé‡" as "é¡¹ç›®æ•°",
        COALESCE(gc."é‡‘å¡æ ‡æœ¬æ•°", 0) as "é‡‘å¡æ ‡æœ¬æ•°",
        COALESCE(gc."é‡‘å¡å·¥ä½œé‡", 0) as "é‡‘å¡é¡¹ç›®æ•°",
        -- æ·»åŠ æ”¶å…¥å­—æ®µ
        COALESCE(inc."æ€»æ”¶å…¥", 0) as "æ€»æ”¶å…¥",
        COALESCE(inc."é‡‘å¡æ€»æ”¶å…¥", 0) as "é‡‘å¡æ€»æ”¶å…¥"
    FROM correct_workload cw
    LEFT JOIN dc_data dc
        ON cw."äºšä¸“ä¸šç»„ä»£ç " = dc."äºšä¸“ä¸šç»„ä»£ç "
    LEFT JOIN golden_card_workload gc
        ON cw."äºšä¸“ä¸šç»„ä»£ç " = gc."äºšä¸“ä¸šç»„ä»£ç "
    LEFT JOIN income_data inc
        ON cw."äºšä¸“ä¸šç»„ä»£ç " = inc."äºšä¸“ä¸šç»„ä»£ç "
),
final_summary AS (
    -- æŒ‰ç§‘å®¤åç§°æ±‡æ€»æ‰€æœ‰æ•°æ®
    SELECT 
        "ç§‘å®¤åç§°",
        SUM("æ ‡æœ¬æ•°") as "æ ‡æœ¬æ•°",
        SUM("é¡¹ç›®æ•°") as "é¡¹ç›®æ•°", 
        SUM("é‡‘å¡æ ‡æœ¬æ•°") as "é‡‘å¡æ ‡æœ¬æ•°",
        SUM("é‡‘å¡é¡¹ç›®æ•°") as "é‡‘å¡é¡¹ç›®æ•°",
        ROUND(SUM("æ€»æ”¶å…¥"), 2) as "æ€»æ”¶å…¥",
        ROUND(SUM("é‡‘å¡æ€»æ”¶å…¥"), 2) as "é‡‘å¡æ€»æ”¶å…¥"
    FROM group_level
    WHERE "ç§‘å®¤åç§°" IS NOT NULL
    GROUP BY "ç§‘å®¤åç§°"
)
-- æœ€ç»ˆç»“æžœ
SELECT 
    "ç§‘å®¤åç§°",
    -- å·¥ä½œé‡ç›¸å…³å­—æ®µ
    "æ ‡æœ¬æ•°",
    "é¡¹ç›®æ•°",
    "é‡‘å¡æ ‡æœ¬æ•°",
    "é‡‘å¡é¡¹ç›®æ•°",
    -- æ”¶å…¥ç›¸å…³å­—æ®µï¼ˆæ¥æºï¼šlis_inspection_sample.SAMPLE_CHARGEï¼‰
    "æ€»æ”¶å…¥",
    "é‡‘å¡æ€»æ”¶å…¥"
FROM final_summary
WHERE "ç§‘å®¤åç§°" IS NOT NULL
ORDER BY "æ ‡æœ¬æ•°" DESC, "æ€»æ”¶å…¥" DESC;



##### ä»¥ä¸‹æ˜¯æŠ¥è¡¨å†…å®¹ -- æ˜¯æ ¹æ®äºšä¸“ä¸šæ¥çœ‹çš„ï¼Œç»„æˆæŠ¥è¡¨åˆ†æž æŒ‰ç…§æŠ¥è¡¨è¿›è¡Œç»Ÿè®¡çš„è¿‡ç¨‹ æ²¡æœ‰é—®é¢˜ï¼š
-- å®žéªŒåŒ»å­¦ç§‘å„ç§‘å®¤ç»¼åˆç»Ÿè®¡ï¼ˆå·¥ä½œé‡+æ”¶å…¥ç»Ÿè®¡åˆå¹¶ç‰ˆï¼‰- ä¿®æ”¹æ”¶å…¥èŽ·å–æ–¹å¼  ï¼Œæ·»åŠ å¤©åºœé™¢åŒºï¼Œå¤©åºœé™¢åŒº ä»Šå¹´ 6æœˆä»½ä¹‹åŽæœ‰æ•°æ®ï¼Œæ‰€ä»¥æ— æ³•æä¾›åŽ†å²æ•°æ®è¿›åŽ»ã€‚


WITH correct_workload AS (
    -- ä½¿ç”¨åŽŸå§‹Oracleè½¬Prestoçš„é€»è¾‘è®¡ç®—æ­£ç¡®çš„å·¥ä½œé‡ï¼ˆæ€»ä½“ï¼‰
    SELECT 
        t."GROUP_ID" as "äºšä¸“ä¸šç»„ä»£ç ",
        COUNT(DISTINCT t."inspection_id") as "æ ‡æœ¬æ•°",
        SUM(COALESCE(CAST(b."workload" AS DOUBLE), 0)) as "å·¥ä½œé‡"
    FROM hid0101_orcl_lis_dbo.lis_inspection_sample t
    INNER JOIN hid0101_orcl_lis_dbo.lis_inspection_sample_charge b
        ON t."inspection_id" = b."inspection_id"
        AND b."isdeleted" = '0'
    WHERE t."inspection_date" BETWEEN '20240801' AND '20240831'
        AND t."isdeleted" = '0'
    GROUP BY t."GROUP_ID"
),
golden_card_workload AS (
    -- é‡‘å¡ç±»åž‹çš„å·¥ä½œé‡å’Œæ ‡æœ¬æ•°è®¡ç®—
    SELECT 
        t."GROUP_ID" as "äºšä¸“ä¸šç»„ä»£ç ",
        COUNT(DISTINCT t."inspection_id") as "é‡‘å¡æ ‡æœ¬æ•°",
        SUM(COALESCE(CAST(b."workload" AS DOUBLE), 0)) as "é‡‘å¡å·¥ä½œé‡"
    FROM hid0101_orcl_lis_dbo.lis_inspection_sample t
    INNER JOIN hid0101_orcl_lis_dbo.lis_inspection_sample_charge b
        ON t."inspection_id" = b."inspection_id"
        AND b."isdeleted" = '0'
    WHERE t."inspection_date" BETWEEN '20240801' AND '20240831'
        AND t."isdeleted" = '0'
        AND (t."patient_type" = '9' OR t."charge_type" LIKE '%é‡‘å¡%' OR t."charge_type" LIKE '%VIP%')  -- é‡‘å¡ç±»åž‹ç­›é€‰
    GROUP BY t."GROUP_ID"
),
-- ä¿®æ”¹æ”¶å…¥èŽ·å–æ–¹å¼ï¼šç›´æŽ¥ä»Žlis_inspection_sampleèŽ·å–SAMPLE_CHARGE
income_data AS (
    SELECT 
        A."GROUP_ID" as "äºšä¸“ä¸šç»„ä»£ç ",
        -- æ€»æ”¶å…¥ï¼šç›´æŽ¥ä½¿ç”¨SAMPLE_CHARGEå­—æ®µ
        SUM(COALESCE(CAST(A."SAMPLE_CHARGE" AS DOUBLE), 0)) as "æ€»æ”¶å…¥",
        -- é‡‘å¡æ”¶å…¥ï¼šæŒ‰é‡‘å¡æ¡ä»¶ç­›é€‰çš„SAMPLE_CHARGE
        SUM(CASE 
            WHEN (A."patient_type" = '9' OR A."charge_type" LIKE '%é‡‘å¡%' OR A."charge_type" LIKE '%VIP%') 
            THEN COALESCE(CAST(A."SAMPLE_CHARGE" AS DOUBLE), 0) 
            ELSE 0 
        END) as "é‡‘å¡æ€»æ”¶å…¥"
    FROM hid0101_orcl_lis_dbo.lis_inspection_sample A
    WHERE A."inspection_date" BETWEEN '20240801' AND '20240831'
        AND A."isdeleted" = '0'
        AND A."CHECK_TIME" IS NOT NULL
    GROUP BY A."GROUP_ID"
),
group_level AS (
    -- å…³è”æ•°æ®æºï¼Œå¹¶æ ¹æ®äºšä¸“ä¸šç»„ä»£ç æ˜ å°„ç§‘å®¤åç§°
    SELECT 
        cw."äºšä¸“ä¸šç»„ä»£ç ",
        -- æ ¹æ®äºšä¸“ä¸šç»„ä»£ç æ˜ å°„ç§‘å®¤åç§°
        CASE 
            WHEN cw."äºšä¸“ä¸šç»„ä»£ç " IN ('G003', 'G001') THEN 'ä¸´åºŠå…ç–«å®žéªŒå®¤'
            WHEN cw."äºšä¸“ä¸šç»„ä»£ç " IN ('G021', 'G017', 'G007') THEN 'ä¸´åºŠç”ŸåŒ–å®žéªŒå®¤'
            WHEN cw."äºšä¸“ä¸šç»„ä»£ç " IN ('G999', 'G998', 'G014', 'G022') THEN 'ä¸´åºŠå¾®ç”Ÿç‰©å®žéªŒå®¤'
            WHEN cw."äºšä¸“ä¸šç»„ä»£ç " IN ('G044', 'G009', 'G062') THEN 'ä¸´åºŠåˆ†å­è¯Šæ–­å®žéªŒå®¤'
            WHEN cw."äºšä¸“ä¸šç»„ä»£ç " IN ('G002', 'G025', 'G006', 'G004', 'G076') THEN 'ä¸´æ£€ä¸Žè¡€æ¶²å®žéªŒå®¤'
            WHEN cw."äºšä¸“ä¸šç»„ä»£ç " IN ('G049', 'G051', 'G050', 'G054', 'G065') THEN 'æ°¸å®é™¢åŒº'
            WHEN cw."äºšä¸“ä¸šç»„ä»£ç " IN ('G011', 'G010', 'G072') THEN 'æ€¥è¯Šåº”æ€¥ç»„'
            WHEN cw."äºšä¸“ä¸šç»„ä»£ç " IN ('G112', 'G113') THEN 'å¤©åºœé™¢åŒº'
            ELSE 'å…¶ä»–' -- æœªæ˜ å°„çš„äºšä¸“ä¸šç»„ä»£ç 
        END as "ç§‘å®¤åç§°",
        cw."æ ‡æœ¬æ•°",
        cw."å·¥ä½œé‡" as "é¡¹ç›®æ•°",
        COALESCE(gc."é‡‘å¡æ ‡æœ¬æ•°", 0) as "é‡‘å¡æ ‡æœ¬æ•°",
        COALESCE(gc."é‡‘å¡å·¥ä½œé‡", 0) as "é‡‘å¡é¡¹ç›®æ•°",
        -- æ·»åŠ æ”¶å…¥å­—æ®µ
        COALESCE(inc."æ€»æ”¶å…¥", 0) as "æ€»æ”¶å…¥",
        COALESCE(inc."é‡‘å¡æ€»æ”¶å…¥", 0) as "é‡‘å¡æ€»æ”¶å…¥"
    FROM correct_workload cw
    LEFT JOIN golden_card_workload gc
        ON cw."äºšä¸“ä¸šç»„ä»£ç " = gc."äºšä¸“ä¸šç»„ä»£ç "
    LEFT JOIN income_data inc
        ON cw."äºšä¸“ä¸šç»„ä»£ç " = inc."äºšä¸“ä¸šç»„ä»£ç "
),
final_summary AS (
    -- æŒ‰ç§‘å®¤åç§°æ±‡æ€»æ‰€æœ‰æ•°æ®
    SELECT 
        "ç§‘å®¤åç§°",
        SUM("æ ‡æœ¬æ•°") as "æ ‡æœ¬æ•°",
        SUM("é¡¹ç›®æ•°") as "é¡¹ç›®æ•°", 
        SUM("é‡‘å¡æ ‡æœ¬æ•°") as "é‡‘å¡æ ‡æœ¬æ•°",
        SUM("é‡‘å¡é¡¹ç›®æ•°") as "é‡‘å¡é¡¹ç›®æ•°",
        ROUND(SUM("æ€»æ”¶å…¥"), 2) as "æ€»æ”¶å…¥",
        ROUND(SUM("é‡‘å¡æ€»æ”¶å…¥"), 2) as "é‡‘å¡æ€»æ”¶å…¥"
    FROM group_level
    WHERE "ç§‘å®¤åç§°" IS NOT NULL 
        AND "ç§‘å®¤åç§°" != 'å…¶ä»–'  -- è¿‡æ»¤æŽ‰æœªæ˜ å°„çš„æ•°æ®
    GROUP BY "ç§‘å®¤åç§°"
),
total_income AS (
    -- è®¡ç®—æ€»æ”¶å…¥ï¼ˆåˆè®¡ï¼‰ç”¨äºŽè®¡ç®—å æ¯”
    SELECT SUM("æ€»æ”¶å…¥") as total_income_sum
    FROM final_summary
),
summary_totals AS (
    -- è®¡ç®—åˆè®¡å’Œæœ¬éƒ¨å®žé™…é‡
    SELECT 
        'åˆè®¡' as "ç§‘å®¤åç§°",
        SUM("æ ‡æœ¬æ•°") as "æ ‡æœ¬æ•°",
        SUM("é¡¹ç›®æ•°") as "é¡¹ç›®æ•°",
        SUM("é‡‘å¡æ ‡æœ¬æ•°") as "é‡‘å¡æ ‡æœ¬æ•°",
        SUM("é‡‘å¡é¡¹ç›®æ•°") as "é‡‘å¡é¡¹ç›®æ•°",
        SUM("æ€»æ”¶å…¥") as "æ€»æ”¶å…¥",
        SUM("é‡‘å¡æ€»æ”¶å…¥") as "é‡‘å¡æ€»æ”¶å…¥"
    FROM final_summary
    
    UNION ALL
    
    SELECT 
        'æœ¬éƒ¨å®žé™…é‡' as "ç§‘å®¤åç§°",
        SUM("æ ‡æœ¬æ•°") as "æ ‡æœ¬æ•°",
        SUM("é¡¹ç›®æ•°") as "é¡¹ç›®æ•°",
        SUM("é‡‘å¡æ ‡æœ¬æ•°") as "é‡‘å¡æ ‡æœ¬æ•°",
        SUM("é‡‘å¡é¡¹ç›®æ•°") as "é‡‘å¡é¡¹ç›®æ•°",
        SUM("æ€»æ”¶å…¥") as "æ€»æ”¶å…¥",
        SUM("é‡‘å¡æ€»æ”¶å…¥") as "é‡‘å¡æ€»æ”¶å…¥"
    FROM final_summary
    WHERE "ç§‘å®¤åç§°" != 'å¤©åºœé™¢åŒº'  -- æŽ’é™¤å¤©åºœé™¢åŒº
)
-- æœ€ç»ˆç»“æžœï¼šåŽŸæœ‰ç§‘å®¤æ•°æ® + åˆè®¡ + æœ¬éƒ¨å®žé™…é‡
SELECT 
    "ç§‘å®¤åç§°",
    -- å·¥ä½œé‡ç›¸å…³å­—æ®µ
    "æ ‡æœ¬æ•°",
    "é¡¹ç›®æ•°",
    "é‡‘å¡æ ‡æœ¬æ•°",
    "é‡‘å¡é¡¹ç›®æ•°",
    -- æ”¶å…¥ç›¸å…³å­—æ®µï¼ˆæ¥æºï¼šlis_inspection_sample.SAMPLE_CHARGEï¼‰
    "æ€»æ”¶å…¥",
    "é‡‘å¡æ€»æ”¶å…¥"
FROM final_summary

UNION ALL

SELECT 
    "ç§‘å®¤åç§°",
    "æ ‡æœ¬æ•°",
    "é¡¹ç›®æ•°",
    "é‡‘å¡æ ‡æœ¬æ•°",
    "é‡‘å¡é¡¹ç›®æ•°",
    "æ€»æ”¶å…¥",
    "é‡‘å¡æ€»æ”¶å…¥"
FROM summary_totals

ORDER BY 
    CASE 
        WHEN "ç§‘å®¤åç§°" = 'åˆè®¡' THEN 1
        WHEN "ç§‘å®¤åç§°" = 'æœ¬éƒ¨å®žé™…é‡' THEN 2
        ELSE 3
    END,
    "æ ‡æœ¬æ•°" DESC, "æ€»æ”¶å…¥" DESC;

## æ·»åŠ æ€»æ”¶å…¥å æ¯”çš„å­—æ®µ  è¿˜æ˜¯ä»¥ä¸Šå†…å®¹å‡çº§ç‰ˆæœ¬

-- å®žéªŒåŒ»å­¦ç§‘å„ç§‘å®¤ç»¼åˆç»Ÿè®¡ï¼ˆå·¥ä½œé‡+æ”¶å…¥ç»Ÿè®¡åˆå¹¶ç‰ˆï¼‰- ä¿®æ”¹æ”¶å…¥èŽ·å–æ–¹å¼  ï¼Œæ·»åŠ å¤©åºœé™¢åŒºï¼Œå¤©åºœé™¢åŒº ä»Šå¹´ 6æœˆä»½ä¹‹åŽæœ‰æ•°æ®ï¼Œæ‰€ä»¥æ— æ³•æä¾›åŽ†å²æ•°æ®è¿›åŽ»ã€‚


WITH correct_workload AS (
    -- ä½¿ç”¨åŽŸå§‹Oracleè½¬Prestoçš„é€»è¾‘è®¡ç®—æ­£ç¡®çš„å·¥ä½œé‡ï¼ˆæ€»ä½“ï¼‰
    SELECT 
        t."GROUP_ID" as "äºšä¸“ä¸šç»„ä»£ç ",
        COUNT(DISTINCT t."inspection_id") as "æ ‡æœ¬æ•°",
        SUM(COALESCE(CAST(b."workload" AS DOUBLE), 0)) as "å·¥ä½œé‡"
    FROM hid0101_orcl_lis_dbo.lis_inspection_sample t
    INNER JOIN hid0101_orcl_lis_dbo.lis_inspection_sample_charge b
        ON t."inspection_id" = b."inspection_id"
        AND b."isdeleted" = '0'
    WHERE t."inspection_date" BETWEEN '20240801' AND '20240831'
        AND t."isdeleted" = '0'
    GROUP BY t."GROUP_ID"
),
golden_card_workload AS (
    -- é‡‘å¡ç±»åž‹çš„å·¥ä½œé‡å’Œæ ‡æœ¬æ•°è®¡ç®—
    SELECT 
        t."GROUP_ID" as "äºšä¸“ä¸šç»„ä»£ç ",
        COUNT(DISTINCT t."inspection_id") as "é‡‘å¡æ ‡æœ¬æ•°",
        SUM(COALESCE(CAST(b."workload" AS DOUBLE), 0)) as "é‡‘å¡å·¥ä½œé‡"
    FROM hid0101_orcl_lis_dbo.lis_inspection_sample t
    INNER JOIN hid0101_orcl_lis_dbo.lis_inspection_sample_charge b
        ON t."inspection_id" = b."inspection_id"
        AND b."isdeleted" = '0'
    WHERE t."inspection_date" BETWEEN '20240801' AND '20240831'
        AND t."isdeleted" = '0'
        AND (t."patient_type" = '9' OR t."charge_type" LIKE '%é‡‘å¡%' OR t."charge_type" LIKE '%VIP%')  -- é‡‘å¡ç±»åž‹ç­›é€‰
    GROUP BY t."GROUP_ID"
),
-- ä¿®æ”¹æ”¶å…¥èŽ·å–æ–¹å¼ï¼šç›´æŽ¥ä»Žlis_inspection_sampleèŽ·å–SAMPLE_CHARGE
income_data AS (
    SELECT 
        A."GROUP_ID" as "äºšä¸“ä¸šç»„ä»£ç ",
        -- æ€»æ”¶å…¥ï¼šç›´æŽ¥ä½¿ç”¨SAMPLE_CHARGEå­—æ®µ
        SUM(COALESCE(CAST(A."SAMPLE_CHARGE" AS DOUBLE), 0)) as "æ€»æ”¶å…¥",
        -- é‡‘å¡æ”¶å…¥ï¼šæŒ‰é‡‘å¡æ¡ä»¶ç­›é€‰çš„SAMPLE_CHARGE
        SUM(CASE 
            WHEN (A."patient_type" = '9' OR A."charge_type" LIKE '%é‡‘å¡%' OR A."charge_type" LIKE '%VIP%') 
            THEN COALESCE(CAST(A."SAMPLE_CHARGE" AS DOUBLE), 0) 
            ELSE 0 
        END) as "é‡‘å¡æ€»æ”¶å…¥"
    FROM hid0101_orcl_lis_dbo.lis_inspection_sample A
    WHERE A."inspection_date" BETWEEN '20240801' AND '20240831'
        AND A."isdeleted" = '0'
        AND A."CHECK_TIME" IS NOT NULL
    GROUP BY A."GROUP_ID"
),
group_level AS (
    -- å…³è”æ•°æ®æºï¼Œå¹¶æ ¹æ®äºšä¸“ä¸šç»„ä»£ç æ˜ å°„ç§‘å®¤åç§°
    SELECT 
        cw."äºšä¸“ä¸šç»„ä»£ç ",
        -- æ ¹æ®äºšä¸“ä¸šç»„ä»£ç æ˜ å°„ç§‘å®¤åç§°
        CASE 
            WHEN cw."äºšä¸“ä¸šç»„ä»£ç " IN ('G003', 'G001') THEN 'ä¸´åºŠå…ç–«å®žéªŒå®¤'
            WHEN cw."äºšä¸“ä¸šç»„ä»£ç " IN ('G021', 'G017', 'G007') THEN 'ä¸´åºŠç”ŸåŒ–å®žéªŒå®¤'
            WHEN cw."äºšä¸“ä¸šç»„ä»£ç " IN ('G999', 'G998', 'G014', 'G022') THEN 'ä¸´åºŠå¾®ç”Ÿç‰©å®žéªŒå®¤'
            WHEN cw."äºšä¸“ä¸šç»„ä»£ç " IN ('G044', 'G009', 'G062') THEN 'ä¸´åºŠåˆ†å­è¯Šæ–­å®žéªŒå®¤'
            WHEN cw."äºšä¸“ä¸šç»„ä»£ç " IN ('G002', 'G025', 'G006', 'G004', 'G076') THEN 'ä¸´æ£€ä¸Žè¡€æ¶²å®žéªŒå®¤'
            WHEN cw."äºšä¸“ä¸šç»„ä»£ç " IN ('G049', 'G051', 'G050', 'G054', 'G065') THEN 'æ°¸å®é™¢åŒº'
            WHEN cw."äºšä¸“ä¸šç»„ä»£ç " IN ('G011', 'G010', 'G072') THEN 'æ€¥è¯Šåº”æ€¥ç»„'
            WHEN cw."äºšä¸“ä¸šç»„ä»£ç " IN ('G112', 'G113') THEN 'å¤©åºœé™¢åŒº'
            ELSE 'å…¶ä»–' -- æœªæ˜ å°„çš„äºšä¸“ä¸šç»„ä»£ç 
        END as "ç§‘å®¤åç§°",
        cw."æ ‡æœ¬æ•°",
        cw."å·¥ä½œé‡" as "é¡¹ç›®æ•°",
        COALESCE(gc."é‡‘å¡æ ‡æœ¬æ•°", 0) as "é‡‘å¡æ ‡æœ¬æ•°",
        COALESCE(gc."é‡‘å¡å·¥ä½œé‡", 0) as "é‡‘å¡é¡¹ç›®æ•°",
        -- æ·»åŠ æ”¶å…¥å­—æ®µ
        COALESCE(inc."æ€»æ”¶å…¥", 0) as "æ€»æ”¶å…¥",
        COALESCE(inc."é‡‘å¡æ€»æ”¶å…¥", 0) as "é‡‘å¡æ€»æ”¶å…¥"
    FROM correct_workload cw
    LEFT JOIN golden_card_workload gc
        ON cw."äºšä¸“ä¸šç»„ä»£ç " = gc."äºšä¸“ä¸šç»„ä»£ç "
    LEFT JOIN income_data inc
        ON cw."äºšä¸“ä¸šç»„ä»£ç " = inc."äºšä¸“ä¸šç»„ä»£ç "
),
final_summary AS (
    -- æŒ‰ç§‘å®¤åç§°æ±‡æ€»æ‰€æœ‰æ•°æ®
    SELECT 
        "ç§‘å®¤åç§°",
        SUM("æ ‡æœ¬æ•°") as "æ ‡æœ¬æ•°",
        SUM("é¡¹ç›®æ•°") as "é¡¹ç›®æ•°", 
        SUM("é‡‘å¡æ ‡æœ¬æ•°") as "é‡‘å¡æ ‡æœ¬æ•°",
        SUM("é‡‘å¡é¡¹ç›®æ•°") as "é‡‘å¡é¡¹ç›®æ•°",
        ROUND(SUM("æ€»æ”¶å…¥"), 2) as "æ€»æ”¶å…¥",
        ROUND(SUM("é‡‘å¡æ€»æ”¶å…¥"), 2) as "é‡‘å¡æ€»æ”¶å…¥"
    FROM group_level
    WHERE "ç§‘å®¤åç§°" IS NOT NULL 
        AND "ç§‘å®¤åç§°" != 'å…¶ä»–'  -- è¿‡æ»¤æŽ‰æœªæ˜ å°„çš„æ•°æ®
    GROUP BY "ç§‘å®¤åç§°"
),
total_income AS (
    -- è®¡ç®—æ€»æ”¶å…¥ï¼ˆåˆè®¡ï¼‰ç”¨äºŽè®¡ç®—å æ¯”
    SELECT SUM("æ€»æ”¶å…¥") as total_income_sum
    FROM final_summary
),
summary_totals AS (
    -- è®¡ç®—åˆè®¡å’Œæœ¬éƒ¨å®žé™…é‡
    SELECT 
        'åˆè®¡' as "ç§‘å®¤åç§°",
        SUM("æ ‡æœ¬æ•°") as "æ ‡æœ¬æ•°",
        SUM("é¡¹ç›®æ•°") as "é¡¹ç›®æ•°",
        SUM("é‡‘å¡æ ‡æœ¬æ•°") as "é‡‘å¡æ ‡æœ¬æ•°",
        SUM("é‡‘å¡é¡¹ç›®æ•°") as "é‡‘å¡é¡¹ç›®æ•°",
        SUM("æ€»æ”¶å…¥") as "æ€»æ”¶å…¥",
        100.00 as "æ”¶å…¥å æ¯”%",  -- åˆè®¡è¡Œæ˜¾ç¤º100%
        SUM("é‡‘å¡æ€»æ”¶å…¥") as "é‡‘å¡æ€»æ”¶å…¥"
    FROM final_summary
    
    UNION ALL
    
    SELECT 
        'æœ¬éƒ¨å®žé™…é‡' as "ç§‘å®¤åç§°",
        SUM("æ ‡æœ¬æ•°") as "æ ‡æœ¬æ•°",
        SUM("é¡¹ç›®æ•°") as "é¡¹ç›®æ•°",
        SUM("é‡‘å¡æ ‡æœ¬æ•°") as "é‡‘å¡æ ‡æœ¬æ•°",
        SUM("é‡‘å¡é¡¹ç›®æ•°") as "é‡‘å¡é¡¹ç›®æ•°",
        SUM("æ€»æ”¶å…¥") as "æ€»æ”¶å…¥",
        ROUND(SUM("æ€»æ”¶å…¥") * 100.0 / (SELECT total_income_sum FROM total_income), 2) as "æ”¶å…¥å æ¯”%",
        SUM("é‡‘å¡æ€»æ”¶å…¥") as "é‡‘å¡æ€»æ”¶å…¥"
    FROM final_summary
    WHERE "ç§‘å®¤åç§°" != 'å¤©åºœé™¢åŒº'  -- æŽ’é™¤å¤©åºœé™¢åŒº
)
-- æœ€ç»ˆç»“æžœï¼šåŽŸæœ‰ç§‘å®¤æ•°æ® + åˆè®¡ + æœ¬éƒ¨å®žé™…é‡
SELECT 
    fs."ç§‘å®¤åç§°",
    fs."æ ‡æœ¬æ•°",
    fs."é¡¹ç›®æ•°",
    fs."é‡‘å¡æ ‡æœ¬æ•°",
    fs."é‡‘å¡é¡¹ç›®æ•°",
    fs."æ€»æ”¶å…¥",
    -- è®¡ç®—æ”¶å…¥å æ¯”
    ROUND(fs."æ€»æ”¶å…¥" * 100.0 / (SELECT total_income_sum FROM total_income), 2) as "æ”¶å…¥å æ¯”%",
    fs."é‡‘å¡æ€»æ”¶å…¥"
FROM final_summary fs

UNION ALL

SELECT 
    "ç§‘å®¤åç§°",
    "æ ‡æœ¬æ•°",
    "é¡¹ç›®æ•°",
    "é‡‘å¡æ ‡æœ¬æ•°",
    "é‡‘å¡é¡¹ç›®æ•°",
    "æ€»æ”¶å…¥",
    "æ”¶å…¥å æ¯”%",
    "é‡‘å¡æ€»æ”¶å…¥"
FROM summary_totals

ORDER BY 
    CASE 
        WHEN "ç§‘å®¤åç§°" = 'åˆè®¡' THEN 1
        WHEN "ç§‘å®¤åç§°" = 'æœ¬éƒ¨å®žé™…é‡' THEN 2
        ELSE 3
    END,
    "æ ‡æœ¬æ•°" DESC, "æ€»æ”¶å…¥" DESC;








##### lis éœ€æ±‚ç»“æŸ

å½“å‰å¼€å§‹è¿›è¡Œä¸‹ä¸€æ­¥éœ€æ±‚ï¼Œ














----------æ˜Žå¤©æ˜¯è¾“è¡€ç§‘å’Œæ”¶å…¥è®¡ç®—ï¼Œçœ‹æ€Žä¹ˆç®—,

è¾“è¡€è®¡ç®—é€»è¾‘ï¼Œå…ˆæŠŠæ£€éªŒçš„ç»Ÿè®¡äº†ï¼Œå…¶ä»–çš„å†è¯´å§ã€‚

æ£€éªŒå†…å®¹ç»Ÿè®¡ï¼Œå½“å‰é€»è¾‘ï¼ŒæŒ‰ç…§ç»™å‡ºçš„éœ€æ±‚è¿›è¡Œç»Ÿè®¡å°±è¡Œäº†ã€‚

çŸ«æ­£ä¸€ä¸‹ã€‚å½“å‰å“ªäº›æ²¡æœ‰ åŒ…å«åœ¨å†…

æŒ‰ç…§éœ€æ±‚æ¥æ•´å°±æ²¡é—®é¢˜äº†





<!DOCTYPE html><html><head>
      <title>输血科报表主题数据架构设计方案</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:///c:\Users\15638\.cursor\extensions\shd101wyy.markdown-preview-enhanced-0.8.18\crossnote\dependencies\katex\katex.min.css">
      
      
      <script type="text/javascript" src="file:///c:\Users\15638\.cursor\extensions\shd101wyy.markdown-preview-enhanced-0.8.18\crossnote\dependencies\mermaid\mermaid.min.js" charset="UTF-8"></script>
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="输血科报表主题数据架构设计方案">输血科报表主题数据架构设计方案 </h1>
<h2 id="一-总体架构概述">一、总体架构概述 </h2>
<p>基于现有DL -&gt; DC -&gt; MDR的三层架构，针对输血科2024年8月运营分析业务需求设计完整的数据流向，整合LIS检验系统和输血管理系统数据，支持环比同比分析：</p>
<div class="mermaid">graph TB
    subgraph "DL层 - 数据湖层(ODS贴源)"
        subgraph "输血管理系统"
            DL1[BIS_REQUISITION_INFO&lt;br/&gt;申请单信息表]
            DL2[BIS_BLOOD_INPUT&lt;br/&gt;血袋表]
            DL3[BIS_TAKE_BLOOD&lt;br/&gt;取血表]
            DL4[BIS_TRANSBLOOD_PROCESS_LIST&lt;br/&gt;输注记录表]
        end
        
        subgraph "LIS检验系统"
            DL5[LIS_REQUISITION_INFO&lt;br/&gt;样本信息主表]
            DL6[LIS_REQUISITION_ITEM&lt;br/&gt;样本项目明细表]
            DL7[LIS_INSPECTION_RESULT&lt;br/&gt;检验结果表]
        end
        
        subgraph "现有DC层表"
            DL8[Apply_BloodTrans&lt;br/&gt;申请_输血表]
            DL9[Fee_BillDet&lt;br/&gt;费用_账单明细表]
        end
    end
    
    subgraph "DC层 - 数据中心层(DWD数据仓库明细层)"
        subgraph "明细数据表"
            DC1["LIS_Sample_Main&lt;br/&gt;检验标本主表&lt;br/&gt;复用LIS主题"]
            DC2["BTS_Blood_Detail&lt;br/&gt;血液明细表&lt;br/&gt;新增"]
            DC3["BTS_Work_Record&lt;br/&gt;工作量记录表&lt;br/&gt;新增"]
        end
        
        subgraph "汇总数据表"
            DC4["BTS_Daily_Summary&lt;br/&gt;日度汇总大宽表&lt;br/&gt;新增"]
            DC5["BTS_BloodStock_Monthly&lt;br/&gt;血液库存月度汇总表&lt;br/&gt;新增"]
        end
    end
    
    subgraph "MDR层 - 主题数据集市层"
        MDR1[输血科综合分析主题&lt;br/&gt;基于DC汇总表]
    end
    
    subgraph "应用层"
        APP1[2024-08月度运营分析]
        APP2[环比分析08 vs 07]
        APP3[同比分析24-08 vs 23-08]
        APP4[四大类工作量统计]
        APP5[三类收入分析]
    end
    
    %% 数据流向
    DL1 --&gt; DC2
    DL2 --&gt; DC2
    DL3 --&gt; DC2
    DL4 --&gt; DC3
    DL5 --&gt; DC1
    DL6 --&gt; DC1
    DL7 --&gt; DC3
    DL8 --&gt; DC1
    DL9 --&gt; DC4
    
    DC1 --&gt; DC3
    DC2 --&gt; DC3
    DC2 --&gt; DC5
    
    DC1 --&gt; DC4
    DC2 --&gt; DC4
    DC3 --&gt; DC4
    
    DC4 --&gt; MDR1
    DC5 --&gt; MDR1
    
    MDR1 --&gt; APP1
    MDR1 --&gt; APP2
    MDR1 --&gt; APP3
    MDR1 --&gt; APP4
    MDR1 --&gt; APP5
    
    %% 样式
    classDef dlStyle fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef dcStyle fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef mdrStyle fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
    classDef appStyle fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    
    class DL1,DL2,DL3,DL4,DL5,DL6,DL7,DL8,DL9 dlStyle
    class DC1,DC2,DC3,DC4 dcStyle
    class MDR1 mdrStyle
    class APP1,APP2,APP3,APP4,APP5 appStyle
</div><h3 id="11-数据分层说明">1.1 数据分层说明 </h3>
<table>
<thead>
<tr>
<th>数据层级</th>
<th>数据类型</th>
<th>表名举例</th>
<th>数据来源</th>
<th>数据特点</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>DL层(ODS)</strong></td>
<td>贴源数据</td>
<td>BIS_REQUISITION_INFO、LIS_REQUISITION_INFO</td>
<td>输血+LIS系统直接复制</td>
<td>保持源系统原始结构，双系统整合</td>
</tr>
<tr>
<td><strong>DC层-明细</strong></td>
<td>明细数据</td>
<td>BTS_Sample_Main、BTS_Blood_Detail</td>
<td>DL层集成处理</td>
<td>标准化字段、多医院统一、原子粒度</td>
</tr>
<tr>
<td><strong>DC层-汇总</strong></td>
<td>汇总数据</td>
<td>BTS_Daily_Summary</td>
<td>DC明细表聚合</td>
<td>按维度预聚合，提升查询性能</td>
</tr>
<tr>
<td><strong>MDR层</strong></td>
<td>主题数据</td>
<td>MDR_BTS_Monthly_Summary</td>
<td>DC层数据整合</td>
<td>面向月度分析的宽表，支持环比同比</td>
</tr>
</tbody>
</table>
<h3 id="12-核心业务需求">1.2 核心业务需求 </h3>
<p><strong>业务目标</strong>：</p>
<ul>
<li>通过对比输血科2024-08与2024-07（环比）、与2023-08（同比）关键指标</li>
<li>评估科室运营效率及成本结构，为优化资源配置和费用管控提供决策支持</li>
</ul>
<p><strong>使用人群</strong>：院领导、输血科主任、运营管理组、财务分析组<br>
<strong>时间粒度</strong>：月度对比分析，包括当月、环比、同比<br>
<strong>统计范围</strong>：输血科整体运行数据，包含样本处理、检测项目、人工作业、血液收支及物料支出</p>
<h3 id="13-设计理念对标现有dc架构">1.3 设计理念对标现有DC架构 </h3>
<p>通过分析现有<code>Apply_BloodTrans</code>等DC表，输血科主题严格遵循以下设计风格：</p>
<ol>
<li><strong>命名规范一致性</strong>：<code>BTS_表名_字段名</code>格式，如<code>BTS_Sample_Main_SampleID</code></li>
<li><strong>字段类型标准化</strong>：ID统一使用VARCHAR(60)，金额使用FLOAT8，时间使用timestamp</li>
<li><strong>数据完整性</strong>：每个事实表都包含完整的维度信息（机构、人员、就诊等）</li>
<li><strong>扩展性设计</strong>：预留扩展字段(ExtStr1-6, ExtNum1-2, ExtDate1-2)</li>
<li><strong>元数据管理</strong>：包含数据来源标识、创建时间、更新时间等字段</li>
</ol>
<h3 id="14-核心指标体系">1.4 核心指标体系 </h3>
<h4 id="141-基础指标定义">1.4.1 基础指标定义 </h4>
<table>
<thead>
<tr>
<th>指标类别</th>
<th>指标名称</th>
<th>指标内涵</th>
<th>最小粒度</th>
<th>计算方式</th>
<th>数据来源</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>样本数量</strong></td>
<td>样本数</td>
<td>接收的所有要检测的样本和输血申请</td>
<td>单个样本</td>
<td>COUNT(DISTINCT 样本ID)</td>
<td>输血+LIS系统统计</td>
</tr>
<tr>
<td><strong>检测项目</strong></td>
<td>检测/项目数</td>
<td>检测的项目数（详见子项目分类）</td>
<td>单个检测项目</td>
<td>按检验目的明细统计</td>
<td>输血+LIS系统统计</td>
</tr>
</tbody>
</table>
<h4 id="142-检测项目明细分类">1.4.2 检测项目明细分类 </h4>
<table>
<thead>
<tr>
<th>子项目</th>
<th>指标内涵</th>
<th>计算方式</th>
<th>数据来源(LIS项目编码)</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>血型检测</strong></td>
<td>患者血型检测+献血员血型复查</td>
<td>项目计数</td>
<td>LIS07068、LIS05、LIS0300255、LIS0300114</td>
</tr>
<tr>
<td><strong>抗体筛查</strong></td>
<td>患者抗体筛查</td>
<td>项目计数</td>
<td>LIS07073血型单特异性抗体鉴定</td>
</tr>
<tr>
<td><strong>交叉配血</strong></td>
<td>根据用血紧急程度选择相应方法配血</td>
<td>项目计数</td>
<td>LIS07156、LIS07157、LIS07153</td>
</tr>
<tr>
<td><strong>直接抗人球蛋白试验</strong></td>
<td>直抗检测</td>
<td>项目计数</td>
<td>LIS07079直接抗人球蛋白试验</td>
</tr>
<tr>
<td><strong>疑难样本</strong></td>
<td>疑难血型及抗筛阳性鉴定</td>
<td>项目计数</td>
<td>LIS07072、LIS07074、LIS07075、LIS07077</td>
</tr>
<tr>
<td><strong>血小板交叉配血</strong></td>
<td>血小板交叉配合试验</td>
<td>项目计数</td>
<td>LIS026801血小板交叉配合试验</td>
</tr>
<tr>
<td><strong>血小板抗体检测</strong></td>
<td>血小板特异性和HLA抗体检测</td>
<td>项目计数</td>
<td>LIS026797血小板特异性抗体检测</td>
</tr>
<tr>
<td><strong>抗体效价</strong></td>
<td>移植前后患者血型抗体效价检测</td>
<td>项目计数</td>
<td>LIS030072、LIS030073、LIS030075</td>
</tr>
<tr>
<td><strong>Rh分型</strong></td>
<td>Rh血型系统主要抗原检测</td>
<td>项目计数</td>
<td>LIS028043 Rh分型</td>
</tr>
</tbody>
</table>
<h4 id="143-四大类工作量统计">1.4.3 四大类工作量统计 </h4>
<table>
<thead>
<tr>
<th>工作量类别</th>
<th>指标名称</th>
<th>指标内涵</th>
<th>最小粒度</th>
<th>计算方式</th>
<th>数据来源</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>样本检测工作量</strong></td>
<td>样本检测</td>
<td>上述检测项目操作总量</td>
<td>单次检测操作</td>
<td>SUM(检测操作次数)</td>
<td>LIS系统操作记录</td>
</tr>
<tr>
<td><strong>临床用血工作量</strong></td>
<td>血液预约次数</td>
<td>血液预约</td>
<td>单次预约</td>
<td>COUNT(预约记录)</td>
<td>血站约血系统</td>
</tr>
<tr>
<td></td>
<td>血液入库(袋)</td>
<td>血液验收、入库、留样本、存放库位</td>
<td>单袋入库</td>
<td>COUNT(入库袋数)</td>
<td>输血系统统计</td>
</tr>
<tr>
<td></td>
<td>血液出库(袋)</td>
<td>血液出库、外观检测、核对</td>
<td>单袋出库</td>
<td>COUNT(出库袋数)</td>
<td>输血系统统计</td>
</tr>
<tr>
<td></td>
<td>血液盘存(袋)</td>
<td>每周一盘点所有血液库存</td>
<td>单次盘存</td>
<td>COUNT(盘存记录)</td>
<td>输血系统统计</td>
</tr>
<tr>
<td></td>
<td>血浆/冷沉淀融化(袋)</td>
<td>发放前水浴融解处理</td>
<td>单袋融化</td>
<td>COUNT(融化袋数)</td>
<td>输血系统统计</td>
</tr>
<tr>
<td><strong>输血治疗工作量</strong></td>
<td>全血采集</td>
<td>血液稀释疗法及自体全血储存</td>
<td>单次采集</td>
<td>COUNT(采集次数)</td>
<td>HIS医嘱：666600613、666000570等</td>
</tr>
<tr>
<td></td>
<td>血浆置换</td>
<td>全血置换、淋巴血浆置换等</td>
<td>单次置换</td>
<td>COUNT(置换次数)</td>
<td>HIS医嘱：666600598</td>
</tr>
<tr>
<td></td>
<td>血液单采</td>
<td>PRP采集、红细胞单采、血小板单采</td>
<td>单次单采</td>
<td>COUNT(单采次数)</td>
<td>HIS医嘱：666000510</td>
</tr>
<tr>
<td><strong>血液管理工作量</strong></td>
<td>输血管理</td>
<td>合理用血评估、输血病历抽查、不良反应调查</td>
<td>单次管理操作</td>
<td>COUNT(管理操作)</td>
<td>质控岗考核指标</td>
</tr>
</tbody>
</table>
<h4 id="144-三类收入与支出">1.4.4 三类收入与支出 </h4>
<table>
<thead>
<tr>
<th>指标类别</th>
<th>指标名称</th>
<th>指标内涵</th>
<th>最小粒度</th>
<th>计算方式</th>
<th>数据来源</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>收入</strong></td>
<td>配血检收入</td>
<td>样本检测收入</td>
<td>单笔收费记录</td>
<td>按收费项目名称筛选检验相关费用</td>
<td>现有Fee_BillDet表</td>
</tr>
<tr>
<td></td>
<td>血费收入</td>
<td>血液收入</td>
<td>单笔血液费用</td>
<td>按收费项目名称筛选血液相关费用</td>
<td>现有Fee_BillDet表</td>
</tr>
<tr>
<td></td>
<td>输血治疗收入</td>
<td>输血治疗项目收入</td>
<td>单笔治疗费用</td>
<td>按收费项目名称筛选治疗相关费用</td>
<td>现有Fee_BillDet表</td>
</tr>
<tr>
<td><strong>支出</strong></td>
<td>血费支出</td>
<td>血液成本支出</td>
<td>单笔血液成本</td>
<td>血站结算清单费用</td>
<td>血站系统</td>
</tr>
<tr>
<td></td>
<td>试剂支出</td>
<td>试剂支出</td>
<td>单笔试剂费用</td>
<td>试剂库订单费用</td>
<td>试剂库系统</td>
</tr>
</tbody>
</table>
<h2 id="二-dc层原子指标设计原则">二、DC层原子指标设计原则 </h2>
<h3 id="21-设计理念严格对标现有dc架构">2.1 设计理念严格对标现有DC架构 </h3>
<p>通过分析现有<code>Apply_BloodTrans</code>、<code>Fee_BillDet</code>等DC表，输血科主题严格遵循以下设计风格：</p>
<ol>
<li><strong>命名规范一致性</strong>：<code>BTS_表名_字段名</code>格式，如<code>BTS_Sample_Main_SampleID</code>，对标<code>Apply_BloodTrans_ApplyID</code></li>
<li><strong>字段类型标准化</strong>：ID统一使用VARCHAR(60)，金额使用FLOAT8，时间使用timestamp，与现有DC表保持一致</li>
<li><strong>数据完整性</strong>：每个事实表都包含完整的维度信息（机构、人员、就诊、科室等），对标<code>Apply_BloodTrans</code>设计</li>
<li><strong>扩展性设计</strong>：预留扩展字段(ExtStr1-6, ExtNum1-2, ExtDate1-2)，与现有DC架构统一</li>
<li><strong>元数据管理</strong>：包含DataSourceFlag、DSTable、IsDeleted、LastUpdateDtTm等标准字段</li>
</ol>
<h3 id="22-原子指标最小粒度说明">2.2 原子指标最小粒度说明 </h3>
<table>
<thead>
<tr>
<th>业务域</th>
<th>原子指标</th>
<th>最小统计粒度</th>
<th>支持聚合维度</th>
<th>设计原因</th>
<th>对标现有DC表</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>样本域</strong></td>
<td>样本数量</td>
<td>单个样本(样本ID)</td>
<td>日期/科室/血液类型/检测类型</td>
<td>每个条码对应一个独立样本，是业务最小单元</td>
<td>类似Apply_BloodTrans按申请单粒度</td>
</tr>
<tr>
<td><strong>血液域</strong></td>
<td>血液数量</td>
<td>单个血袋(血袋编号)</td>
<td>日期/血液类型/血液状态/来源机构</td>
<td>每个血袋是血液管理的最小单位</td>
<td>新增血液管理维度</td>
</tr>
<tr>
<td><strong>检验域</strong></td>
<td>检验项目数</td>
<td>单个检验项目(检验ID+项目ID)</td>
<td>日期/检验类型/检验人员/检验状态</td>
<td>每个检验项目是独立的检测单元</td>
<td>扩展Apply_BloodTrans检验维度</td>
</tr>
<tr>
<td><strong>工作量域</strong></td>
<td>操作次数</td>
<td>单次操作行为(操作ID)</td>
<td>日期/操作类型/操作人员/工作内容</td>
<td>每次操作都是独立的工作量单元</td>
<td>新增工作量统计维度</td>
</tr>
<tr>
<td><strong>收入域</strong></td>
<td>收费金额</td>
<td>单笔收费记录(Fee_BillDet_BillDetID)</td>
<td>日期/收费项目/收费类型/科室</td>
<td>复用现有Fee_BillDet表，避免重复设计</td>
<td>直接复用Fee_BillDet</td>
</tr>
</tbody>
</table>
<h3 id="23-明细数据vs汇总数据设计原则">2.3 明细数据vs汇总数据设计原则 </h3>
<p><strong>明细数据表设计原则</strong>：</p>
<ul>
<li>基于业务最小粒度设计（单个样本、单个血袋、单次操作）</li>
<li>直接从DL层集成，支持多医院多院区统一管理</li>
<li>包含完整业务上下文信息，支持任意维度聚合</li>
<li>遵循现有DC架构的命名和字段标准</li>
</ul>
<p><strong>汇总数据表设计原则</strong>：</p>
<ul>
<li>基于DC明细数据按维度预聚合</li>
<li>提升查询性能，减少实时计算压力</li>
<li>支持常见分析场景的快速响应</li>
<li>数据源完全来自DC层，不直接依赖DL层</li>
</ul>
<h3 id="24-dc层设计优势">2.4 DC层设计优势 </h3>
<ul>
<li><strong>原子性</strong>：每个事实都可以拆解到最小业务单元，支持任意粒度聚合</li>
<li><strong>一致性</strong>：统一的数据模型确保跨域指标计算的准确性，与现有DC架构风格一致</li>
<li><strong>完整性</strong>：保留完整的业务上下文信息，支持复杂分析需求</li>
<li><strong>扩展性</strong>：标准化设计便于后续业务拓展和维护</li>
<li><strong>复用性</strong>：充分利用现有DC层表（如Fee_BillDet），避免重复建设</li>
</ul>
<h2 id="三-数据血缘关系设计">三、数据血缘关系设计 </h2>
<h3 id="31-dl层数据源已有">3.1 DL层数据源（已有） </h3>
<h4 id="311-输血管理系统表主要数据源">3.1.1 输血管理系统表（主要数据源） </h4>
<ul>
<li><strong>BIS_REQUISITION_INFO</strong>（申请单信息表）- 输血申请数据源，包含申请基础信息</li>
<li><strong>BIS_BLOOD_INPUT</strong>（血袋表）- 血液库存数据源，包含血袋入库出库信息</li>
<li><strong>BIS6_BLOODBAG_INPUT</strong>（血袋入库表）- 血库信息数据源，AREA_ID字段包含血库代码（A001本院/A002温江/A003天府/A004锦江）</li>
<li><strong>BIS_TAKE_BLOOD</strong>（取血表）- 血液发放数据源，包含血液配发记录</li>
<li><strong>BIS_TRANSBLOOD_PROCESS_LIST</strong>（输注记录表）- 输血执行数据源，包含输注过程记录</li>
</ul>
<h4 id="312-lis检验系统表关键数据源">3.1.2 LIS检验系统表（关键数据源） </h4>
<ul>
<li><strong>LIS_REQUISITION_INFO</strong>（样本信息主表）- 输血相关检验申请数据源</li>
<li><strong>LIS_REQUISITION_ITEM</strong>（样本项目明细表）- 血型检测、抗体筛查等项目数据源</li>
<li><strong>LIS_INSPECTION_RESULT</strong>（检验结果信息表）- 检验结果数据源，用于工作量统计</li>
</ul>
<h4 id="313-现有dc层表复用数据源">3.1.3 现有DC层表（复用数据源） </h4>
<ul>
<li><strong>Apply_BloodTrans</strong>（申请_输血表）- 已标准化的输血申请统一数据模型，可直接使用</li>
<li><strong>Fee_BillDet</strong>（费用_账单明细表）- 已标准化的收费数据模型，用于收入指标计算</li>
<li><strong>LIS_Sample_Main</strong>（检验标本主表）- 已标准化的检验标本数据模型，用于输血相关检验样本统计</li>
</ul>
<h4 id="314-其他系统表">3.1.4 其他系统表 </h4>
<ul>
<li><strong>HIS医嘱系统</strong>- 输血治疗项目数据源（血浆置换、血液单采等医嘱）</li>
<li><strong>血站系统</strong>- 血液成本数据源，用于血费支出计算</li>
<li><strong>试剂库系统</strong>- 试剂成本数据源，用于试剂支出计算</li>
</ul>
<h3 id="32-dc层设计符合现有dc架构风格">3.2 DC层设计（符合现有DC架构风格） </h3>
<h4 id="321-明细数据表设计dl-dc直接集成">3.2.1 明细数据表设计（DL-&gt;DC直接集成） </h4>
<h5 id="a-lis_sample_main检验标本主表复用lis主题">A. LIS_Sample_Main（检验标本主表）<strong>复用LIS主题</strong> </h5>
<p><strong>表设计说明</strong>：直接复用已有的LIS主题中的 <code>LIS_Sample_Main</code> 检验标本主表，该表已包含输血相关检验样本的完整信息。</p>
<p><strong>输血相关数据筛选条件</strong>：</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token comment">-- 筛选输血相关样本的条件</span>
<span class="token keyword keyword-WHERE">WHERE</span> LIS_Sample_Main_TestPurpose <span class="token operator">LIKE</span> <span class="token string">'%血型%'</span> 
   <span class="token operator">OR</span> LIS_Sample_Main_TestPurpose <span class="token operator">LIKE</span> <span class="token string">'%配血%'</span> 
   <span class="token operator">OR</span> LIS_Sample_Main_TestPurpose <span class="token operator">LIKE</span> <span class="token string">'%抗体%'</span>
   <span class="token operator">OR</span> LIS_Sample_Main_TestPurpose <span class="token operator">LIKE</span> <span class="token string">'%输血%'</span>
   <span class="token operator">OR</span> LIS_Sample_Main_ItemCode <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'LIS07068'</span><span class="token punctuation">,</span> <span class="token string">'LIS05'</span><span class="token punctuation">,</span> <span class="token string">'LIS07073'</span><span class="token punctuation">,</span> <span class="token string">'LIS07156'</span><span class="token punctuation">,</span> <span class="token string">'LIS07157'</span><span class="token punctuation">,</span> <span class="token string">'LIS07153'</span><span class="token punctuation">)</span>
</code></pre><p><strong>关键字段说明</strong>：</p>
<table>
<thead>
<tr>
<th>字段名</th>
<th>用途说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>LIS_Sample_Main_SampleID</td>
<td>样本ID，输血业务关联主键</td>
</tr>
<tr>
<td>LIS_Sample_Main_SampleDate</td>
<td>样本日期，用于日度汇总</td>
</tr>
<tr>
<td>LIS_Sample_Main_DeptName</td>
<td>申请科室，用于科室维度分析</td>
</tr>
<tr>
<td>LIS_Sample_Main_TestPurpose</td>
<td>检测目的，用于筛选输血相关样本</td>
</tr>
<tr>
<td>LIS_Sample_Main_ItemCode</td>
<td>项目代码，用于输血项目分类统计</td>
</tr>
</tbody>
</table>
<h5 id="b-bts_blood_detail血液明细表">B. BTS_Blood_Detail（血液明细表） </h5>
<p><strong>表设计目标</strong>：管理血液入库、出库、盘存等血袋维度的原子数据。</p>
<p><strong>字段映射关系</strong>：</p>
<table>
<thead>
<tr>
<th>DC字段名</th>
<th>字段类型</th>
<th>主要数据源</th>
<th>字段说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>BTS_Blood_Detail_BloodID</td>
<td>VARCHAR(60)</td>
<td>BIS_BLOOD_INPUT.blood_id</td>
<td>血液ID（主键）</td>
</tr>
<tr>
<td>BTS_Blood_Detail_BloodBagNo</td>
<td>VARCHAR(60)</td>
<td>BIS_BLOOD_INPUT.blood_bag_no</td>
<td>血袋编号</td>
</tr>
<tr>
<td>BTS_Blood_Detail_BloodDate</td>
<td>VARCHAR(10)</td>
<td>BIS_BLOOD_INPUT.blood_date</td>
<td>血液日期(YYYYMMDD)</td>
</tr>
<tr>
<td>BTS_Blood_Detail_BloodTypeName</td>
<td>VARCHAR(100)</td>
<td>BIS_BLOOD_INPUT.blood_type_name</td>
<td>血液类型名称</td>
</tr>
<tr>
<td>BTS_Blood_Detail_BloodVolume</td>
<td>FLOAT8</td>
<td>BIS_BLOOD_INPUT.blood_volume</td>
<td>血液容量(毫升)</td>
</tr>
<tr>
<td>BTS_Blood_Detail_BloodABOName</td>
<td>VARCHAR(100)</td>
<td>BIS_BLOOD_INPUT.blood_abo</td>
<td>ABO血型名称</td>
</tr>
<tr>
<td>BTS_Blood_Detail_BloodRhName</td>
<td>VARCHAR(100)</td>
<td>BIS_BLOOD_INPUT.blood_rh</td>
<td>Rh血型名称</td>
</tr>
<tr>
<td>BTS_Blood_Detail_BloodStatusName</td>
<td>VARCHAR(100)</td>
<td>BIS_BLOOD_INPUT.blood_status</td>
<td>血液状态名称</td>
</tr>
<tr>
<td>BTS_Blood_Detail_BloodBankCode</td>
<td>VARCHAR(60)</td>
<td>BIS6_BLOODBAG_INPUT.AREA_ID</td>
<td>血库代码：A001本院/A002温江/A003天府/A004锦江</td>
</tr>
<tr>
<td>BTS_Blood_Detail_BloodBankName</td>
<td>VARCHAR(100)</td>
<td>映射转换</td>
<td>血库名称（通过代码转换）</td>
</tr>
<tr>
<td>BTS_Blood_Detail_BloodSource</td>
<td>VARCHAR(100)</td>
<td>BIS_BLOOD_INPUT.blood_source</td>
<td>血液来源</td>
</tr>
<tr>
<td>BTS_Blood_Detail_OperationType</td>
<td>VARCHAR(60)</td>
<td>BIS_BLOOD_INPUT.operation_type</td>
<td>操作类型(入库/出库/盘存)</td>
</tr>
</tbody>
</table>
<p><strong>建表语句</strong>：</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token comment">-- 血液明细表</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-TABLE">TABLE</span> BTS_Blood_Detail <span class="token punctuation">(</span>
    <span class="token comment">-- 基础标识信息</span>
    BTS_Blood_Detail_MedOrgCode <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>       <span class="token comment">-- 医疗机构代码</span>
    BTS_Blood_Detail_BloodID <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span> <span class="token keyword keyword-PRIMARY">PRIMARY</span> <span class="token keyword keyword-KEY">KEY</span><span class="token punctuation">,</span>       <span class="token comment">-- 血液ID</span>
    BTS_Blood_Detail_BloodBagNo <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token comment">-- 血袋编号</span>
    BTS_Blood_Detail_BloodDate <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                 <span class="token comment">-- 血液日期(YYYYMMDD)</span>
    
    <span class="token comment">-- 血液属性</span>
    BTS_Blood_Detail_BloodTypeName <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token comment">-- 血液类型名称</span>
    BTS_Blood_Detail_BloodVolume FLOAT8<span class="token punctuation">,</span>                    <span class="token comment">-- 血液容量(毫升)</span>
    BTS_Blood_Detail_BloodABOName <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>             <span class="token comment">-- ABO血型名称</span>
    BTS_Blood_Detail_BloodRhName <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>              <span class="token comment">-- Rh血型名称</span>
    BTS_Blood_Detail_BloodStatusName <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>          <span class="token comment">-- 血液状态名称</span>
    
    <span class="token comment">-- 血库信息</span>
    BTS_Blood_Detail_BloodBankCode <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">,</span>             <span class="token comment">-- 血库代码</span>
    BTS_Blood_Detail_BloodBankName <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token comment">-- 血库名称</span>
    
    <span class="token comment">-- 时间信息</span>
    BTS_Blood_Detail_InboundDtTm <span class="token keyword keyword-timestamp">timestamp</span><span class="token punctuation">,</span>                 <span class="token comment">-- 入库时间</span>
    BTS_Blood_Detail_OutboundDtTm <span class="token keyword keyword-timestamp">timestamp</span><span class="token punctuation">,</span>                <span class="token comment">-- 出库时间</span>
    BTS_Blood_Detail_ExpireDtTm <span class="token keyword keyword-timestamp">timestamp</span><span class="token punctuation">,</span>                  <span class="token comment">-- 过期时间</span>
    
    <span class="token comment">-- 业务信息</span>
    BTS_Blood_Detail_BloodSource <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>              <span class="token comment">-- 血液来源</span>
    BTS_Blood_Detail_OperationType <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">,</span>             <span class="token comment">-- 操作类型(入库/出库/盘存)</span>
    
    <span class="token comment">-- 数据管理字段</span>
    BTS_Blood_Detail_DataSourceFlag <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token comment">-- 数据来源标识</span>
    BTS_Blood_Detail_IsDeleted INT8 <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>              <span class="token comment">-- 删除标识</span>
    BTS_Blood_Detail_LastUpdateDtTm <span class="token keyword keyword-timestamp">timestamp</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">-- 最后更新时间</span>
    BTS_Blood_Detail_DataCreateDtTm <span class="token keyword keyword-timestamp">timestamp</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">-- 数据创建时间</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h5 id="c-bts_work_record工作量记录表">C. BTS_Work_Record（工作量记录表） </h5>
<p><strong>表设计目标</strong>：记录四大类工作量的操作维度原子数据。</p>
<p><strong>建表语句</strong>：</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token comment">-- 工作量记录表</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-TABLE">TABLE</span> BTS_Work_Record <span class="token punctuation">(</span>
    <span class="token comment">-- 基础标识信息</span>
    BTS_Work_Record_MedOrgCode <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>        <span class="token comment">-- 医疗机构代码</span>
    BTS_Work_Record_WorkID <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span> <span class="token keyword keyword-PRIMARY">PRIMARY</span> <span class="token keyword keyword-KEY">KEY</span><span class="token punctuation">,</span>         <span class="token comment">-- 工作记录ID</span>
    BTS_Work_Record_WorkDate <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                   <span class="token comment">-- 工作日期(YYYYMMDD)</span>
    
    <span class="token comment">-- 工作分类</span>
    BTS_Work_Record_WorkCategoryCode <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">,</span>           <span class="token comment">-- 工作类别代码</span>
    BTS_Work_Record_WorkCategoryName <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>          <span class="token comment">-- 工作类别名称</span>
    BTS_Work_Record_WorkTypeCode <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">,</span>               <span class="token comment">-- 工作类型代码</span>
    BTS_Work_Record_WorkTypeName <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>              <span class="token comment">-- 工作类型名称</span>
    BTS_Work_Record_WorkCount INT8 <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token number">1</span><span class="token punctuation">,</span>               <span class="token comment">-- 工作量计数</span>
    
    <span class="token comment">-- 关联信息</span>
    BTS_Work_Record_RelatedID <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                  <span class="token comment">-- 关联业务ID</span>
    BTS_Work_Record_RelatedType <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token comment">-- 关联业务类型</span>
    
    <span class="token comment">-- 科室人员信息</span>
    BTS_Work_Record_DeptName <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                  <span class="token comment">-- 科室名称</span>
    BTS_Work_Record_OperatorName <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>              <span class="token comment">-- 操作人员姓名</span>
    BTS_Work_Record_WorkDtTm <span class="token keyword keyword-timestamp">timestamp</span><span class="token punctuation">,</span>                     <span class="token comment">-- 工作时间</span>
    
    <span class="token comment">-- 数据管理字段</span>
    BTS_Work_Record_DataSourceFlag <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>             <span class="token comment">-- 数据来源标识</span>
    BTS_Work_Record_IsDeleted INT8 <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>               <span class="token comment">-- 删除标识</span>
    BTS_Work_Record_LastUpdateDtTm <span class="token keyword keyword-timestamp">timestamp</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">-- 最后更新时间</span>
    BTS_Work_Record_DataCreateDtTm <span class="token keyword keyword-timestamp">timestamp</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">-- 数据创建时间</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><pre class="language-text">BTS_Requisition_Main_ExtNum1 FLOAT8,                         -- 扩展7(数值类型)
BTS_Requisition_Main_ExtNum2 FLOAT8,                         -- 扩展8(数值类型)
BTS_Requisition_Main_ExtDate1 timestamp,                     -- 扩展9(时间类型)
BTS_Requisition_Main_ExtDate2 timestamp,                     -- 扩展10(时间类型)

-- 数据管理字段
BTS_Requisition_Main_DataSourceFlag VARCHAR(10),             -- 数据来源标识
BTS_Requisition_Main_DSTable VARCHAR(60),                    -- 接入数据源的表
BTS_Requisition_Main_DSTableKey VARCHAR(200),                -- 接入数据源的key
BTS_Requisition_Main_DSTableValue VARCHAR(200),              -- 接入数据源的key值
BTS_Requisition_Main_IsDeleted INT8 DEFAULT 0,               -- 数据物理删除标识
BTS_Requisition_Main_LastUpdateDtTm timestamp DEFAULT GETDATE(), -- 最后更新时间
BTS_Requisition_Main_DataCreateDtTm timestamp DEFAULT GETDATE()  -- 数据创建时间
</pre>
<p>);</p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>#### 3.2.2 汇总数据表设计（DC明细表-&gt;DC汇总表）

##### D. BTS_Daily_Summary（输血日度汇总大宽表）**新增**

**表设计目标**：基于DC明细表按日期、科室、血库、血液类型等维度的综合汇总大宽表，包含样本、检测、工作量、收入、支出等全维度指标。

**建表语句**：
```sql
-- 输血日度汇总大宽表
CREATE TABLE BTS_Daily_Summary (
    -- 基础标识信息
    BTS_Daily_Summary_MedOrgCode VARCHAR(60) NOT NULL,           -- 医疗机构代码
    BTS_Daily_Summary_SummaryID VARCHAR(60) PRIMARY KEY,         -- 汇总ID
    BTS_Daily_Summary_SummaryDate VARCHAR(10),                   -- 汇总日期(YYYYMMDD)
    
    -- 维度信息
    BTS_Daily_Summary_DeptName VARCHAR(100),                     -- 科室名称
    BTS_Daily_Summary_BloodBankCode VARCHAR(60),                 -- 血库代码
    BTS_Daily_Summary_BloodBankName VARCHAR(100),                -- 血库名称
    BTS_Daily_Summary_BloodTypeName VARCHAR(100),                -- 血液类型名称
    
    -- 核心指标汇总
    BTS_Daily_Summary_SampleCount INT8 DEFAULT 0,                -- 样本数量
    BTS_Daily_Summary_TestCount INT8 DEFAULT 0,                  -- 检测项目数
    BTS_Daily_Summary_BloodInCount INT8 DEFAULT 0,               -- 血液入库数
    BTS_Daily_Summary_BloodOutCount INT8 DEFAULT 0,              -- 血液出库数
    BTS_Daily_Summary_BloodInventoryCount INT8 DEFAULT 0,        -- 当日血液库存数
    
    -- 九大检测项目明细
    BTS_Daily_Summary_BloodTypeTestCount INT8 DEFAULT 0,         -- 血型检测数
    BTS_Daily_Summary_AntibodyScreenCount INT8 DEFAULT 0,        -- 抗体筛查数
    BTS_Daily_Summary_CrossMatchCount INT8 DEFAULT 0,            -- 交叉配血数
    BTS_Daily_Summary_DirectAntiGlobulinCount INT8 DEFAULT 0,    -- 直接抗人球蛋白试验数
    BTS_Daily_Summary_DifficultSampleCount INT8 DEFAULT 0,       -- 疑难样本数
    BTS_Daily_Summary_PlateletCrossMatchCount INT8 DEFAULT 0,    -- 血小板交叉配血数
    BTS_Daily_Summary_PlateletAntibodyCount INT8 DEFAULT 0,      -- 血小板抗体检测数
    BTS_Daily_Summary_AntibodyTiterCount INT8 DEFAULT 0,         -- 抗体效价数
    BTS_Daily_Summary_RhTypingCount INT8 DEFAULT 0,              -- Rh分型数
    
    -- 四大类工作量汇总
    BTS_Daily_Summary_SampleWorkCount INT8 DEFAULT 0,            -- 样本检测工作量
    BTS_Daily_Summary_BloodWorkCount INT8 DEFAULT 0,             -- 临床用血工作量
    BTS_Daily_Summary_TreatmentWorkCount INT8 DEFAULT 0,         -- 输血治疗工作量
    BTS_Daily_Summary_ManageWorkCount INT8 DEFAULT 0,            -- 血液管理工作量
    BTS_Daily_Summary_TotalWorkCount INT8 DEFAULT 0,             -- 总工作量
    
    -- 临床用血工作量明细
    BTS_Daily_Summary_BloodReserveCount INT8 DEFAULT 0,          -- 血液预约次数
    BTS_Daily_Summary_BloodThawCount INT8 DEFAULT 0,             -- 血浆/冷沉淀融化数
    BTS_Daily_Summary_WeekendWorkCount INT8 DEFAULT 0,           -- 周六加班手术台次
    
    -- 输血治疗工作量明细
    BTS_Daily_Summary_WholeBloodCollectionCount INT8 DEFAULT 0,  -- 全血采集次数
    BTS_Daily_Summary_PlasmaExchangeCount INT8 DEFAULT 0,        -- 血浆置换次数
    BTS_Daily_Summary_ApheresisCount INT8 DEFAULT 0,             -- 血液单采次数
    
    -- 三类收入汇总
    BTS_Daily_Summary_TestIncome FLOAT8 DEFAULT 0,               -- 配血检收入
    BTS_Daily_Summary_BloodIncome FLOAT8 DEFAULT 0,              -- 血费收入
    BTS_Daily_Summary_TreatmentIncome FLOAT8 DEFAULT 0,          -- 输血治疗收入
    BTS_Daily_Summary_TotalIncome FLOAT8 DEFAULT 0,              -- 总收入
    
    -- 支出汇总
    BTS_Daily_Summary_BloodCost FLOAT8 DEFAULT 0,                -- 血费支出
    BTS_Daily_Summary_ReagentCost FLOAT8 DEFAULT 0,              -- 试剂支出
    BTS_Daily_Summary_TotalCost FLOAT8 DEFAULT 0,                -- 总支出
    
    -- 环比数据（与前一日对比）
    BTS_Daily_Summary_SampleCountDoD INT8,                       -- 样本数日环比
    BTS_Daily_Summary_TestCountDoD INT8,                         -- 检测项目数日环比
    BTS_Daily_Summary_WorkCountDoD INT8,                         -- 工作量日环比
    BTS_Daily_Summary_IncomeDoD FLOAT8,                          -- 收入日环比
    
    -- 同期对比数据（与去年同日对比）
    BTS_Daily_Summary_SampleCountYoY INT8,                       -- 样本数年同比
    BTS_Daily_Summary_TestCountYoY INT8,                         -- 检测项目数年同比
    BTS_Daily_Summary_WorkCountYoY INT8,                         -- 工作量年同比
    BTS_Daily_Summary_IncomeYoY FLOAT8,                          -- 收入年同比
    
    -- 数据管理字段
    BTS_Daily_Summary_DataSourceFlag VARCHAR(10),                -- 数据来源标识
    BTS_Daily_Summary_IsDeleted INT8 DEFAULT 0,                  -- 删除标识
    BTS_Daily_Summary_LastUpdateDtTm timestamp DEFAULT GETDATE(), -- 最后更新时间
    BTS_Daily_Summary_DataCreateDtTm timestamp DEFAULT GETDATE()  -- 数据创建时间
);
</code></pre><h5>E. BTS_BloodStock_Monthly（血液库存月度汇总表）<strong>新增</strong></h5>
<p><strong>表设计目标</strong>：专门针对血液库存数据的月度汇总分析，支持库存周转率、有效期管理等关键指标。</p>
<p><strong>建表语句</strong>：</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token comment">-- 血液库存月度汇总表</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-TABLE">TABLE</span> BTS_BloodStock_Monthly <span class="token punctuation">(</span>
    <span class="token comment">-- 基础标识信息</span>
    BTS_BloodStock_Monthly_MedOrgCode <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>      <span class="token comment">-- 医疗机构代码</span>
    BTS_BloodStock_Monthly_SummaryID <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span> <span class="token keyword keyword-PRIMARY">PRIMARY</span> <span class="token keyword keyword-KEY">KEY</span><span class="token punctuation">,</span>    <span class="token comment">-- 汇总ID</span>
    BTS_BloodStock_Monthly_SummaryYearMonth <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>          <span class="token comment">-- 汇总年月(YYYYMM)</span>
    
    <span class="token comment">-- 维度信息</span>
    BTS_BloodStock_Monthly_BloodBankCode <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token comment">-- 血库代码</span>
    BTS_BloodStock_Monthly_BloodBankName <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>           <span class="token comment">-- 血库名称</span>
    BTS_BloodStock_Monthly_BloodTypeName <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>           <span class="token comment">-- 血液类型名称</span>
    BTS_BloodStock_Monthly_BloodABOName <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token comment">-- ABO血型名称</span>
    BTS_BloodStock_Monthly_BloodRhName <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>             <span class="token comment">-- Rh血型名称</span>
    
    <span class="token comment">-- 库存核心指标</span>
    BTS_BloodStock_Monthly_BeginInventory INT8 <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>        <span class="token comment">-- 期初库存数</span>
    BTS_BloodStock_Monthly_EndInventory INT8 <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>          <span class="token comment">-- 期末库存数</span>
    BTS_BloodStock_Monthly_AvgInventory INT8 <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>          <span class="token comment">-- 平均库存数</span>
    BTS_BloodStock_Monthly_MaxInventory INT8 <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>          <span class="token comment">-- 最大库存数</span>
    BTS_BloodStock_Monthly_MinInventory INT8 <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>          <span class="token comment">-- 最小库存数</span>
    
    <span class="token comment">-- 库存流转指标</span>
    BTS_BloodStock_Monthly_TotalInbound INT8 <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>          <span class="token comment">-- 月度入库总数</span>
    BTS_BloodStock_Monthly_TotalOutbound INT8 <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>         <span class="token comment">-- 月度出库总数</span>
    BTS_BloodStock_Monthly_TotalExpired INT8 <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>          <span class="token comment">-- 月度过期数</span>
    BTS_BloodStock_Monthly_TotalWaste INT8 <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>            <span class="token comment">-- 月度废血数</span>
    
    <span class="token comment">-- 库存周转率指标</span>
    BTS_BloodStock_Monthly_TurnoverRate FLOAT8 <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>        <span class="token comment">-- 库存周转率</span>
    BTS_BloodStock_Monthly_TurnoverDays FLOAT8 <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>        <span class="token comment">-- 库存周转天数</span>
    
    <span class="token comment">-- 库存结构分析</span>
    BTS_BloodStock_Monthly_Normal_Count INT8 <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>          <span class="token comment">-- 正常库存数</span>
    BTS_BloodStock_Monthly_NearExpiry_Count INT8 <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>      <span class="token comment">-- 近效期库存数(7天内)</span>
    BTS_BloodStock_Monthly_Expired_Count INT8 <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>         <span class="token comment">-- 过期库存数</span>
    
    <span class="token comment">-- 库存金额指标</span>
    BTS_BloodStock_Monthly_InventoryValue FLOAT8 <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>      <span class="token comment">-- 库存总价值</span>
    BTS_BloodStock_Monthly_ExpiredValue FLOAT8 <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>        <span class="token comment">-- 过期损失金额</span>
    BTS_BloodStock_Monthly_WasteValue FLOAT8 <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>          <span class="token comment">-- 废血损失金额</span>
    
    <span class="token comment">-- 环比指标</span>
    BTS_BloodStock_Monthly_InventoryMoM FLOAT8<span class="token punctuation">,</span>                  <span class="token comment">-- 库存数环比变化率</span>
    BTS_BloodStock_Monthly_TurnoverMoM FLOAT8<span class="token punctuation">,</span>                   <span class="token comment">-- 周转率环比变化率</span>
    BTS_BloodStock_Monthly_ExpiredMoM FLOAT8<span class="token punctuation">,</span>                    <span class="token comment">-- 过期率环比变化率</span>
    
    <span class="token comment">-- 同比指标</span>
    BTS_BloodStock_Monthly_InventoryYoY FLOAT8<span class="token punctuation">,</span>                  <span class="token comment">-- 库存数同比变化率</span>
    BTS_BloodStock_Monthly_TurnoverYoY FLOAT8<span class="token punctuation">,</span>                   <span class="token comment">-- 周转率同比变化率</span>
    BTS_BloodStock_Monthly_ExpiredYoY FLOAT8<span class="token punctuation">,</span>                    <span class="token comment">-- 过期率同比变化率</span>
    
    <span class="token comment">-- 数据管理字段</span>
    BTS_BloodStock_Monthly_DataSourceFlag <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>           <span class="token comment">-- 数据来源标识</span>
    BTS_BloodStock_Monthly_IsDeleted INT8 <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>             <span class="token comment">-- 删除标识</span>
    BTS_BloodStock_Monthly_LastUpdateDtTm <span class="token keyword keyword-timestamp">timestamp</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">-- 最后更新时间</span>
    BTS_BloodStock_Monthly_DataCreateDtTm <span class="token keyword keyword-timestamp">timestamp</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">-- 数据创建时间</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h3>3.3 MDR层设计（DC-&gt;MDR主题集市）</h3>
<p>基于DC层的汇总数据直接构建分析主题，无需独立的MDR层表结构：</p>
<ul>
<li><strong>BTS_Daily_Summary</strong> 日度汇总大宽表直接支持多维度分析查询</li>
<li><strong>BTS_BloodStock_Monthly</strong> 血液库存月度表专门支持库存管理分析</li>
<li><strong>LIS_Sample_Main</strong> 检验样本表提供明细查询支持</li>
</ul>
<p><strong>主题查询示例</strong>：</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token comment">-- 输血科综合运营分析主题查询</span>
<span class="token keyword keyword-SELECT">SELECT</span> 
    BTS_Daily_Summary_SummaryDate<span class="token punctuation">,</span>
    BTS_Daily_Summary_BloodBankName<span class="token punctuation">,</span>
    <span class="token function">SUM</span><span class="token punctuation">(</span>BTS_Daily_Summary_SampleCount<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> total_samples<span class="token punctuation">,</span>
    <span class="token function">SUM</span><span class="token punctuation">(</span>BTS_Daily_Summary_TestCount<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> total_tests<span class="token punctuation">,</span>
    <span class="token function">SUM</span><span class="token punctuation">(</span>BTS_Daily_Summary_TotalWorkCount<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> total_workload<span class="token punctuation">,</span>
    <span class="token function">SUM</span><span class="token punctuation">(</span>BTS_Daily_Summary_TotalIncome<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> total_income<span class="token punctuation">,</span>
    <span class="token function">SUM</span><span class="token punctuation">(</span>BTS_Daily_Summary_TotalCost<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> total_cost
<span class="token keyword keyword-FROM">FROM</span> BTS_Daily_Summary
<span class="token keyword keyword-WHERE">WHERE</span> BTS_Daily_Summary_SummaryDate <span class="token operator">BETWEEN</span> <span class="token string">'20240801'</span> <span class="token operator">AND</span> <span class="token string">'20240831'</span>
<span class="token keyword keyword-GROUP">GROUP</span> <span class="token keyword keyword-BY">BY</span> BTS_Daily_Summary_SummaryDate<span class="token punctuation">,</span> BTS_Daily_Summary_BloodBankName
<span class="token keyword keyword-ORDER">ORDER</span> <span class="token keyword keyword-BY">BY</span> BTS_Daily_Summary_SummaryDate<span class="token punctuation">;</span>
</code></pre><pre class="language-text">MDR_BTS_Monthly_Summary_YoYTestCount INT8,                   -- 去年同期检测项目数
MDR_BTS_Monthly_Summary_YoYWorkCount INT8,                   -- 去年同期工作量
MDR_BTS_Monthly_Summary_YoYBloodIncome FLOAT8,               -- 去年同期血液收入
MDR_BTS_Monthly_Summary_YoYReagentCost FLOAT8,               -- 去年同期试剂支出
MDR_BTS_Monthly_Summary_YoYTotalIncome FLOAT8,               -- 去年同期总收入

-- 同比变化率
MDR_BTS_Monthly_Summary_SampleCountYoYRate FLOAT8,           -- 样本数同比变化率
MDR_BTS_Monthly_Summary_TestCountYoYRate FLOAT8,             -- 检测项目数同比变化率
MDR_BTS_Monthly_Summary_WorkCountYoYRate FLOAT8,             -- 工作量同比变化率
MDR_BTS_Monthly_Summary_BloodIncomeYoYRate FLOAT8,           -- 血液收入同比变化率
MDR_BTS_Monthly_Summary_ReagentCostYoYRate FLOAT8,           -- 试剂支出同比变化率
MDR_BTS_Monthly_Summary_TotalIncomeYoYRate FLOAT8,           -- 总收入同比变化率

-- 细分工作量指标
MDR_BTS_Monthly_Summary_BloodTestWorkCount INT8,             -- 血型检测工作量
MDR_BTS_Monthly_Summary_AntibodyScreenWorkCount INT8,        -- 抗体筛查工作量
MDR_BTS_Monthly_Summary_CrossMatchWorkCount INT8,            -- 交叉配血工作量
MDR_BTS_Monthly_Summary_BloodReserveWorkCount INT8,          -- 血液预约工作量
MDR_BTS_Monthly_Summary_BloodInOutWorkCount INT8,            -- 血液出入库工作量
MDR_BTS_Monthly_Summary_BloodInventoryWorkCount INT8,        -- 血液盘存工作量
MDR_BTS_Monthly_Summary_TreatmentProcedureWorkCount INT8,    -- 输血治疗操作工作量
MDR_BTS_Monthly_Summary_BloodManageWorkCount INT8,           -- 血液管理工作量

-- 备注字段
MDR_BTS_Monthly_Summary_AnalysisNote VARCHAR(500),           -- 分析备注
MDR_BTS_Monthly_Summary_RemarkInfo VARCHAR(500),             -- 备注信息

-- 数据管理字段
MDR_BTS_Monthly_Summary_DataSourceFlag VARCHAR(10),          -- 数据来源标识
MDR_BTS_Monthly_Summary_IsDeleted INT8 DEFAULT 0,            -- 数据物理删除标识
MDR_BTS_Monthly_Summary_LastUpdateDtTm timestamp DEFAULT GETDATE(), -- 最后更新时间
MDR_BTS_Monthly_Summary_DataCreateDtTm timestamp DEFAULT GETDATE()  -- 数据创建时间
</pre>
<p>);</p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>## 四、数据处理逻辑设计 {#四-数据处理逻辑设计 }

### 4.1 DL-&gt;DC数据集成逻辑 {#41-dl-dc数据集成逻辑 }

#### 4.1.1 输血申请数据集成（BIS_REQUISITION_INFO -&gt; BTS_Requisition_Main） {#411-输血申请数据集成bis_requisition_info---bts_requisition_main }

```sql
-- 输血申请数据集成示例SQL
INSERT INTO BTS_Requisition_Main (
    BTS_Requisition_Main_MedOrgCode,
    BTS_Requisition_Main_ApplyID,
    BTS_Requisition_Main_ApplyDate,
    BTS_Requisition_Main_PersID,
    BTS_Requisition_Main_VisitID,
    BTS_Requisition_Main_DeptName,
    BTS_Requisition_Main_BloodTypeABOName,
    BTS_Requisition_Main_BloodTypeRhName,
    BTS_Requisition_Main_BloodPurpose,
    BTS_Requisition_Main_ApplyPersName,
    BTS_Requisition_Main_ApplyDtTm,
    BTS_Requisition_Main_ApplyStatusName,
    BTS_Requisition_Main_DataSourceFlag,
    BTS_Requisition_Main_DSTable
)
SELECT 
    hospital_id,
    requisition_id,
    FORMAT(apply_date, 'yyyyMMdd'),
    patient_id,
    visit_id,
    apply_dept_name,
    blood_type_abo,
    blood_type_rh,
    blood_purpose,
    apply_doctor,
    apply_time,
    apply_status,
    'BIS',
    'BIS_REQUISITION_INFO'
FROM BIS_REQUISITION_INFO
WHERE apply_date &gt;= DATEADD(month, -13, GETDATE());
</code></pre><h4 id="412-血液数据集成bis_blood_input---bts_blood_detail">4.1.2 血液数据集成（BIS_BLOOD_INPUT -&gt; BTS_Blood_Detail） </h4>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token comment">-- 血液数据集成示例SQL  </span>
<span class="token keyword keyword-INSERT">INSERT</span> <span class="token keyword keyword-INTO">INTO</span> BTS_Blood_Detail <span class="token punctuation">(</span>
    BTS_Blood_Detail_MedOrgCode<span class="token punctuation">,</span>
    BTS_Blood_Detail_BloodID<span class="token punctuation">,</span>
    BTS_Blood_Detail_BloodBagNo<span class="token punctuation">,</span>
    BTS_Blood_Detail_BloodDate<span class="token punctuation">,</span>
    BTS_Blood_Detail_BloodTypeName<span class="token punctuation">,</span>
    BTS_Blood_Detail_BloodVolume<span class="token punctuation">,</span>
    BTS_Blood_Detail_BloodABOName<span class="token punctuation">,</span>
    BTS_Blood_Detail_BloodRhName<span class="token punctuation">,</span>
    BTS_Blood_Detail_BloodStatusName<span class="token punctuation">,</span>
    BTS_Blood_Detail_BloodBankCode<span class="token punctuation">,</span>
    BTS_Blood_Detail_BloodBankName<span class="token punctuation">,</span>
    BTS_Blood_Detail_InboundDtTm<span class="token punctuation">,</span>
    BTS_Blood_Detail_OutboundDtTm<span class="token punctuation">,</span>
    BTS_Blood_Detail_BloodSource<span class="token punctuation">,</span>
    BTS_Blood_Detail_DataSourceFlag<span class="token punctuation">,</span>
    BTS_Blood_Detail_DSTable
<span class="token punctuation">)</span>
<span class="token keyword keyword-SELECT">SELECT</span> 
    bi<span class="token punctuation">.</span>hospital_id<span class="token punctuation">,</span>
    bi<span class="token punctuation">.</span>blood_id<span class="token punctuation">,</span>
    bi<span class="token punctuation">.</span>blood_bag_no<span class="token punctuation">,</span>
    <span class="token function">FORMAT</span><span class="token punctuation">(</span>bi<span class="token punctuation">.</span>blood_date<span class="token punctuation">,</span> <span class="token string">'yyyyMMdd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    bi<span class="token punctuation">.</span>blood_type_name<span class="token punctuation">,</span>
    bi<span class="token punctuation">.</span>blood_volume<span class="token punctuation">,</span>
    bi<span class="token punctuation">.</span>blood_abo<span class="token punctuation">,</span>
    bi<span class="token punctuation">.</span>blood_rh<span class="token punctuation">,</span>
    bi<span class="token punctuation">.</span>blood_status<span class="token punctuation">,</span>
    bb<span class="token punctuation">.</span>AREA_ID<span class="token punctuation">,</span>  <span class="token comment">-- 血库代码</span>
    <span class="token keyword keyword-CASE">CASE</span> bb<span class="token punctuation">.</span>AREA_ID
        <span class="token keyword keyword-WHEN">WHEN</span> <span class="token string">'A001'</span> <span class="token keyword keyword-THEN">THEN</span> <span class="token string">'本院'</span>
        <span class="token keyword keyword-WHEN">WHEN</span> <span class="token string">'A002'</span> <span class="token keyword keyword-THEN">THEN</span> <span class="token string">'温江'</span>
        <span class="token keyword keyword-WHEN">WHEN</span> <span class="token string">'A003'</span> <span class="token keyword keyword-THEN">THEN</span> <span class="token string">'天府'</span>
        <span class="token keyword keyword-WHEN">WHEN</span> <span class="token string">'A004'</span> <span class="token keyword keyword-THEN">THEN</span> <span class="token string">'锦江'</span>
        <span class="token keyword keyword-ELSE">ELSE</span> <span class="token string">'未知'</span>
    <span class="token keyword keyword-END">END</span> <span class="token keyword keyword-AS">AS</span> blood_bank_name<span class="token punctuation">,</span>  <span class="token comment">-- 血库名称映射</span>
    bi<span class="token punctuation">.</span>inbound_time<span class="token punctuation">,</span>
    bi<span class="token punctuation">.</span>outbound_time<span class="token punctuation">,</span>
    bi<span class="token punctuation">.</span>blood_source<span class="token punctuation">,</span>
    <span class="token string">'BIS'</span><span class="token punctuation">,</span>
    <span class="token string">'BIS_BLOOD_INPUT'</span>
<span class="token keyword keyword-FROM">FROM</span> BIS_BLOOD_INPUT bi
<span class="token keyword keyword-LEFT">LEFT</span> <span class="token keyword keyword-JOIN">JOIN</span> BIS6_BLOODBAG_INPUT bb <span class="token keyword keyword-ON">ON</span> bi<span class="token punctuation">.</span>blood_bag_no <span class="token operator">=</span> bb<span class="token punctuation">.</span>blood_bag_no
<span class="token keyword keyword-WHERE">WHERE</span> bi<span class="token punctuation">.</span>blood_date <span class="token operator">&gt;=</span> DATEADD<span class="token punctuation">(</span><span class="token keyword keyword-month">month</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">13</span><span class="token punctuation">,</span> GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h3 id="42-dc-mdr数据聚合逻辑">4.2 DC-&gt;MDR数据聚合逻辑 </h3>
<h4 id="421-日度汇总数据生成">4.2.1 日度汇总数据生成 </h4>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token comment">-- 日度汇总数据生成示例SQL</span>
<span class="token keyword keyword-INSERT">INSERT</span> <span class="token keyword keyword-INTO">INTO</span> BTS_Daily_Summary <span class="token punctuation">(</span>
    BTS_Daily_Summary_SummaryID<span class="token punctuation">,</span>
    BTS_Daily_Summary_SummaryDate<span class="token punctuation">,</span>
    BTS_Daily_Summary_DeptName<span class="token punctuation">,</span>
    BTS_Daily_Summary_BloodTypeName<span class="token punctuation">,</span>
    BTS_Daily_Summary_ApplyCount<span class="token punctuation">,</span>
    BTS_Daily_Summary_SampleCount<span class="token punctuation">,</span>
    BTS_Daily_Summary_TestCount<span class="token punctuation">,</span>
    BTS_Daily_Summary_BloodIncome<span class="token punctuation">,</span>
    BTS_Daily_Summary_TotalIncome
<span class="token punctuation">)</span>
<span class="token keyword keyword-SELECT">SELECT</span> 
    CONCAT<span class="token punctuation">(</span>req<span class="token punctuation">.</span>Apply_BloodTrans_ApplyDate<span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>Apply_BloodTrans_DeptID<span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>Apply_BloodTrans_BloodTypeCode<span class="token punctuation">)</span><span class="token punctuation">,</span>
    req<span class="token punctuation">.</span>Apply_BloodTrans_ApplyDate<span class="token punctuation">,</span>
    req<span class="token punctuation">.</span>Apply_BloodTrans_DeptName<span class="token punctuation">,</span>
    req<span class="token punctuation">.</span>Apply_BloodTrans_BloodTypeABOName<span class="token punctuation">,</span>
    <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword keyword-DISTINCT">DISTINCT</span> req<span class="token punctuation">.</span>Apply_BloodTrans_ApplyID<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> apply_count<span class="token punctuation">,</span>
    <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword keyword-DISTINCT">DISTINCT</span> blood<span class="token punctuation">.</span>BTS_Blood_Detail_BloodID<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> sample_count<span class="token punctuation">,</span>
    <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword keyword-DISTINCT">DISTINCT</span> test<span class="token punctuation">.</span>BTS_Lab_Test_TestID<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> test_count<span class="token punctuation">,</span>
    <span class="token function">SUM</span><span class="token punctuation">(</span>income<span class="token punctuation">.</span>blood_income<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> blood_income<span class="token punctuation">,</span>
    <span class="token function">SUM</span><span class="token punctuation">(</span>income<span class="token punctuation">.</span>total_income<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> total_income
<span class="token keyword keyword-FROM">FROM</span> Apply_BloodTrans req
<span class="token keyword keyword-LEFT">LEFT</span> <span class="token keyword keyword-JOIN">JOIN</span> BTS_Blood_Detail blood <span class="token keyword keyword-ON">ON</span> req<span class="token punctuation">.</span>Apply_BloodTrans_ApplyID <span class="token operator">=</span> blood<span class="token punctuation">.</span>关联申请ID
<span class="token keyword keyword-LEFT">LEFT</span> <span class="token keyword keyword-JOIN">JOIN</span> LIS_Sample_Main test <span class="token keyword keyword-ON">ON</span> req<span class="token punctuation">.</span>Apply_BloodTrans_ApplyID <span class="token operator">=</span> test<span class="token punctuation">.</span>关联申请ID  
<span class="token keyword keyword-LEFT">LEFT</span> <span class="token keyword keyword-JOIN">JOIN</span> BTS_Income_Summary income <span class="token keyword keyword-ON">ON</span> req<span class="token punctuation">.</span>Apply_BloodTrans_ApplyID <span class="token operator">=</span> income<span class="token punctuation">.</span>Apply_BloodTrans_ApplyID
<span class="token keyword keyword-WHERE">WHERE</span> req<span class="token punctuation">.</span>Apply_BloodTrans_ApplyDate <span class="token operator">=</span> <span class="token string">'目标日期'</span>
<span class="token keyword keyword-GROUP">GROUP</span> <span class="token keyword keyword-BY">BY</span> 
    req<span class="token punctuation">.</span>Apply_BloodTrans_ApplyDate<span class="token punctuation">,</span>
    req<span class="token punctuation">.</span>Apply_BloodTrans_DeptID<span class="token punctuation">,</span>
    req<span class="token punctuation">.</span>Apply_BloodTrans_DeptName<span class="token punctuation">,</span>
    req<span class="token punctuation">.</span>Apply_BloodTrans_BloodTypeCode<span class="token punctuation">,</span>
    req<span class="token punctuation">.</span>Apply_BloodTrans_BloodTypeABOName<span class="token punctuation">;</span>
</code></pre><h4 id="422-月度主题数据生成">4.2.2 月度主题数据生成 </h4>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token comment">-- 月度主题数据生成示例SQL</span>
<span class="token keyword keyword-INSERT">INSERT</span> <span class="token keyword keyword-INTO">INTO</span> MDR_BTS_Monthly_Summary <span class="token punctuation">(</span>
    MDR_BTS_Monthly_Summary_SummaryID<span class="token punctuation">,</span>
    MDR_BTS_Monthly_Summary_SummaryYearMonth<span class="token punctuation">,</span>
    MDR_BTS_Monthly_Summary_DeptName<span class="token punctuation">,</span>
    MDR_BTS_Monthly_Summary_BloodTypeName<span class="token punctuation">,</span>
    MDR_BTS_Monthly_Summary_CurrentSampleCount<span class="token punctuation">,</span>
    MDR_BTS_Monthly_Summary_CurrentTestCount<span class="token punctuation">,</span>
    MDR_BTS_Monthly_Summary_CurrentWorkCount<span class="token punctuation">,</span>
    MDR_BTS_Monthly_Summary_CurrentBloodIncome<span class="token punctuation">,</span>
    MDR_BTS_Monthly_Summary_CurrentTotalIncome<span class="token punctuation">,</span>
    <span class="token comment">-- 环比计算</span>
    MDR_BTS_Monthly_Summary_SampleCountMoMRate<span class="token punctuation">,</span>
    MDR_BTS_Monthly_Summary_BloodIncomeMoMRate<span class="token punctuation">,</span>
    <span class="token comment">-- 同比计算</span>
    MDR_BTS_Monthly_Summary_SampleCountYoYRate<span class="token punctuation">,</span>
    MDR_BTS_Monthly_Summary_BloodIncomeYoYRate
<span class="token punctuation">)</span>
<span class="token keyword keyword-SELECT">SELECT</span> 
    CONCAT<span class="token punctuation">(</span><span class="token keyword keyword-LEFT">LEFT</span><span class="token punctuation">(</span>curr<span class="token punctuation">.</span>BTS_Daily_Summary_SummaryDate<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">,</span> curr<span class="token punctuation">.</span>BTS_Daily_Summary_DeptID<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword keyword-LEFT">LEFT</span><span class="token punctuation">(</span>curr<span class="token punctuation">.</span>BTS_Daily_Summary_SummaryDate<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    curr<span class="token punctuation">.</span>BTS_Daily_Summary_DeptName<span class="token punctuation">,</span>
    curr<span class="token punctuation">.</span>BTS_Daily_Summary_BloodTypeName<span class="token punctuation">,</span>
    <span class="token function">SUM</span><span class="token punctuation">(</span>curr<span class="token punctuation">.</span>BTS_Daily_Summary_SampleCount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">SUM</span><span class="token punctuation">(</span>curr<span class="token punctuation">.</span>BTS_Daily_Summary_TestCount<span class="token punctuation">)</span><span class="token punctuation">,</span> 
    <span class="token function">SUM</span><span class="token punctuation">(</span>curr<span class="token punctuation">.</span>BTS_Daily_Summary_TotalWorkCount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">SUM</span><span class="token punctuation">(</span>curr<span class="token punctuation">.</span>BTS_Daily_Summary_BloodIncome<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">SUM</span><span class="token punctuation">(</span>curr<span class="token punctuation">.</span>BTS_Daily_Summary_TotalIncome<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">-- 环比计算 (当月-上月)/上月*100</span>
    <span class="token keyword keyword-CASE">CASE</span> <span class="token keyword keyword-WHEN">WHEN</span> <span class="token function">SUM</span><span class="token punctuation">(</span>last_month<span class="token punctuation">.</span>BTS_Daily_Summary_SampleCount<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> 
         <span class="token keyword keyword-THEN">THEN</span> <span class="token punctuation">(</span><span class="token function">SUM</span><span class="token punctuation">(</span>curr<span class="token punctuation">.</span>BTS_Daily_Summary_SampleCount<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">SUM</span><span class="token punctuation">(</span>last_month<span class="token punctuation">.</span>BTS_Daily_Summary_SampleCount<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100.0</span> <span class="token operator">/</span> <span class="token function">SUM</span><span class="token punctuation">(</span>last_month<span class="token punctuation">.</span>BTS_Daily_Summary_SampleCount<span class="token punctuation">)</span>
         <span class="token keyword keyword-ELSE">ELSE</span> <span class="token number">0</span> <span class="token keyword keyword-END">END</span><span class="token punctuation">,</span>
    <span class="token keyword keyword-CASE">CASE</span> <span class="token keyword keyword-WHEN">WHEN</span> <span class="token function">SUM</span><span class="token punctuation">(</span>last_month<span class="token punctuation">.</span>BTS_Daily_Summary_BloodIncome<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> 
         <span class="token keyword keyword-THEN">THEN</span> <span class="token punctuation">(</span><span class="token function">SUM</span><span class="token punctuation">(</span>curr<span class="token punctuation">.</span>BTS_Daily_Summary_BloodIncome<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">SUM</span><span class="token punctuation">(</span>last_month<span class="token punctuation">.</span>BTS_Daily_Summary_BloodIncome<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100.0</span> <span class="token operator">/</span> <span class="token function">SUM</span><span class="token punctuation">(</span>last_month<span class="token punctuation">.</span>BTS_Daily_Summary_BloodIncome<span class="token punctuation">)</span>
         <span class="token keyword keyword-ELSE">ELSE</span> <span class="token number">0</span> <span class="token keyword keyword-END">END</span><span class="token punctuation">,</span>
    <span class="token comment">-- 同比计算 (当月-去年同期)/去年同期*100</span>
    <span class="token keyword keyword-CASE">CASE</span> <span class="token keyword keyword-WHEN">WHEN</span> <span class="token function">SUM</span><span class="token punctuation">(</span>last_year<span class="token punctuation">.</span>BTS_Daily_Summary_SampleCount<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> 
         <span class="token keyword keyword-THEN">THEN</span> <span class="token punctuation">(</span><span class="token function">SUM</span><span class="token punctuation">(</span>curr<span class="token punctuation">.</span>BTS_Daily_Summary_SampleCount<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">SUM</span><span class="token punctuation">(</span>last_year<span class="token punctuation">.</span>BTS_Daily_Summary_SampleCount<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100.0</span> <span class="token operator">/</span> <span class="token function">SUM</span><span class="token punctuation">(</span>last_year<span class="token punctuation">.</span>BTS_Daily_Summary_SampleCount<span class="token punctuation">)</span>
         <span class="token keyword keyword-ELSE">ELSE</span> <span class="token number">0</span> <span class="token keyword keyword-END">END</span><span class="token punctuation">,</span>
    <span class="token keyword keyword-CASE">CASE</span> <span class="token keyword keyword-WHEN">WHEN</span> <span class="token function">SUM</span><span class="token punctuation">(</span>last_year<span class="token punctuation">.</span>BTS_Daily_Summary_BloodIncome<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> 
         <span class="token keyword keyword-THEN">THEN</span> <span class="token punctuation">(</span><span class="token function">SUM</span><span class="token punctuation">(</span>curr<span class="token punctuation">.</span>BTS_Daily_Summary_BloodIncome<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">SUM</span><span class="token punctuation">(</span>last_year<span class="token punctuation">.</span>BTS_Daily_Summary_BloodIncome<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100.0</span> <span class="token operator">/</span> <span class="token function">SUM</span><span class="token punctuation">(</span>last_year<span class="token punctuation">.</span>BTS_Daily_Summary_BloodIncome<span class="token punctuation">)</span>
         <span class="token keyword keyword-ELSE">ELSE</span> <span class="token number">0</span> <span class="token keyword keyword-END">END</span>
<span class="token keyword keyword-FROM">FROM</span> BTS_Daily_Summary curr
<span class="token keyword keyword-LEFT">LEFT</span> <span class="token keyword keyword-JOIN">JOIN</span> BTS_Daily_Summary last_month 
    <span class="token keyword keyword-ON">ON</span> curr<span class="token punctuation">.</span>BTS_Daily_Summary_DeptID <span class="token operator">=</span> last_month<span class="token punctuation">.</span>BTS_Daily_Summary_DeptID
    <span class="token operator">AND</span> curr<span class="token punctuation">.</span>BTS_Daily_Summary_BloodTypeCode <span class="token operator">=</span> last_month<span class="token punctuation">.</span>BTS_Daily_Summary_BloodTypeCode
    <span class="token operator">AND</span> <span class="token keyword keyword-LEFT">LEFT</span><span class="token punctuation">(</span>last_month<span class="token punctuation">.</span>BTS_Daily_Summary_SummaryDate<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">FORMAT</span><span class="token punctuation">(</span>DATEADD<span class="token punctuation">(</span><span class="token keyword keyword-month">month</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> CAST<span class="token punctuation">(</span><span class="token keyword keyword-LEFT">LEFT</span><span class="token punctuation">(</span>curr<span class="token punctuation">.</span>BTS_Daily_Summary_SummaryDate<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'01'</span> <span class="token keyword keyword-AS">AS</span> <span class="token keyword keyword-DATE">DATE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'yyyyMM'</span><span class="token punctuation">)</span>
<span class="token keyword keyword-LEFT">LEFT</span> <span class="token keyword keyword-JOIN">JOIN</span> BTS_Daily_Summary last_year
    <span class="token keyword keyword-ON">ON</span> curr<span class="token punctuation">.</span>BTS_Daily_Summary_DeptID <span class="token operator">=</span> last_year<span class="token punctuation">.</span>BTS_Daily_Summary_DeptID  
    <span class="token operator">AND</span> curr<span class="token punctuation">.</span>BTS_Daily_Summary_BloodTypeCode <span class="token operator">=</span> last_year<span class="token punctuation">.</span>BTS_Daily_Summary_BloodTypeCode
    <span class="token operator">AND</span> <span class="token keyword keyword-LEFT">LEFT</span><span class="token punctuation">(</span>last_year<span class="token punctuation">.</span>BTS_Daily_Summary_SummaryDate<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">FORMAT</span><span class="token punctuation">(</span>DATEADD<span class="token punctuation">(</span><span class="token keyword keyword-year">year</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> CAST<span class="token punctuation">(</span><span class="token keyword keyword-LEFT">LEFT</span><span class="token punctuation">(</span>curr<span class="token punctuation">.</span>BTS_Daily_Summary_SummaryDate<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'01'</span> <span class="token keyword keyword-AS">AS</span> <span class="token keyword keyword-DATE">DATE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'yyyyMM'</span><span class="token punctuation">)</span>
<span class="token keyword keyword-WHERE">WHERE</span> <span class="token keyword keyword-LEFT">LEFT</span><span class="token punctuation">(</span>curr<span class="token punctuation">.</span>BTS_Daily_Summary_SummaryDate<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">'202408'</span>  <span class="token comment">-- 目标月份</span>
<span class="token keyword keyword-GROUP">GROUP</span> <span class="token keyword keyword-BY">BY</span> 
    <span class="token keyword keyword-LEFT">LEFT</span><span class="token punctuation">(</span>curr<span class="token punctuation">.</span>BTS_Daily_Summary_SummaryDate<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    curr<span class="token punctuation">.</span>BTS_Daily_Summary_DeptID<span class="token punctuation">,</span>
    curr<span class="token punctuation">.</span>BTS_Daily_Summary_DeptName<span class="token punctuation">,</span>
    curr<span class="token punctuation">.</span>BTS_Daily_Summary_BloodTypeCode<span class="token punctuation">,</span>
    curr<span class="token punctuation">.</span>BTS_Daily_Summary_BloodTypeName<span class="token punctuation">;</span>
</code></pre><h3 id="43-收入数据集成逻辑">4.3 收入数据集成逻辑 </h3>
<h4 id="431-收入数据关联方式">4.3.1 收入数据关联方式 </h4>
<p>根据现有DC架构，收入数据通过以下血缘关系集成：</p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>Fee_BillDet → 输血系统收费表 → BTS相关表
</code></pre><p><strong>关联字段</strong>：<code>Fee_BillDet.Fee_BillDet_ChargeItemID = 输血收费项目ID</code></p>
<h4 id="432-收入数据分类统计">4.3.2 收入数据分类统计 </h4>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token comment">-- 收入数据集成示例SQL（基于Fee_BillDet表结构）</span>
<span class="token keyword keyword-WITH">WITH</span> BTS_Income_Summary <span class="token keyword keyword-AS">AS</span> <span class="token punctuation">(</span>
    <span class="token keyword keyword-SELECT">SELECT</span> 
        <span class="token keyword keyword-apply">apply</span><span class="token punctuation">.</span>Apply_BloodTrans_ApplyID<span class="token punctuation">,</span>
        <span class="token keyword keyword-apply">apply</span><span class="token punctuation">.</span>Apply_BloodTrans_ApplyDate<span class="token punctuation">,</span>
        <span class="token keyword keyword-apply">apply</span><span class="token punctuation">.</span>Apply_BloodTrans_DeptID<span class="token punctuation">,</span>
        <span class="token keyword keyword-apply">apply</span><span class="token punctuation">.</span>Apply_BloodTrans_DeptName<span class="token punctuation">,</span>
        
        <span class="token comment">-- 配血检收入（检验相关费用）</span>
        <span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword keyword-CASE">CASE</span> <span class="token keyword keyword-WHEN">WHEN</span> <span class="token punctuation">(</span>charge<span class="token punctuation">.</span>Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%血型%'</span> 
                       <span class="token operator">OR</span> charge<span class="token punctuation">.</span>Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%配血%'</span>
                       <span class="token operator">OR</span> charge<span class="token punctuation">.</span>Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%抗体%'</span>
                       <span class="token operator">OR</span> charge<span class="token punctuation">.</span>Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%交叉%'</span><span class="token punctuation">)</span>
                 <span class="token operator">AND</span> charge<span class="token punctuation">.</span>Fee_BillDet_ChargeItemName <span class="token operator">NOT</span> <span class="token operator">LIKE</span> <span class="token string">'%血液%'</span>
                 <span class="token operator">AND</span> charge<span class="token punctuation">.</span>Fee_BillDet_ChargeItemName <span class="token operator">NOT</span> <span class="token operator">LIKE</span> <span class="token string">'%血袋%'</span>
                 <span class="token keyword keyword-THEN">THEN</span> charge<span class="token punctuation">.</span>Fee_BillDet_TotalFee <span class="token keyword keyword-ELSE">ELSE</span> <span class="token number">0</span> <span class="token keyword keyword-END">END</span><span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> test_income<span class="token punctuation">,</span>
        
        <span class="token comment">-- 血费收入（血液相关费用）</span>
        <span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword keyword-CASE">CASE</span> <span class="token keyword keyword-WHEN">WHEN</span> charge<span class="token punctuation">.</span>Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%血液%'</span> 
                 <span class="token operator">OR</span> charge<span class="token punctuation">.</span>Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%血袋%'</span>
                 <span class="token operator">OR</span> charge<span class="token punctuation">.</span>Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%全血%'</span>
                 <span class="token operator">OR</span> charge<span class="token punctuation">.</span>Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%血浆%'</span>
                 <span class="token operator">OR</span> charge<span class="token punctuation">.</span>Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%血小板%'</span>
                 <span class="token operator">OR</span> charge<span class="token punctuation">.</span>Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%红细胞%'</span>
                 <span class="token keyword keyword-THEN">THEN</span> charge<span class="token punctuation">.</span>Fee_BillDet_TotalFee <span class="token keyword keyword-ELSE">ELSE</span> <span class="token number">0</span> <span class="token keyword keyword-END">END</span><span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> blood_income<span class="token punctuation">,</span>
        
        <span class="token comment">-- 输血治疗收入（治疗项目费用）</span>
        <span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword keyword-CASE">CASE</span> <span class="token keyword keyword-WHEN">WHEN</span> charge<span class="token punctuation">.</span>Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%血浆置换%'</span> 
                 <span class="token operator">OR</span> charge<span class="token punctuation">.</span>Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%红细胞单采%'</span>
                 <span class="token operator">OR</span> charge<span class="token punctuation">.</span>Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%全血采集%'</span>
                 <span class="token operator">OR</span> charge<span class="token punctuation">.</span>Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%血液单采%'</span>
                 <span class="token operator">OR</span> charge<span class="token punctuation">.</span>Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%输血治疗%'</span>
                 <span class="token keyword keyword-THEN">THEN</span> charge<span class="token punctuation">.</span>Fee_BillDet_TotalFee <span class="token keyword keyword-ELSE">ELSE</span> <span class="token number">0</span> <span class="token keyword keyword-END">END</span><span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> treatment_income<span class="token punctuation">,</span>
        
        <span class="token comment">-- 总收入</span>
        <span class="token function">SUM</span><span class="token punctuation">(</span>charge<span class="token punctuation">.</span>Fee_BillDet_TotalFee<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> total_income
        
    <span class="token keyword keyword-FROM">FROM</span> Apply_BloodTrans <span class="token keyword keyword-apply">apply</span>
    <span class="token keyword keyword-LEFT">LEFT</span> <span class="token keyword keyword-JOIN">JOIN</span> Fee_BillDet charge 
        <span class="token keyword keyword-ON">ON</span> <span class="token keyword keyword-apply">apply</span><span class="token punctuation">.</span>Apply_BloodTrans_VisitID <span class="token operator">=</span> charge<span class="token punctuation">.</span>Fee_BillDet_VisitID
        <span class="token operator">AND</span> <span class="token function">FORMAT</span><span class="token punctuation">(</span>charge<span class="token punctuation">.</span>Fee_BillDet_BillDtTm<span class="token punctuation">,</span> <span class="token string">'yyyyMMdd'</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword keyword-apply">apply</span><span class="token punctuation">.</span>Apply_BloodTrans_ApplyDate
        <span class="token operator">AND</span> <span class="token punctuation">(</span>charge<span class="token punctuation">.</span>Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%输血%'</span>
             <span class="token operator">OR</span> charge<span class="token punctuation">.</span>Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%血液%'</span>
             <span class="token operator">OR</span> charge<span class="token punctuation">.</span>Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%血型%'</span>
             <span class="token operator">OR</span> charge<span class="token punctuation">.</span>Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%配血%'</span>
             <span class="token operator">OR</span> charge<span class="token punctuation">.</span>Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%抗体%'</span>
             <span class="token operator">OR</span> charge<span class="token punctuation">.</span>Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%血浆置换%'</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-WHERE">WHERE</span> <span class="token keyword keyword-apply">apply</span><span class="token punctuation">.</span>Apply_BloodTrans_ApplyDate <span class="token operator">&gt;=</span> <span class="token function">FORMAT</span><span class="token punctuation">(</span>DATEADD<span class="token punctuation">(</span><span class="token keyword keyword-month">month</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">13</span><span class="token punctuation">,</span> GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'yyyyMMdd'</span><span class="token punctuation">)</span>
      <span class="token operator">AND</span> charge<span class="token punctuation">.</span>Fee_BillDet_IsDeleted <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword keyword-GROUP">GROUP</span> <span class="token keyword keyword-BY">BY</span> 
        <span class="token keyword keyword-apply">apply</span><span class="token punctuation">.</span>Apply_BloodTrans_ApplyID<span class="token punctuation">,</span>
        <span class="token keyword keyword-apply">apply</span><span class="token punctuation">.</span>Apply_BloodTrans_ApplyDate<span class="token punctuation">,</span>
        <span class="token keyword keyword-apply">apply</span><span class="token punctuation">.</span>Apply_BloodTrans_DeptID<span class="token punctuation">,</span>
        <span class="token keyword keyword-apply">apply</span><span class="token punctuation">.</span>Apply_BloodTrans_DeptName
<span class="token punctuation">)</span>
<span class="token keyword keyword-SELECT">SELECT</span> <span class="token operator">*</span> <span class="token keyword keyword-FROM">FROM</span> BTS_Income_Summary<span class="token punctuation">;</span>
</code></pre><h4 id="433-收入指标详细分类规则基于fee_billdet表">4.3.3 收入指标详细分类规则（基于Fee_BillDet表） </h4>
<p><strong>数据源表结构</strong>：使用DC层标准化的 <code>Fee_BillDet</code>（费用_账单明细表），关键字段包括：</p>
<table>
<thead>
<tr>
<th>字段名</th>
<th>字段类型</th>
<th>用途说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Fee_BillDet_ChargeItemName</td>
<td>VARCHAR(100)</td>
<td>收费项目名称，用于分类筛选</td>
</tr>
<tr>
<td>Fee_BillDet_TotalFee</td>
<td>FLOAT8</td>
<td>总费用，收入金额来源</td>
</tr>
<tr>
<td>Fee_BillDet_VisitID</td>
<td>INT8</td>
<td>就诊ID，关联输血申请</td>
</tr>
<tr>
<td>Fee_BillDet_BillDtTm</td>
<td>timestamp</td>
<td>账单时间，用于时间维度统计</td>
</tr>
<tr>
<td>Fee_BillDet_IsDeleted</td>
<td>INT8</td>
<td>删除标识，过滤有效数据</td>
</tr>
</tbody>
</table>
<p><strong>三类收入分类规则</strong>：</p>
<h5 id="a-配血检收入检验相关费用">A. 配血检收入（检验相关费用） </h5>
<p><strong>筛选条件</strong>：</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code>Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%血型%'</span>
<span class="token operator">OR</span> Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%配血%'</span>
<span class="token operator">OR</span> Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%抗体%'</span>
<span class="token operator">OR</span> Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%交叉%'</span>
<span class="token operator">OR</span> Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%直抗%'</span>
<span class="token operator">OR</span> Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%抗筛%'</span>
<span class="token comment">-- 排除血液相关费用</span>
<span class="token operator">AND</span> Fee_BillDet_ChargeItemName <span class="token operator">NOT</span> <span class="token operator">LIKE</span> <span class="token string">'%血液%'</span>
<span class="token operator">AND</span> Fee_BillDet_ChargeItemName <span class="token operator">NOT</span> <span class="token operator">LIKE</span> <span class="token string">'%血袋%'</span>
</code></pre><p><strong>包含项目示例</strong>：</p>
<ul>
<li>ABO血型鉴定</li>
<li>Rh血型检测</li>
<li>抗体筛查试验</li>
<li>交叉配血试验</li>
<li>直接抗人球蛋白试验</li>
<li>疑难血型鉴定</li>
<li>血小板抗体检测</li>
<li>抗体效价测定</li>
</ul>
<h5 id="b-血费收入血液相关费用">B. 血费收入（血液相关费用） </h5>
<p><strong>筛选条件</strong>：</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code>Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%血液%'</span>
<span class="token operator">OR</span> Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%血袋%'</span>
<span class="token operator">OR</span> Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%全血%'</span>
<span class="token operator">OR</span> Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%血浆%'</span>
<span class="token operator">OR</span> Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%血小板%'</span>
<span class="token operator">OR</span> Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%红细胞%'</span>
<span class="token operator">OR</span> Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%冷沉淀%'</span>
<span class="token operator">OR</span> Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%血制品%'</span>
</code></pre><p><strong>包含项目示例</strong>：</p>
<ul>
<li>悬浮红细胞</li>
<li>洗涤红细胞</li>
<li>新鲜冰冻血浆</li>
<li>机采血小板</li>
<li>冷沉淀凝血因子</li>
<li>全血</li>
<li>其他血液制品</li>
</ul>
<h5 id="c-输血治疗收入治疗项目费用">C. 输血治疗收入（治疗项目费用） </h5>
<p><strong>筛选条件</strong>：</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code>Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%血浆置换%'</span>
<span class="token operator">OR</span> Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%红细胞单采%'</span>
<span class="token operator">OR</span> Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%全血采集%'</span>
<span class="token operator">OR</span> Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%血液单采%'</span>
<span class="token operator">OR</span> Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%输血治疗%'</span>
<span class="token operator">OR</span> Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%血液稀释%'</span>
<span class="token operator">OR</span> Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%自体血%'</span>
</code></pre><p><strong>包含项目示例</strong>：</p>
<ul>
<li>血浆置换治疗</li>
<li>全血置换治疗</li>
<li>红细胞单采术</li>
<li>血小板单采术</li>
<li>全血采集术</li>
<li>血液稀释疗法</li>
<li>自体血回输</li>
</ul>
<h4 id="434-收入数据质量控制">4.3.4 收入数据质量控制 </h4>
<p><strong>数据有效性检查</strong>：</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token comment">-- 收入数据质量监控</span>
<span class="token keyword keyword-SELECT">SELECT</span> 
    <span class="token string">'配血检收入'</span> <span class="token keyword keyword-as">as</span> income_type<span class="token punctuation">,</span>
    <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> record_count<span class="token punctuation">,</span>
    <span class="token function">SUM</span><span class="token punctuation">(</span>Fee_BillDet_TotalFee<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> total_amount<span class="token punctuation">,</span>
    <span class="token function">AVG</span><span class="token punctuation">(</span>Fee_BillDet_TotalFee<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> avg_amount<span class="token punctuation">,</span>
    <span class="token function">MIN</span><span class="token punctuation">(</span>Fee_BillDet_TotalFee<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> min_amount<span class="token punctuation">,</span>
    <span class="token function">MAX</span><span class="token punctuation">(</span>Fee_BillDet_TotalFee<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> max_amount
<span class="token keyword keyword-FROM">FROM</span> Fee_BillDet
<span class="token keyword keyword-WHERE">WHERE</span> <span class="token punctuation">(</span>Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%血型%'</span> 
       <span class="token operator">OR</span> Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%配血%'</span>
       <span class="token operator">OR</span> Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%抗体%'</span><span class="token punctuation">)</span>
  <span class="token operator">AND</span> Fee_BillDet_ChargeItemName <span class="token operator">NOT</span> <span class="token operator">LIKE</span> <span class="token string">'%血液%'</span>
  <span class="token operator">AND</span> Fee_BillDet_IsDeleted <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token operator">AND</span> Fee_BillDet_BillDtTm <span class="token operator">&gt;=</span> DATEADD<span class="token punctuation">(</span><span class="token keyword keyword-month">month</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword keyword-UNION">UNION</span> <span class="token keyword keyword-ALL">ALL</span>

<span class="token keyword keyword-SELECT">SELECT</span> 
    <span class="token string">'血费收入'</span> <span class="token keyword keyword-as">as</span> income_type<span class="token punctuation">,</span>
    <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> record_count<span class="token punctuation">,</span>
    <span class="token function">SUM</span><span class="token punctuation">(</span>Fee_BillDet_TotalFee<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> total_amount<span class="token punctuation">,</span>
    <span class="token function">AVG</span><span class="token punctuation">(</span>Fee_BillDet_TotalFee<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> avg_amount<span class="token punctuation">,</span>
    <span class="token function">MIN</span><span class="token punctuation">(</span>Fee_BillDet_TotalFee<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> min_amount<span class="token punctuation">,</span>
    <span class="token function">MAX</span><span class="token punctuation">(</span>Fee_BillDet_TotalFee<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> max_amount
<span class="token keyword keyword-FROM">FROM</span> Fee_BillDet
<span class="token keyword keyword-WHERE">WHERE</span> <span class="token punctuation">(</span>Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%血液%'</span> 
       <span class="token operator">OR</span> Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%血浆%'</span>
       <span class="token operator">OR</span> Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%血小板%'</span><span class="token punctuation">)</span>
  <span class="token operator">AND</span> Fee_BillDet_IsDeleted <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token operator">AND</span> Fee_BillDet_BillDtTm <span class="token operator">&gt;=</span> DATEADD<span class="token punctuation">(</span><span class="token keyword keyword-month">month</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword keyword-UNION">UNION</span> <span class="token keyword keyword-ALL">ALL</span>

<span class="token keyword keyword-SELECT">SELECT</span> 
    <span class="token string">'输血治疗收入'</span> <span class="token keyword keyword-as">as</span> income_type<span class="token punctuation">,</span>
    <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> record_count<span class="token punctuation">,</span>
    <span class="token function">SUM</span><span class="token punctuation">(</span>Fee_BillDet_TotalFee<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> total_amount<span class="token punctuation">,</span>
    <span class="token function">AVG</span><span class="token punctuation">(</span>Fee_BillDet_TotalFee<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> avg_amount<span class="token punctuation">,</span>
    <span class="token function">MIN</span><span class="token punctuation">(</span>Fee_BillDet_TotalFee<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> min_amount<span class="token punctuation">,</span>
    <span class="token function">MAX</span><span class="token punctuation">(</span>Fee_BillDet_TotalFee<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> max_amount
<span class="token keyword keyword-FROM">FROM</span> Fee_BillDet
<span class="token keyword keyword-WHERE">WHERE</span> <span class="token punctuation">(</span>Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%血浆置换%'</span> 
       <span class="token operator">OR</span> Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%单采%'</span>
       <span class="token operator">OR</span> Fee_BillDet_ChargeItemName <span class="token operator">LIKE</span> <span class="token string">'%输血治疗%'</span><span class="token punctuation">)</span>
  <span class="token operator">AND</span> Fee_BillDet_IsDeleted <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token operator">AND</span> Fee_BillDet_BillDtTm <span class="token operator">&gt;=</span> DATEADD<span class="token punctuation">(</span><span class="token keyword keyword-month">month</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><strong>异常数据监控</strong>：</p>
<ul>
<li>金额异常：单笔费用为0或超过设定阈值</li>
<li>项目异常：收费项目名称为空或包含特殊字符</li>
<li>时间异常：账单时间为空或早于系统上线时间</li>
<li>关联异常：关联的就诊ID不存在或已删除</li>
</ul>
<h3 id="44-支出数据集成逻辑">4.4 支出数据集成逻辑 </h3>
<h4 id="441-支出数据分类">4.4.1 支出数据分类 </h4>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token comment">-- 支出数据集成示例SQL</span>
<span class="token keyword keyword-WITH">WITH</span> BTS_Cost_Summary <span class="token keyword keyword-AS">AS</span> <span class="token punctuation">(</span>
    <span class="token keyword keyword-SELECT">SELECT</span> 
        cost_date<span class="token punctuation">,</span>
        
        <span class="token comment">-- 血费支出（血站结算费用）</span>
        <span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword keyword-CASE">CASE</span> <span class="token keyword keyword-WHEN">WHEN</span> cost_type <span class="token operator">=</span> <span class="token string">'血液成本'</span> <span class="token keyword keyword-THEN">THEN</span> cost_amount <span class="token keyword keyword-ELSE">ELSE</span> <span class="token number">0</span> <span class="token keyword keyword-END">END</span><span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> blood_cost<span class="token punctuation">,</span>
        
        <span class="token comment">-- 试剂支出</span>
        <span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword keyword-CASE">CASE</span> <span class="token keyword keyword-WHEN">WHEN</span> cost_type <span class="token operator">=</span> <span class="token string">'试剂费用'</span> <span class="token keyword keyword-THEN">THEN</span> cost_amount <span class="token keyword keyword-ELSE">ELSE</span> <span class="token number">0</span> <span class="token keyword keyword-END">END</span><span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> reagent_cost<span class="token punctuation">,</span>
        
        <span class="token comment">-- 输血治疗耗材</span>
        <span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword keyword-CASE">CASE</span> <span class="token keyword keyword-WHEN">WHEN</span> cost_type <span class="token operator">=</span> <span class="token string">'治疗耗材'</span> <span class="token keyword keyword-THEN">THEN</span> cost_amount <span class="token keyword keyword-ELSE">ELSE</span> <span class="token number">0</span> <span class="token keyword keyword-END">END</span><span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> material_cost<span class="token punctuation">,</span>
        
        <span class="token comment">-- 总支出</span>
        <span class="token function">SUM</span><span class="token punctuation">(</span>cost_amount<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> total_cost
        
    <span class="token keyword keyword-FROM">FROM</span> <span class="token punctuation">(</span>
        <span class="token comment">-- 血液成本（血站结算清单）</span>
        <span class="token keyword keyword-SELECT">SELECT</span> 
            blood_date <span class="token keyword keyword-as">as</span> cost_date<span class="token punctuation">,</span>
            <span class="token string">'血液成本'</span> <span class="token keyword keyword-as">as</span> cost_type<span class="token punctuation">,</span>
            blood_cost <span class="token keyword keyword-as">as</span> cost_amount
        <span class="token keyword keyword-FROM">FROM</span> blood_station_settlement
        <span class="token keyword keyword-WHERE">WHERE</span> blood_date <span class="token operator">&gt;=</span> <span class="token function">FORMAT</span><span class="token punctuation">(</span>DATEADD<span class="token punctuation">(</span><span class="token keyword keyword-month">month</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">13</span><span class="token punctuation">,</span> GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'yyyyMMdd'</span><span class="token punctuation">)</span>
        
        <span class="token keyword keyword-UNION">UNION</span> <span class="token keyword keyword-ALL">ALL</span>
        
        <span class="token comment">-- 试剂费用（试剂库订单）</span>
        <span class="token keyword keyword-SELECT">SELECT</span> 
            order_date <span class="token keyword keyword-as">as</span> cost_date<span class="token punctuation">,</span>
            <span class="token string">'试剂费用'</span> <span class="token keyword keyword-as">as</span> cost_type<span class="token punctuation">,</span>
            order_amount <span class="token keyword keyword-as">as</span> cost_amount
        <span class="token keyword keyword-FROM">FROM</span> reagent_library_order
        <span class="token keyword keyword-WHERE">WHERE</span> order_date <span class="token operator">&gt;=</span> <span class="token function">FORMAT</span><span class="token punctuation">(</span>DATEADD<span class="token punctuation">(</span><span class="token keyword keyword-month">month</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">13</span><span class="token punctuation">,</span> GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'yyyyMMdd'</span><span class="token punctuation">)</span>
        <span class="token operator">AND</span> dept_name <span class="token operator">=</span> <span class="token string">'输血科'</span>
        
        <span class="token keyword keyword-UNION">UNION</span> <span class="token keyword keyword-ALL">ALL</span>
        
        <span class="token comment">-- 治疗耗材</span>
        <span class="token keyword keyword-SELECT">SELECT</span> 
            material_date <span class="token keyword keyword-as">as</span> cost_date<span class="token punctuation">,</span>
            <span class="token string">'治疗耗材'</span> <span class="token keyword keyword-as">as</span> cost_type<span class="token punctuation">,</span>
            material_cost <span class="token keyword keyword-as">as</span> cost_amount
        <span class="token keyword keyword-FROM">FROM</span> treatment_material_cost
        <span class="token keyword keyword-WHERE">WHERE</span> material_date <span class="token operator">&gt;=</span> <span class="token function">FORMAT</span><span class="token punctuation">(</span>DATEADD<span class="token punctuation">(</span><span class="token keyword keyword-month">month</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">13</span><span class="token punctuation">,</span> GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'yyyyMMdd'</span><span class="token punctuation">)</span>
        <span class="token operator">AND</span> dept_name <span class="token operator">=</span> <span class="token string">'输血科'</span>
        
    <span class="token punctuation">)</span> cost_detail
    <span class="token keyword keyword-GROUP">GROUP</span> <span class="token keyword keyword-BY">BY</span> cost_date
<span class="token punctuation">)</span>
<span class="token keyword keyword-SELECT">SELECT</span> <span class="token operator">*</span> <span class="token keyword keyword-FROM">FROM</span> BTS_Cost_Summary<span class="token punctuation">;</span>
</code></pre><h2 id="五-工作量统计详细设计">五、工作量统计详细设计 </h2>
<h3 id="51-样本检测工作量统计">5.1 样本检测工作量统计 </h3>
<p>基于输血科业务需求，样本检测工作量包含以下子项目：</p>
<table>
<thead>
<tr>
<th>子项目</th>
<th>指标内涵</th>
<th>计算方式</th>
<th>数据来源</th>
</tr>
</thead>
<tbody>
<tr>
<td>血型检测</td>
<td>ABO血型鉴定、Rh血型检测</td>
<td>按检验项目代码统计</td>
<td>LIS系统项目代码LIS07068、LIS05等</td>
</tr>
<tr>
<td>抗体筛查</td>
<td>患者抗体筛查</td>
<td>按检验项目代码统计</td>
<td>LIS系统项目代码LIS07073</td>
</tr>
<tr>
<td>交叉配血</td>
<td>盐水介质、凝聚胺配血等</td>
<td>按检验项目代码统计</td>
<td>LIS系统项目代码LIS07156、LIS07157、LIS07153</td>
</tr>
<tr>
<td>直接抗人球蛋白试验</td>
<td>直抗检测</td>
<td>按检验项目代码统计</td>
<td>LIS系统项目代码LIS07079</td>
</tr>
<tr>
<td>疑难样本</td>
<td>疑难血型及抗筛阳性鉴定</td>
<td>按疑难登记样本数统计</td>
<td>LIS系统疑难登记样本数</td>
</tr>
<tr>
<td>血小板交叉配血</td>
<td>血小板交叉配合试验</td>
<td>按检验项目代码统计</td>
<td>LIS系统项目代码LIS026801</td>
</tr>
<tr>
<td>血小板抗体检测</td>
<td>HLA抗体检测</td>
<td>按检验项目代码统计</td>
<td>LIS系统项目代码LIS026797</td>
</tr>
<tr>
<td>抗体效价</td>
<td>血型抗体效价测定</td>
<td>按检验项目代码统计</td>
<td>LIS系统项目代码LIS030072、LIS030073、LIS030075</td>
</tr>
<tr>
<td>Rh分型</td>
<td>Rh血型系统抗原检测</td>
<td>按检验项目代码统计</td>
<td>LIS系统项目代码LIS028043</td>
</tr>
</tbody>
</table>
<h3 id="52-临床用血工作量统计">5.2 临床用血工作量统计 </h3>
<table>
<thead>
<tr>
<th>子项目</th>
<th>指标内涵</th>
<th>计算方式</th>
<th>数据来源</th>
</tr>
</thead>
<tbody>
<tr>
<td>血液预约次数</td>
<td>血液预约</td>
<td>血站约血系统订单记录</td>
<td>网上订血订单记录</td>
</tr>
<tr>
<td>血液入库(袋)</td>
<td>血液验收、入库、存放库位</td>
<td>输血系统统计入库袋数</td>
<td>输血系统入库记录</td>
</tr>
<tr>
<td>血液出库(袋)</td>
<td>血液出库、外观检测、核对</td>
<td>输血系统统计出库袋数</td>
<td>输血系统出库记录</td>
</tr>
<tr>
<td>血液盘存(袋)</td>
<td>每周血液库存盘点</td>
<td>每周一早上8点库存量</td>
<td>输血系统库存统计</td>
</tr>
<tr>
<td>血浆/冷沉淀融化(袋)</td>
<td>发放前水浴融解处理</td>
<td>血浆及冷沉淀出库数量</td>
<td>输血系统出库记录</td>
</tr>
<tr>
<td>周六加班手术台次</td>
<td>周六加班手术支持</td>
<td>手术台次统计</td>
<td>手术排程系统</td>
</tr>
</tbody>
</table>
<h3 id="53-输血治疗工作量统计">5.3 输血治疗工作量统计 </h3>
<table>
<thead>
<tr>
<th>子项目</th>
<th>指标内涵</th>
<th>计算方式</th>
<th>数据来源</th>
</tr>
</thead>
<tbody>
<tr>
<td>全血采集</td>
<td>血液稀释疗法及自体全血储存</td>
<td>收费项目666600613、666000570、666000571</td>
<td>HIS系统医嘱记录</td>
</tr>
<tr>
<td>血浆置换</td>
<td>全血置换、淋巴血浆置换等</td>
<td>收费项目666600598</td>
<td>HIS系统医嘱记录</td>
</tr>
<tr>
<td>血液单采</td>
<td>PRP采集、红细胞单采、血小板单采</td>
<td>收费项目666000510</td>
<td>HIS系统医嘱记录</td>
</tr>
</tbody>
</table>
<h3 id="54-血液管理工作量统计">5.4 血液管理工作量统计 </h3>
<table>
<thead>
<tr>
<th>子项目</th>
<th>指标内涵</th>
<th>计算方式</th>
<th>数据来源</th>
</tr>
</thead>
<tbody>
<tr>
<td>输血管理</td>
<td>全院合理用血评估</td>
<td>质控岗考核指标</td>
<td>质控记录系统</td>
</tr>
<tr>
<td>输血病历抽查</td>
<td>全院输血病历抽查</td>
<td>抽查病历数量</td>
<td>质控记录系统</td>
</tr>
<tr>
<td>输血不良反应调查</td>
<td>输血不良反应调查处理</td>
<td>不良反应案例数</td>
<td>不良反应系统</td>
</tr>
</tbody>
</table>
<h2 id="六-数据质量监控设计">六、数据质量监控设计 </h2>
<h3 id="61-数据完整性监控">6.1 数据完整性监控 </h3>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token comment">-- 数据完整性监控SQL示例</span>
<span class="token keyword keyword-SELECT">SELECT</span> 
    <span class="token string">'输血申请数据'</span> <span class="token keyword keyword-as">as</span> table_name<span class="token punctuation">,</span>
    <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> total_count<span class="token punctuation">,</span>
    <span class="token function">COUNT</span><span class="token punctuation">(</span>BTS_Requisition_Main_ApplyID<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> id_count<span class="token punctuation">,</span>
    <span class="token function">COUNT</span><span class="token punctuation">(</span>BTS_Requisition_Main_PersID<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> person_count<span class="token punctuation">,</span>
    <span class="token function">COUNT</span><span class="token punctuation">(</span>BTS_Requisition_Main_DeptID<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> dept_count<span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token function">COUNT</span><span class="token punctuation">(</span>BTS_Requisition_Main_ApplyID<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100.0</span> <span class="token operator">/</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> id_completeness_rate<span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token function">COUNT</span><span class="token punctuation">(</span>BTS_Requisition_Main_PersID<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100.0</span> <span class="token operator">/</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> person_completeness_rate<span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token function">COUNT</span><span class="token punctuation">(</span>BTS_Requisition_Main_DeptID<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100.0</span> <span class="token operator">/</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> dept_completeness_rate
<span class="token keyword keyword-FROM">FROM</span> BTS_Requisition_Main
<span class="token keyword keyword-WHERE">WHERE</span> BTS_Requisition_Main_ApplyDate <span class="token operator">&gt;=</span> <span class="token function">FORMAT</span><span class="token punctuation">(</span>DATEADD<span class="token punctuation">(</span><span class="token keyword keyword-day">day</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">,</span> GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'yyyyMMdd'</span><span class="token punctuation">)</span>

<span class="token keyword keyword-UNION">UNION</span> <span class="token keyword keyword-ALL">ALL</span>

<span class="token keyword keyword-SELECT">SELECT</span> 
    <span class="token string">'血液明细数据'</span> <span class="token keyword keyword-as">as</span> table_name<span class="token punctuation">,</span>
    <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> total_count<span class="token punctuation">,</span>
    <span class="token function">COUNT</span><span class="token punctuation">(</span>BTS_Blood_Detail_BloodID<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> id_count<span class="token punctuation">,</span>
    <span class="token function">COUNT</span><span class="token punctuation">(</span>BTS_Blood_Detail_BloodBagNo<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> bag_count<span class="token punctuation">,</span>
    <span class="token function">COUNT</span><span class="token punctuation">(</span>BTS_Blood_Detail_BloodTypeName<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> type_count<span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token function">COUNT</span><span class="token punctuation">(</span>BTS_Blood_Detail_BloodID<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100.0</span> <span class="token operator">/</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> id_completeness_rate<span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token function">COUNT</span><span class="token punctuation">(</span>BTS_Blood_Detail_BloodBagNo<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100.0</span> <span class="token operator">/</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> bag_completeness_rate<span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token function">COUNT</span><span class="token punctuation">(</span>BTS_Blood_Detail_BloodTypeName<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100.0</span> <span class="token operator">/</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> type_completeness_rate
<span class="token keyword keyword-FROM">FROM</span> BTS_Blood_Detail
<span class="token keyword keyword-WHERE">WHERE</span> BTS_Blood_Detail_BloodDate <span class="token operator">&gt;=</span> <span class="token function">FORMAT</span><span class="token punctuation">(</span>DATEADD<span class="token punctuation">(</span><span class="token keyword keyword-day">day</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">,</span> GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'yyyyMMdd'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h3 id="62-数据一致性监控">6.2 数据一致性监控 </h3>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token comment">-- 数据一致性监控SQL示例</span>
<span class="token keyword keyword-SELECT">SELECT</span> 
    <span class="token string">'DC-MDR数据一致性检查'</span> <span class="token keyword keyword-as">as</span> check_type<span class="token punctuation">,</span>
    dc_summary<span class="token punctuation">.</span>summary_date<span class="token punctuation">,</span>
    dc_summary<span class="token punctuation">.</span>dept_name<span class="token punctuation">,</span>
    dc_summary<span class="token punctuation">.</span>dc_sample_count<span class="token punctuation">,</span>
    mdr_summary<span class="token punctuation">.</span>mdr_sample_count<span class="token punctuation">,</span>
    ABS<span class="token punctuation">(</span>dc_summary<span class="token punctuation">.</span>dc_sample_count <span class="token operator">-</span> mdr_summary<span class="token punctuation">.</span>mdr_sample_count<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> diff_count<span class="token punctuation">,</span>
    <span class="token keyword keyword-CASE">CASE</span> <span class="token keyword keyword-WHEN">WHEN</span> dc_summary<span class="token punctuation">.</span>dc_sample_count <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword keyword-THEN">THEN</span> <span class="token number">0</span>
         <span class="token keyword keyword-ELSE">ELSE</span> ABS<span class="token punctuation">(</span>dc_summary<span class="token punctuation">.</span>dc_sample_count <span class="token operator">-</span> mdr_summary<span class="token punctuation">.</span>mdr_sample_count<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100.0</span> <span class="token operator">/</span> dc_summary<span class="token punctuation">.</span>dc_sample_count 
    <span class="token keyword keyword-END">END</span> <span class="token keyword keyword-as">as</span> diff_rate
<span class="token keyword keyword-FROM">FROM</span> <span class="token punctuation">(</span>
    <span class="token keyword keyword-SELECT">SELECT</span> 
        <span class="token keyword keyword-LEFT">LEFT</span><span class="token punctuation">(</span>BTS_Daily_Summary_SummaryDate<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> summary_date<span class="token punctuation">,</span>
        BTS_Daily_Summary_DeptName <span class="token keyword keyword-as">as</span> dept_name<span class="token punctuation">,</span>
        <span class="token function">SUM</span><span class="token punctuation">(</span>BTS_Daily_Summary_SampleCount<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> dc_sample_count
    <span class="token keyword keyword-FROM">FROM</span> BTS_Daily_Summary
    <span class="token keyword keyword-WHERE">WHERE</span> <span class="token keyword keyword-LEFT">LEFT</span><span class="token punctuation">(</span>BTS_Daily_Summary_SummaryDate<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">FORMAT</span><span class="token punctuation">(</span>DATEADD<span class="token punctuation">(</span><span class="token keyword keyword-month">month</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'yyyyMM'</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-GROUP">GROUP</span> <span class="token keyword keyword-BY">BY</span> <span class="token keyword keyword-LEFT">LEFT</span><span class="token punctuation">(</span>BTS_Daily_Summary_SummaryDate<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> BTS_Daily_Summary_DeptName
<span class="token punctuation">)</span> dc_summary
<span class="token keyword keyword-FULL">FULL</span> <span class="token keyword keyword-OUTER">OUTER</span> <span class="token keyword keyword-JOIN">JOIN</span> <span class="token punctuation">(</span>
    <span class="token keyword keyword-SELECT">SELECT</span> 
        MDR_BTS_Monthly_Summary_SummaryYearMonth <span class="token keyword keyword-as">as</span> summary_date<span class="token punctuation">,</span>
        MDR_BTS_Monthly_Summary_DeptName <span class="token keyword keyword-as">as</span> dept_name<span class="token punctuation">,</span>
        MDR_BTS_Monthly_Summary_CurrentSampleCount <span class="token keyword keyword-as">as</span> mdr_sample_count
    <span class="token keyword keyword-FROM">FROM</span> MDR_BTS_Monthly_Summary
    <span class="token keyword keyword-WHERE">WHERE</span> MDR_BTS_Monthly_Summary_SummaryYearMonth <span class="token operator">=</span> <span class="token function">FORMAT</span><span class="token punctuation">(</span>DATEADD<span class="token punctuation">(</span><span class="token keyword keyword-month">month</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'yyyyMM'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> mdr_summary <span class="token keyword keyword-ON">ON</span> dc_summary<span class="token punctuation">.</span>summary_date <span class="token operator">=</span> mdr_summary<span class="token punctuation">.</span>summary_date <span class="token operator">AND</span> dc_summary<span class="token punctuation">.</span>dept_name <span class="token operator">=</span> mdr_summary<span class="token punctuation">.</span>dept_name
<span class="token keyword keyword-WHERE">WHERE</span> ABS<span class="token punctuation">(</span>ISNULL<span class="token punctuation">(</span>dc_summary<span class="token punctuation">.</span>dc_sample_count<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">-</span> ISNULL<span class="token punctuation">(</span>mdr_summary<span class="token punctuation">.</span>mdr_sample_count<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre><h2 id="七-实施计划与里程碑">七、实施计划与里程碑 </h2>
<h3 id="71-实施阶段规划">7.1 实施阶段规划 </h3>
<table>
<thead>
<tr>
<th>阶段</th>
<th>主要任务</th>
<th>预计工期</th>
<th>交付物</th>
<th>成功标准</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>第一阶段</strong></td>
<td>DC层核心明细表建设</td>
<td>2周</td>
<td>BTS_Requisition_Main、BTS_Blood_Detail</td>
<td>数据完整性&gt;95%，关键字段覆盖率100%</td>
</tr>
<tr>
<td><strong>第二阶段</strong></td>
<td>检验和工作量表建设</td>
<td>2周</td>
<td>BTS_Lab_Test、BTS_Work_Record</td>
<td>工作量统计准确率&gt;98%，检验数据完整性&gt;95%</td>
</tr>
<tr>
<td><strong>第三阶段</strong></td>
<td>汇总表和MDR主题表</td>
<td>2周</td>
<td>BTS_Daily_Summary、MDR_BTS_Monthly_Summary</td>
<td>汇总数据与明细数据一致性&gt;99%</td>
</tr>
<tr>
<td><strong>第四阶段</strong></td>
<td>收入集成和报表应用</td>
<td>1周</td>
<td>收入数据集成、报表原型</td>
<td>收入数据准确性&gt;99%，报表响应时间&lt;5秒</td>
</tr>
</tbody>
</table>
<h3 id="72-关键里程碑">7.2 关键里程碑 </h3>
<ul>
<li><strong>里程碑1</strong>：DC层明细数据表上线，支持基础数据查询</li>
<li><strong>里程碑2</strong>：工作量统计功能完成，支持4类工作量统计</li>
<li><strong>里程碑3</strong>：月度汇总主题表上线，支持环比同比分析</li>
<li><strong>里程碑4</strong>：完整报表系统上线，支持输血科运营分析</li>
</ul>
<h3 id="73-风险控制">7.3 风险控制 </h3>
<table>
<thead>
<tr>
<th>风险类型</th>
<th>风险描述</th>
<th>影响程度</th>
<th>应对措施</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>数据质量风险</strong></td>
<td>源系统数据质量问题导致统计偏差</td>
<td>高</td>
<td>建立数据质量监控机制，设置数据异常告警</td>
</tr>
<tr>
<td><strong>性能风险</strong></td>
<td>大数据量查询导致系统响应慢</td>
<td>中</td>
<td>合理设计索引，采用分批处理和增量更新</td>
</tr>
<tr>
<td><strong>业务理解风险</strong></td>
<td>工作量统计逻辑理解偏差</td>
<td>中</td>
<td>与业务方深度沟通，制定详细测试用例</td>
</tr>
<tr>
<td><strong>技术风险</strong></td>
<td>多系统集成复杂度高</td>
<td>中</td>
<td>采用标准化接口，建立完善的错误处理机制</td>
</tr>
</tbody>
</table>
<h3 id="74-成功验收标准">7.4 成功验收标准 </h3>
<ol>
<li><strong>数据准确性</strong>：与财务系统核对误差&lt;±0.5%</li>
<li><strong>系统性能</strong>：完整页面加载&lt;5秒，明细筛选&lt;2秒</li>
<li><strong>功能完整性</strong>：支持环比、同比分析，支持按科室、血液类型、时间维度筛选</li>
<li><strong>用户体验</strong>：UI与设计稿一致，筛选、导出、告警功能正常</li>
<li><strong>系统稳定性</strong>：刷新任务稳定执行，数据更新及时准确</li>
</ol>
<p>通过本设计方案，将建立完整的输血科运营分析数据架构，支持院领导和科室管理层进行科学的运营决策，提升输血科的运营效率和服务质量。</p>
<h2 id="四-数据血缘关系设计">四、数据血缘关系设计 </h2>
<h3 id="41-核心数据流向">4.1 核心数据流向 </h3>
<div class="mermaid">graph TB
    subgraph "DL层(ODS) - 数据湖层"
        DL1[LIS_REQUISITION_INFO&lt;br/&gt;检验申请主表]
        DL2[LIS_REQUISITION_ITEM&lt;br/&gt;检验项目明细]  
        DL3[BIS_REQUISITION_INFO&lt;br/&gt;输血申请信息]
        DL4[BIS_BLOOD_INPUT&lt;br/&gt;血袋信息]
        DL5[BIS6_BLOODBAG_INPUT&lt;br/&gt;血袋入库信息]
        DL6[Apply_BloodTrans&lt;br/&gt;现有DC申请表]
        DL7[Fee_BillDet&lt;br/&gt;现有DC收费表]
    end
    
    subgraph "DC层 - 数据中心层"
        DC1[LIS_Sample_Main&lt;br/&gt;检验标本主表&lt;br/&gt;(复用LIS主题)]
        DC2[BTS_Blood_Detail&lt;br/&gt;血液明细表&lt;br/&gt;(新增)]
        DC3[BTS_Work_Record&lt;br/&gt;工作量记录表&lt;br/&gt;(新增)]
        DC4[BTS_Daily_Summary&lt;br/&gt;日度汇总大宽表&lt;br/&gt;(新增)]
        DC5[BTS_BloodStock_Monthly&lt;br/&gt;血液库存月度汇总表&lt;br/&gt;(新增)]
    end
    
    subgraph "应用层"
        APP1[输血科运营分析报表]
        APP2[血液库存管理分析]
        APP3[工作量绩效分析]
        APP4[收入成本分析]
    end
    
    DL1 --&gt; DC1
    DL2 --&gt; DC1
    DL3 --&gt; DC2
    DL4 --&gt; DC2
    DL5 --&gt; DC2
    DL1 --&gt; DC3
    DL2 --&gt; DC3
    DL3 --&gt; DC3
    DL4 --&gt; DC3
    DL6 --&gt; DC1
    DL7 --&gt; DC4
    
    DC1 --&gt; DC3
    DC2 --&gt; DC3
    DC2 --&gt; DC5
    
    DC1 --&gt; DC4
    DC2 --&gt; DC4
    DC3 --&gt; DC4
    
    DC4 --&gt; APP1
    DC4 --&gt; APP3
    DC4 --&gt; APP4
    DC5 --&gt; APP2
    
    %% 样式
    classDef dlStyle fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef dcStyle fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef newStyle fill:#e8f5e8,stroke:#388e3c,stroke-width:3px
    classDef appStyle fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    
    class DL1,DL2,DL3,DL4,DL5,DL6,DL7 dlStyle
    class DC1 dcStyle
    class DC2,DC3,DC4,DC5 newStyle
    class APP1,APP2,APP3,APP4 appStyle
</div><h3 id="42-关键血缘关系">4.2 关键血缘关系 </h3>
<h4 id="421-样本数指标血缘">4.2.1 样本数指标血缘 </h4>
<ul>
<li><strong>数据源</strong>：LIS_REQUISITION_INFO（输血相关检验） + BIS_REQUISITION_INFO（输血申请）</li>
<li><strong>处理逻辑</strong>：按样本ID去重统计，支持双系统样本整合</li>
<li><strong>最终呈现</strong>：MDR层样本数量指标</li>
</ul>
<h4 id="422-检测项目数指标血缘">4.2.2 检测项目数指标血缘 </h4>
<ul>
<li><strong>数据源</strong>：LIS_REQUISITION_ITEM（血型检测、抗体筛查、交叉配血等项目）</li>
<li><strong>处理逻辑</strong>：按检验项目ID统计，分类汇总</li>
<li><strong>最终呈现</strong>：MDR层检测项目数指标</li>
</ul>
<h4 id="423-工作量指标血缘">4.2.3 工作量指标血缘 </h4>
<ul>
<li><strong>数据源</strong>：多系统操作记录（样本检测、血液管理、输血治疗、血液管理）</li>
<li><strong>处理逻辑</strong>：按操作类型分类统计，每次操作计数1</li>
<li><strong>最终呈现</strong>：MDR层四大类工作量指标</li>
</ul>
<h4 id="424-收入指标血缘">4.2.4 收入指标血缘 </h4>
<ul>
<li><strong>数据源</strong>：Fee_BillDet（现有DC收费表）</li>
<li><strong>处理逻辑</strong>：按收费项目类型分类（配血检收入、血费收入、输血治疗收入）</li>
<li><strong>最终呈现</strong>：MDR层三类收入指标</li>
</ul>
<h4 id="425-支出指标血缘">4.2.5 支出指标血缘 </h4>
<ul>
<li><strong>数据源</strong>：血站系统（血费支出）+ 试剂库系统（试剂支出）</li>
<li><strong>处理逻辑</strong>：按成本类型统计</li>
<li><strong>最终呈现</strong>：MDR层两类支出指标</li>
</ul>
<h3 id="43-环比同比计算逻辑">4.3 环比同比计算逻辑 </h3>
<h4 id="431-环比计算2024-08-vs-2024-07">4.3.1 环比计算（2024-08 vs 2024-07） </h4>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token comment">-- 环比变化率计算示例</span>
<span class="token keyword keyword-SELECT">SELECT</span> 
    SummaryYearMonth<span class="token punctuation">,</span>
    CurrentSampleCount<span class="token punctuation">,</span>
    LAG<span class="token punctuation">(</span>CurrentSampleCount<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword keyword-OVER">OVER</span> <span class="token punctuation">(</span><span class="token keyword keyword-ORDER">ORDER</span> <span class="token keyword keyword-BY">BY</span> SummaryYearMonth<span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> LastMonthSampleCount<span class="token punctuation">,</span>
    <span class="token keyword keyword-CASE">CASE</span> 
        <span class="token keyword keyword-WHEN">WHEN</span> LAG<span class="token punctuation">(</span>CurrentSampleCount<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword keyword-OVER">OVER</span> <span class="token punctuation">(</span><span class="token keyword keyword-ORDER">ORDER</span> <span class="token keyword keyword-BY">BY</span> SummaryYearMonth<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> 
        <span class="token keyword keyword-THEN">THEN</span> <span class="token punctuation">(</span>CurrentSampleCount <span class="token operator">-</span> LAG<span class="token punctuation">(</span>CurrentSampleCount<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword keyword-OVER">OVER</span> <span class="token punctuation">(</span><span class="token keyword keyword-ORDER">ORDER</span> <span class="token keyword keyword-BY">BY</span> SummaryYearMonth<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100.0</span> <span class="token operator">/</span> LAG<span class="token punctuation">(</span>CurrentSampleCount<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword keyword-OVER">OVER</span> <span class="token punctuation">(</span><span class="token keyword keyword-ORDER">ORDER</span> <span class="token keyword keyword-BY">BY</span> SummaryYearMonth<span class="token punctuation">)</span>
        <span class="token keyword keyword-ELSE">ELSE</span> <span class="token boolean">NULL</span> 
    <span class="token keyword keyword-END">END</span> <span class="token keyword keyword-AS">AS</span> SampleCountMoMRate
<span class="token keyword keyword-FROM">FROM</span> MDR_BTS_Monthly_Summary
<span class="token keyword keyword-WHERE">WHERE</span> SummaryYearMonth <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'202407'</span><span class="token punctuation">,</span> <span class="token string">'202408'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h4 id="432-同比计算2024-08-vs-2023-08">4.3.2 同比计算（2024-08 vs 2023-08） </h4>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token comment">-- 同比变化率计算示例  </span>
<span class="token keyword keyword-SELECT">SELECT</span> 
    SummaryYearMonth<span class="token punctuation">,</span>
    CurrentSampleCount<span class="token punctuation">,</span>
    LAG<span class="token punctuation">(</span>CurrentSampleCount<span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token keyword keyword-OVER">OVER</span> <span class="token punctuation">(</span><span class="token keyword keyword-ORDER">ORDER</span> <span class="token keyword keyword-BY">BY</span> SummaryYearMonth<span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> LastYearSampleCount<span class="token punctuation">,</span>
    <span class="token keyword keyword-CASE">CASE</span> 
        <span class="token keyword keyword-WHEN">WHEN</span> LAG<span class="token punctuation">(</span>CurrentSampleCount<span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token keyword keyword-OVER">OVER</span> <span class="token punctuation">(</span><span class="token keyword keyword-ORDER">ORDER</span> <span class="token keyword keyword-BY">BY</span> SummaryYearMonth<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> 
        <span class="token keyword keyword-THEN">THEN</span> <span class="token punctuation">(</span>CurrentSampleCount <span class="token operator">-</span> LAG<span class="token punctuation">(</span>CurrentSampleCount<span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token keyword keyword-OVER">OVER</span> <span class="token punctuation">(</span><span class="token keyword keyword-ORDER">ORDER</span> <span class="token keyword keyword-BY">BY</span> SummaryYearMonth<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100.0</span> <span class="token operator">/</span> LAG<span class="token punctuation">(</span>CurrentSampleCount<span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token keyword keyword-OVER">OVER</span> <span class="token punctuation">(</span><span class="token keyword keyword-ORDER">ORDER</span> <span class="token keyword keyword-BY">BY</span> SummaryYearMonth<span class="token punctuation">)</span>
        <span class="token keyword keyword-ELSE">ELSE</span> <span class="token boolean">NULL</span> 
    <span class="token keyword keyword-END">END</span> <span class="token keyword keyword-AS">AS</span> SampleCountYoYRate
<span class="token keyword keyword-FROM">FROM</span> MDR_BTS_Monthly_Summary
<span class="token keyword keyword-WHERE">WHERE</span> SummaryYearMonth <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'202308'</span><span class="token punctuation">,</span> <span class="token string">'202408'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h2 id="五-数据处理逻辑">五、数据处理逻辑 </h2>
<h3 id="51-dc层集成处理逻辑">5.1 DC层集成处理逻辑 </h3>
<h4 id="511-lis_sample_main输血样本筛选">5.1.1 LIS_Sample_Main输血样本筛选 </h4>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token comment">-- 输血相关样本筛选逻辑（基于已有LIS主题表）</span>
<span class="token keyword keyword-WITH">WITH</span> BloodTransfusion_Samples <span class="token keyword keyword-AS">AS</span> <span class="token punctuation">(</span>
    <span class="token keyword keyword-SELECT">SELECT</span> 
        LIS_Sample_Main_SampleID<span class="token punctuation">,</span>
        LIS_Sample_Main_SampleDate<span class="token punctuation">,</span> 
        LIS_Sample_Main_DeptName<span class="token punctuation">,</span>
        LIS_Sample_Main_TestPurpose<span class="token punctuation">,</span>
        LIS_Sample_Main_ItemCode<span class="token punctuation">,</span>
        LIS_Sample_Main_BloodTypeABO<span class="token punctuation">,</span>
        LIS_Sample_Main_BloodTypeRh<span class="token punctuation">,</span>
        LIS_Sample_Main_SampleStatus
    <span class="token keyword keyword-FROM">FROM</span> LIS_Sample_Main
    <span class="token keyword keyword-WHERE">WHERE</span> <span class="token punctuation">(</span>
        LIS_Sample_Main_TestPurpose <span class="token operator">LIKE</span> <span class="token string">'%血型%'</span> 
        <span class="token operator">OR</span> LIS_Sample_Main_TestPurpose <span class="token operator">LIKE</span> <span class="token string">'%配血%'</span> 
        <span class="token operator">OR</span> LIS_Sample_Main_TestPurpose <span class="token operator">LIKE</span> <span class="token string">'%抗体%'</span>
        <span class="token operator">OR</span> LIS_Sample_Main_TestPurpose <span class="token operator">LIKE</span> <span class="token string">'%输血%'</span>
        <span class="token operator">OR</span> LIS_Sample_Main_ItemCode <span class="token operator">IN</span> <span class="token punctuation">(</span>
            <span class="token string">'LIS07068'</span><span class="token punctuation">,</span> <span class="token string">'LIS05'</span><span class="token punctuation">,</span> <span class="token string">'LIS0300255'</span><span class="token punctuation">,</span> <span class="token string">'LIS0300114'</span><span class="token punctuation">,</span>  <span class="token comment">-- 血型检测</span>
            <span class="token string">'LIS07073'</span><span class="token punctuation">,</span>                                        <span class="token comment">-- 抗体筛查</span>
            <span class="token string">'LIS07156'</span><span class="token punctuation">,</span> <span class="token string">'LIS07157'</span><span class="token punctuation">,</span> <span class="token string">'LIS07153'</span><span class="token punctuation">,</span>               <span class="token comment">-- 交叉配血</span>
            <span class="token string">'LIS07079'</span><span class="token punctuation">,</span>                                        <span class="token comment">-- 直接抗人球蛋白试验</span>
            <span class="token string">'LIS07072'</span><span class="token punctuation">,</span> <span class="token string">'LIS07074'</span><span class="token punctuation">,</span> <span class="token string">'LIS07075'</span><span class="token punctuation">,</span> <span class="token string">'LIS07077'</span><span class="token punctuation">,</span>   <span class="token comment">-- 疑难样本</span>
            <span class="token string">'LIS026801'</span><span class="token punctuation">,</span>                                       <span class="token comment">-- 血小板交叉配血</span>
            <span class="token string">'LIS026797'</span><span class="token punctuation">,</span>                                       <span class="token comment">-- 血小板抗体检测</span>
            <span class="token string">'LIS030072'</span><span class="token punctuation">,</span> <span class="token string">'LIS030073'</span><span class="token punctuation">,</span> <span class="token string">'LIS030075'</span><span class="token punctuation">,</span>            <span class="token comment">-- 抗体效价</span>
            <span class="token string">'LIS028043'</span>                                        <span class="token comment">-- Rh分型</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token operator">AND</span> LIS_Sample_Main_SampleDate <span class="token operator">&gt;=</span> <span class="token function">FORMAT</span><span class="token punctuation">(</span>DATEADD<span class="token punctuation">(</span><span class="token keyword keyword-month">month</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">13</span><span class="token punctuation">,</span> GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'yyyyMMdd'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword keyword-SELECT">SELECT</span> <span class="token operator">*</span> <span class="token keyword keyword-FROM">FROM</span> BloodTransfusion_Samples<span class="token punctuation">;</span>
</code></pre><h4 id="512-bts_work_record工作量统计">5.1.2 BTS_Work_Record工作量统计 </h4>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token comment">-- 工作量记录表数据集成逻辑</span>
<span class="token keyword keyword-INSERT">INSERT</span> <span class="token keyword keyword-INTO">INTO</span> BTS_Work_Record
<span class="token keyword keyword-SELECT">SELECT</span> 
    <span class="token string">'001'</span> <span class="token keyword keyword-AS">AS</span> MedOrgCode<span class="token punctuation">,</span>
    CONCAT<span class="token punctuation">(</span><span class="token string">'SAMPLE_'</span><span class="token punctuation">,</span> LIS_Sample_Main_SampleID<span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">,</span> LIS_Sample_Main_ItemCode<span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> WorkID<span class="token punctuation">,</span>
    LIS_Sample_Main_SampleDate <span class="token keyword keyword-AS">AS</span> WorkDate<span class="token punctuation">,</span>
    <span class="token string">'SAMPLE'</span> <span class="token keyword keyword-AS">AS</span> WorkCategoryCode<span class="token punctuation">,</span>
    <span class="token string">'样本检测'</span> <span class="token keyword keyword-AS">AS</span> WorkCategoryName<span class="token punctuation">,</span>
    <span class="token keyword keyword-CASE">CASE</span> 
        <span class="token keyword keyword-WHEN">WHEN</span> LIS_Sample_Main_ItemCode <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'LIS07068'</span><span class="token punctuation">,</span> <span class="token string">'LIS05'</span><span class="token punctuation">,</span> <span class="token string">'LIS0300255'</span><span class="token punctuation">,</span> <span class="token string">'LIS0300114'</span><span class="token punctuation">)</span> <span class="token keyword keyword-THEN">THEN</span> <span class="token string">'BLOOD_TYPE'</span>
        <span class="token keyword keyword-WHEN">WHEN</span> LIS_Sample_Main_ItemCode <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'LIS07073'</span><span class="token punctuation">)</span> <span class="token keyword keyword-THEN">THEN</span> <span class="token string">'ANTIBODY'</span>  
        <span class="token keyword keyword-WHEN">WHEN</span> LIS_Sample_Main_ItemCode <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'LIS07156'</span><span class="token punctuation">,</span> <span class="token string">'LIS07157'</span><span class="token punctuation">,</span> <span class="token string">'LIS07153'</span><span class="token punctuation">)</span> <span class="token keyword keyword-THEN">THEN</span> <span class="token string">'CROSS_MATCH'</span>
        <span class="token keyword keyword-WHEN">WHEN</span> LIS_Sample_Main_ItemCode <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'LIS07079'</span><span class="token punctuation">)</span> <span class="token keyword keyword-THEN">THEN</span> <span class="token string">'DIRECT_ANTI'</span>
        <span class="token keyword keyword-WHEN">WHEN</span> LIS_Sample_Main_ItemCode <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'LIS07072'</span><span class="token punctuation">,</span> <span class="token string">'LIS07074'</span><span class="token punctuation">,</span> <span class="token string">'LIS07075'</span><span class="token punctuation">,</span> <span class="token string">'LIS07077'</span><span class="token punctuation">)</span> <span class="token keyword keyword-THEN">THEN</span> <span class="token string">'DIFFICULT'</span>
        <span class="token keyword keyword-WHEN">WHEN</span> LIS_Sample_Main_ItemCode <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'LIS026801'</span><span class="token punctuation">)</span> <span class="token keyword keyword-THEN">THEN</span> <span class="token string">'PLATELET_CROSS'</span>
        <span class="token keyword keyword-WHEN">WHEN</span> LIS_Sample_Main_ItemCode <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'LIS026797'</span><span class="token punctuation">)</span> <span class="token keyword keyword-THEN">THEN</span> <span class="token string">'PLATELET_ANTIBODY'</span>
        <span class="token keyword keyword-WHEN">WHEN</span> LIS_Sample_Main_ItemCode <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'LIS030072'</span><span class="token punctuation">,</span> <span class="token string">'LIS030073'</span><span class="token punctuation">,</span> <span class="token string">'LIS030075'</span><span class="token punctuation">)</span> <span class="token keyword keyword-THEN">THEN</span> <span class="token string">'ANTIBODY_TITER'</span>
        <span class="token keyword keyword-WHEN">WHEN</span> LIS_Sample_Main_ItemCode <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'LIS028043'</span><span class="token punctuation">)</span> <span class="token keyword keyword-THEN">THEN</span> <span class="token string">'RH_TYPING'</span>
        <span class="token keyword keyword-ELSE">ELSE</span> <span class="token string">'OTHER'</span>
    <span class="token keyword keyword-END">END</span> <span class="token keyword keyword-AS">AS</span> WorkTypeCode<span class="token punctuation">,</span>
    <span class="token keyword keyword-CASE">CASE</span> 
        <span class="token keyword keyword-WHEN">WHEN</span> LIS_Sample_Main_ItemCode <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'LIS07068'</span><span class="token punctuation">,</span> <span class="token string">'LIS05'</span><span class="token punctuation">,</span> <span class="token string">'LIS0300255'</span><span class="token punctuation">,</span> <span class="token string">'LIS0300114'</span><span class="token punctuation">)</span> <span class="token keyword keyword-THEN">THEN</span> <span class="token string">'血型检测'</span>
        <span class="token keyword keyword-WHEN">WHEN</span> LIS_Sample_Main_ItemCode <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'LIS07073'</span><span class="token punctuation">)</span> <span class="token keyword keyword-THEN">THEN</span> <span class="token string">'抗体筛查'</span>  
        <span class="token keyword keyword-WHEN">WHEN</span> LIS_Sample_Main_ItemCode <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'LIS07156'</span><span class="token punctuation">,</span> <span class="token string">'LIS07157'</span><span class="token punctuation">,</span> <span class="token string">'LIS07153'</span><span class="token punctuation">)</span> <span class="token keyword keyword-THEN">THEN</span> <span class="token string">'交叉配血'</span>
        <span class="token keyword keyword-WHEN">WHEN</span> LIS_Sample_Main_ItemCode <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'LIS07079'</span><span class="token punctuation">)</span> <span class="token keyword keyword-THEN">THEN</span> <span class="token string">'直接抗人球蛋白试验'</span>
        <span class="token keyword keyword-WHEN">WHEN</span> LIS_Sample_Main_ItemCode <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'LIS07072'</span><span class="token punctuation">,</span> <span class="token string">'LIS07074'</span><span class="token punctuation">,</span> <span class="token string">'LIS07075'</span><span class="token punctuation">,</span> <span class="token string">'LIS07077'</span><span class="token punctuation">)</span> <span class="token keyword keyword-THEN">THEN</span> <span class="token string">'疑难样本'</span>
        <span class="token keyword keyword-WHEN">WHEN</span> LIS_Sample_Main_ItemCode <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'LIS026801'</span><span class="token punctuation">)</span> <span class="token keyword keyword-THEN">THEN</span> <span class="token string">'血小板交叉配血'</span>
        <span class="token keyword keyword-WHEN">WHEN</span> LIS_Sample_Main_ItemCode <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'LIS026797'</span><span class="token punctuation">)</span> <span class="token keyword keyword-THEN">THEN</span> <span class="token string">'血小板抗体检测'</span>
        <span class="token keyword keyword-WHEN">WHEN</span> LIS_Sample_Main_ItemCode <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'LIS030072'</span><span class="token punctuation">,</span> <span class="token string">'LIS030073'</span><span class="token punctuation">,</span> <span class="token string">'LIS030075'</span><span class="token punctuation">)</span> <span class="token keyword keyword-THEN">THEN</span> <span class="token string">'抗体效价'</span>
        <span class="token keyword keyword-WHEN">WHEN</span> LIS_Sample_Main_ItemCode <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'LIS028043'</span><span class="token punctuation">)</span> <span class="token keyword keyword-THEN">THEN</span> <span class="token string">'Rh分型'</span>
        <span class="token keyword keyword-ELSE">ELSE</span> <span class="token string">'其他'</span>
    <span class="token keyword keyword-END">END</span> <span class="token keyword keyword-AS">AS</span> WorkTypeName<span class="token punctuation">,</span>
    <span class="token number">1</span> <span class="token keyword keyword-AS">AS</span> WorkCount<span class="token punctuation">,</span>
    LIS_Sample_Main_TestPerson <span class="token keyword keyword-AS">AS</span> OperatorName
<span class="token keyword keyword-FROM">FROM</span> LIS_Sample_Main
<span class="token keyword keyword-WHERE">WHERE</span> LIS_Sample_Main_ItemCode <span class="token operator">IN</span> <span class="token punctuation">(</span>
    <span class="token string">'LIS07068'</span><span class="token punctuation">,</span> <span class="token string">'LIS05'</span><span class="token punctuation">,</span> <span class="token string">'LIS0300255'</span><span class="token punctuation">,</span> <span class="token string">'LIS0300114'</span><span class="token punctuation">,</span>  <span class="token comment">-- 血型检测</span>
    <span class="token string">'LIS07073'</span><span class="token punctuation">,</span>                                        <span class="token comment">-- 抗体筛查</span>
    <span class="token string">'LIS07156'</span><span class="token punctuation">,</span> <span class="token string">'LIS07157'</span><span class="token punctuation">,</span> <span class="token string">'LIS07153'</span><span class="token punctuation">,</span>               <span class="token comment">-- 交叉配血</span>
    <span class="token string">'LIS07079'</span><span class="token punctuation">,</span>                                        <span class="token comment">-- 直接抗人球蛋白试验</span>
    <span class="token string">'LIS07072'</span><span class="token punctuation">,</span> <span class="token string">'LIS07074'</span><span class="token punctuation">,</span> <span class="token string">'LIS07075'</span><span class="token punctuation">,</span> <span class="token string">'LIS07077'</span><span class="token punctuation">,</span>   <span class="token comment">-- 疑难样本</span>
    <span class="token string">'LIS026801'</span><span class="token punctuation">,</span>                                       <span class="token comment">-- 血小板交叉配血</span>
    <span class="token string">'LIS026797'</span><span class="token punctuation">,</span>                                       <span class="token comment">-- 血小板抗体检测</span>
    <span class="token string">'LIS030072'</span><span class="token punctuation">,</span> <span class="token string">'LIS030073'</span><span class="token punctuation">,</span> <span class="token string">'LIS030075'</span><span class="token punctuation">,</span>            <span class="token comment">-- 抗体效价</span>
    <span class="token string">'LIS028043'</span>                                        <span class="token comment">-- Rh分型</span>
<span class="token punctuation">)</span>
<span class="token operator">AND</span> LIS_Sample_Main_TestStatus <span class="token operator">=</span> <span class="token string">'已完成'</span>

<span class="token keyword keyword-UNION">UNION</span> <span class="token keyword keyword-ALL">ALL</span>

<span class="token comment">-- 血液管理工作量</span>
<span class="token keyword keyword-SELECT">SELECT</span> 
    <span class="token string">'001'</span> <span class="token keyword keyword-AS">AS</span> MedOrgCode<span class="token punctuation">,</span>
    CONCAT<span class="token punctuation">(</span><span class="token string">'BLOOD_'</span><span class="token punctuation">,</span> BTS_Blood_Detail_BloodID<span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> WorkID<span class="token punctuation">,</span>
    BTS_Blood_Detail_BloodDate <span class="token keyword keyword-AS">AS</span> WorkDate<span class="token punctuation">,</span>
    <span class="token string">'BLOOD'</span> <span class="token keyword keyword-AS">AS</span> WorkCategoryCode<span class="token punctuation">,</span>
    <span class="token string">'临床用血'</span> <span class="token keyword keyword-AS">AS</span> WorkCategoryName<span class="token punctuation">,</span>
    BTS_Blood_Detail_OperationType <span class="token keyword keyword-AS">AS</span> WorkTypeCode<span class="token punctuation">,</span>
    <span class="token keyword keyword-CASE">CASE</span> BTS_Blood_Detail_OperationType
        <span class="token keyword keyword-WHEN">WHEN</span> <span class="token string">'INBOUND'</span> <span class="token keyword keyword-THEN">THEN</span> <span class="token string">'血液入库'</span>
        <span class="token keyword keyword-WHEN">WHEN</span> <span class="token string">'OUTBOUND'</span> <span class="token keyword keyword-THEN">THEN</span> <span class="token string">'血液出库'</span>
        <span class="token keyword keyword-WHEN">WHEN</span> <span class="token string">'INVENTORY'</span> <span class="token keyword keyword-THEN">THEN</span> <span class="token string">'血液盘存'</span>
        <span class="token keyword keyword-ELSE">ELSE</span> <span class="token string">'血液管理'</span>
    <span class="token keyword keyword-END">END</span> <span class="token keyword keyword-AS">AS</span> WorkTypeName<span class="token punctuation">,</span>
    <span class="token number">1</span> <span class="token keyword keyword-AS">AS</span> WorkCount<span class="token punctuation">,</span>
    BTS_Blood_Detail_OperatorName <span class="token keyword keyword-AS">AS</span> OperatorName
<span class="token keyword keyword-FROM">FROM</span> BTS_Blood_Detail
<span class="token keyword keyword-WHERE">WHERE</span> BTS_Blood_Detail_OperationType <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
</code></pre><h3 id="52-dc层日度汇总大宽表生成逻辑">5.2 DC层日度汇总大宽表生成逻辑 </h3>
<h4 id="521-bts_daily_summary日度汇总表生成">5.2.1 BTS_Daily_Summary日度汇总表生成 </h4>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token comment">-- 输血科日度汇总大宽表数据生成</span>
<span class="token keyword keyword-INSERT">INSERT</span> <span class="token keyword keyword-INTO">INTO</span> BTS_Daily_Summary
<span class="token keyword keyword-WITH">WITH</span> daily_base <span class="token keyword keyword-AS">AS</span> <span class="token punctuation">(</span>
    <span class="token comment">-- 基础样本和检测数据（基于LIS主题表）</span>
    <span class="token keyword keyword-SELECT">SELECT</span> 
        sample<span class="token punctuation">.</span>LIS_Sample_Main_SampleDate <span class="token keyword keyword-AS">AS</span> summary_date<span class="token punctuation">,</span>
        sample<span class="token punctuation">.</span>LIS_Sample_Main_DeptName <span class="token keyword keyword-AS">AS</span> dept_name<span class="token punctuation">,</span>
        blood<span class="token punctuation">.</span>BTS_Blood_Detail_BloodBankCode <span class="token keyword keyword-AS">AS</span> blood_bank_code<span class="token punctuation">,</span>
        blood<span class="token punctuation">.</span>BTS_Blood_Detail_BloodBankName <span class="token keyword keyword-AS">AS</span> blood_bank_name<span class="token punctuation">,</span>
        blood<span class="token punctuation">.</span>BTS_Blood_Detail_BloodTypeName <span class="token keyword keyword-AS">AS</span> blood_type_name<span class="token punctuation">,</span>
        
        <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword keyword-DISTINCT">DISTINCT</span> sample<span class="token punctuation">.</span>LIS_Sample_Main_SampleID<span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> sample_count<span class="token punctuation">,</span>
        <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword keyword-DISTINCT">DISTINCT</span> <span class="token keyword keyword-CASE">CASE</span> <span class="token keyword keyword-WHEN">WHEN</span> sample<span class="token punctuation">.</span>LIS_Sample_Main_ItemCode <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'LIS07068'</span><span class="token punctuation">,</span> <span class="token string">'LIS05'</span><span class="token punctuation">,</span> <span class="token string">'LIS0300255'</span><span class="token punctuation">,</span> <span class="token string">'LIS0300114'</span><span class="token punctuation">)</span> <span class="token keyword keyword-THEN">THEN</span> sample<span class="token punctuation">.</span>LIS_Sample_Main_SampleID <span class="token keyword keyword-END">END</span><span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> blood_type_test_count<span class="token punctuation">,</span>
        <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword keyword-DISTINCT">DISTINCT</span> <span class="token keyword keyword-CASE">CASE</span> <span class="token keyword keyword-WHEN">WHEN</span> sample<span class="token punctuation">.</span>LIS_Sample_Main_ItemCode <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'LIS07073'</span><span class="token punctuation">)</span> <span class="token keyword keyword-THEN">THEN</span> sample<span class="token punctuation">.</span>LIS_Sample_Main_SampleID <span class="token keyword keyword-END">END</span><span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> antibody_screen_count<span class="token punctuation">,</span>
        <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword keyword-DISTINCT">DISTINCT</span> <span class="token keyword keyword-CASE">CASE</span> <span class="token keyword keyword-WHEN">WHEN</span> sample<span class="token punctuation">.</span>LIS_Sample_Main_ItemCode <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'LIS07156'</span><span class="token punctuation">,</span> <span class="token string">'LIS07157'</span><span class="token punctuation">,</span> <span class="token string">'LIS07153'</span><span class="token punctuation">)</span> <span class="token keyword keyword-THEN">THEN</span> sample<span class="token punctuation">.</span>LIS_Sample_Main_SampleID <span class="token keyword keyword-END">END</span><span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> cross_match_count<span class="token punctuation">,</span>
        <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword keyword-DISTINCT">DISTINCT</span> <span class="token keyword keyword-CASE">CASE</span> <span class="token keyword keyword-WHEN">WHEN</span> sample<span class="token punctuation">.</span>LIS_Sample_Main_ItemCode <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'LIS07079'</span><span class="token punctuation">)</span> <span class="token keyword keyword-THEN">THEN</span> sample<span class="token punctuation">.</span>LIS_Sample_Main_SampleID <span class="token keyword keyword-END">END</span><span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> direct_antiglobulin_count<span class="token punctuation">,</span>
        <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword keyword-DISTINCT">DISTINCT</span> <span class="token keyword keyword-CASE">CASE</span> <span class="token keyword keyword-WHEN">WHEN</span> sample<span class="token punctuation">.</span>LIS_Sample_Main_ItemCode <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'LIS07072'</span><span class="token punctuation">,</span> <span class="token string">'LIS07074'</span><span class="token punctuation">,</span> <span class="token string">'LIS07075'</span><span class="token punctuation">,</span> <span class="token string">'LIS07077'</span><span class="token punctuation">)</span> <span class="token keyword keyword-THEN">THEN</span> sample<span class="token punctuation">.</span>LIS_Sample_Main_SampleID <span class="token keyword keyword-END">END</span><span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> difficult_sample_count<span class="token punctuation">,</span>
        <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword keyword-DISTINCT">DISTINCT</span> <span class="token keyword keyword-CASE">CASE</span> <span class="token keyword keyword-WHEN">WHEN</span> sample<span class="token punctuation">.</span>LIS_Sample_Main_ItemCode <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'LIS026801'</span><span class="token punctuation">)</span> <span class="token keyword keyword-THEN">THEN</span> sample<span class="token punctuation">.</span>LIS_Sample_Main_SampleID <span class="token keyword keyword-END">END</span><span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> platelet_cross_match_count<span class="token punctuation">,</span>
        <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword keyword-DISTINCT">DISTINCT</span> <span class="token keyword keyword-CASE">CASE</span> <span class="token keyword keyword-WHEN">WHEN</span> sample<span class="token punctuation">.</span>LIS_Sample_Main_ItemCode <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'LIS026797'</span><span class="token punctuation">)</span> <span class="token keyword keyword-THEN">THEN</span> sample<span class="token punctuation">.</span>LIS_Sample_Main_SampleID <span class="token keyword keyword-END">END</span><span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> platelet_antibody_count<span class="token punctuation">,</span>
        <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword keyword-DISTINCT">DISTINCT</span> <span class="token keyword keyword-CASE">CASE</span> <span class="token keyword keyword-WHEN">WHEN</span> sample<span class="token punctuation">.</span>LIS_Sample_Main_ItemCode <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'LIS030072'</span><span class="token punctuation">,</span> <span class="token string">'LIS030073'</span><span class="token punctuation">,</span> <span class="token string">'LIS030075'</span><span class="token punctuation">)</span> <span class="token keyword keyword-THEN">THEN</span> sample<span class="token punctuation">.</span>LIS_Sample_Main_SampleID <span class="token keyword keyword-END">END</span><span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> antibody_titer_count<span class="token punctuation">,</span>
        <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword keyword-DISTINCT">DISTINCT</span> <span class="token keyword keyword-CASE">CASE</span> <span class="token keyword keyword-WHEN">WHEN</span> sample<span class="token punctuation">.</span>LIS_Sample_Main_ItemCode <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'LIS028043'</span><span class="token punctuation">)</span> <span class="token keyword keyword-THEN">THEN</span> sample<span class="token punctuation">.</span>LIS_Sample_Main_SampleID <span class="token keyword keyword-END">END</span><span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> rh_typing_count
        
    <span class="token keyword keyword-FROM">FROM</span> LIS_Sample_Main sample
    <span class="token keyword keyword-LEFT">LEFT</span> <span class="token keyword keyword-JOIN">JOIN</span> BTS_Blood_Detail blood <span class="token keyword keyword-ON">ON</span> sample<span class="token punctuation">.</span>LIS_Sample_Main_VisitID <span class="token operator">=</span> blood<span class="token punctuation">.</span>关联业务ID
    <span class="token keyword keyword-WHERE">WHERE</span> sample<span class="token punctuation">.</span>LIS_Sample_Main_ItemCode <span class="token operator">IN</span> <span class="token punctuation">(</span>
        <span class="token string">'LIS07068'</span><span class="token punctuation">,</span> <span class="token string">'LIS05'</span><span class="token punctuation">,</span> <span class="token string">'LIS0300255'</span><span class="token punctuation">,</span> <span class="token string">'LIS0300114'</span><span class="token punctuation">,</span>  <span class="token comment">-- 血型检测</span>
        <span class="token string">'LIS07073'</span><span class="token punctuation">,</span>                                        <span class="token comment">-- 抗体筛查</span>
        <span class="token string">'LIS07156'</span><span class="token punctuation">,</span> <span class="token string">'LIS07157'</span><span class="token punctuation">,</span> <span class="token string">'LIS07153'</span><span class="token punctuation">,</span>               <span class="token comment">-- 交叉配血</span>
        <span class="token string">'LIS07079'</span><span class="token punctuation">,</span>                                        <span class="token comment">-- 直接抗人球蛋白试验</span>
        <span class="token string">'LIS07072'</span><span class="token punctuation">,</span> <span class="token string">'LIS07074'</span><span class="token punctuation">,</span> <span class="token string">'LIS07075'</span><span class="token punctuation">,</span> <span class="token string">'LIS07077'</span><span class="token punctuation">,</span>   <span class="token comment">-- 疑难样本</span>
        <span class="token string">'LIS026801'</span><span class="token punctuation">,</span>                                       <span class="token comment">-- 血小板交叉配血</span>
        <span class="token string">'LIS026797'</span><span class="token punctuation">,</span>                                       <span class="token comment">-- 血小板抗体检测</span>
        <span class="token string">'LIS030072'</span><span class="token punctuation">,</span> <span class="token string">'LIS030073'</span><span class="token punctuation">,</span> <span class="token string">'LIS030075'</span><span class="token punctuation">,</span>            <span class="token comment">-- 抗体效价</span>
        <span class="token string">'LIS028043'</span>                                        <span class="token comment">-- Rh分型</span>
    <span class="token punctuation">)</span>
    <span class="token keyword keyword-GROUP">GROUP</span> <span class="token keyword keyword-BY">BY</span> 
        sample<span class="token punctuation">.</span>LIS_Sample_Main_SampleDate<span class="token punctuation">,</span>
        sample<span class="token punctuation">.</span>LIS_Sample_Main_DeptName<span class="token punctuation">,</span>
        blood<span class="token punctuation">.</span>BTS_Blood_Detail_BloodBankCode<span class="token punctuation">,</span>
        blood<span class="token punctuation">.</span>BTS_Blood_Detail_BloodBankName<span class="token punctuation">,</span>
        blood<span class="token punctuation">.</span>BTS_Blood_Detail_BloodTypeName
<span class="token punctuation">)</span><span class="token punctuation">,</span>
blood_data <span class="token keyword keyword-AS">AS</span> <span class="token punctuation">(</span>
    <span class="token comment">-- 血液入库出库数据</span>
    <span class="token keyword keyword-SELECT">SELECT</span> 
        BTS_Blood_Detail_BloodDate <span class="token keyword keyword-AS">AS</span> summary_date<span class="token punctuation">,</span>
        BTS_Blood_Detail_BloodBankCode <span class="token keyword keyword-AS">AS</span> blood_bank_code<span class="token punctuation">,</span>
        BTS_Blood_Detail_BloodBankName <span class="token keyword keyword-AS">AS</span> blood_bank_name<span class="token punctuation">,</span>
        BTS_Blood_Detail_BloodTypeName <span class="token keyword keyword-AS">AS</span> blood_type_name<span class="token punctuation">,</span>
        <span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword keyword-CASE">CASE</span> <span class="token keyword keyword-WHEN">WHEN</span> BTS_Blood_Detail_OperationType <span class="token operator">=</span> <span class="token string">'INBOUND'</span> <span class="token keyword keyword-THEN">THEN</span> <span class="token number">1</span> <span class="token keyword keyword-ELSE">ELSE</span> <span class="token number">0</span> <span class="token keyword keyword-END">END</span><span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> blood_in_count<span class="token punctuation">,</span>
        <span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword keyword-CASE">CASE</span> <span class="token keyword keyword-WHEN">WHEN</span> BTS_Blood_Detail_OperationType <span class="token operator">=</span> <span class="token string">'OUTBOUND'</span> <span class="token keyword keyword-THEN">THEN</span> <span class="token number">1</span> <span class="token keyword keyword-ELSE">ELSE</span> <span class="token number">0</span> <span class="token keyword keyword-END">END</span><span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> blood_out_count<span class="token punctuation">,</span>
        <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword keyword-DISTINCT">DISTINCT</span> BTS_Blood_Detail_BloodID<span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> current_inventory
    <span class="token keyword keyword-FROM">FROM</span> BTS_Blood_Detail
    <span class="token keyword keyword-GROUP">GROUP</span> <span class="token keyword keyword-BY">BY</span> 
        BTS_Blood_Detail_BloodDate<span class="token punctuation">,</span>
        BTS_Blood_Detail_BloodBankCode<span class="token punctuation">,</span>
        BTS_Blood_Detail_BloodBankName<span class="token punctuation">,</span>
        BTS_Blood_Detail_BloodTypeName
<span class="token punctuation">)</span><span class="token punctuation">,</span>
work_data <span class="token keyword keyword-AS">AS</span> <span class="token punctuation">(</span>
    <span class="token comment">-- 工作量数据</span>
    <span class="token keyword keyword-SELECT">SELECT</span> 
        BTS_Work_Record_WorkDate <span class="token keyword keyword-AS">AS</span> summary_date<span class="token punctuation">,</span>
        <span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword keyword-CASE">CASE</span> <span class="token keyword keyword-WHEN">WHEN</span> BTS_Work_Record_WorkCategoryCode <span class="token operator">=</span> <span class="token string">'SAMPLE'</span> <span class="token keyword keyword-THEN">THEN</span> BTS_Work_Record_WorkCount <span class="token keyword keyword-ELSE">ELSE</span> <span class="token number">0</span> <span class="token keyword keyword-END">END</span><span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> sample_work_count<span class="token punctuation">,</span>
        <span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword keyword-CASE">CASE</span> <span class="token keyword keyword-WHEN">WHEN</span> BTS_Work_Record_WorkCategoryCode <span class="token operator">=</span> <span class="token string">'BLOOD'</span> <span class="token keyword keyword-THEN">THEN</span> BTS_Work_Record_WorkCount <span class="token keyword keyword-ELSE">ELSE</span> <span class="token number">0</span> <span class="token keyword keyword-END">END</span><span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> blood_work_count<span class="token punctuation">,</span>
        <span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword keyword-CASE">CASE</span> <span class="token keyword keyword-WHEN">WHEN</span> BTS_Work_Record_WorkCategoryCode <span class="token operator">=</span> <span class="token string">'TREATMENT'</span> <span class="token keyword keyword-THEN">THEN</span> BTS_Work_Record_WorkCount <span class="token keyword keyword-ELSE">ELSE</span> <span class="token number">0</span> <span class="token keyword keyword-END">END</span><span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> treatment_work_count<span class="token punctuation">,</span>
        <span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword keyword-CASE">CASE</span> <span class="token keyword keyword-WHEN">WHEN</span> BTS_Work_Record_WorkCategoryCode <span class="token operator">=</span> <span class="token string">'MANAGE'</span> <span class="token keyword keyword-THEN">THEN</span> BTS_Work_Record_WorkCount <span class="token keyword keyword-ELSE">ELSE</span> <span class="token number">0</span> <span class="token keyword keyword-END">END</span><span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> manage_work_count
    <span class="token keyword keyword-FROM">FROM</span> BTS_Work_Record
    <span class="token keyword keyword-GROUP">GROUP</span> <span class="token keyword keyword-BY">BY</span> BTS_Work_Record_WorkDate
<span class="token punctuation">)</span>
<span class="token keyword keyword-SELECT">SELECT</span> 
    <span class="token string">'001'</span> <span class="token keyword keyword-AS">AS</span> BTS_Daily_Summary_MedOrgCode<span class="token punctuation">,</span>
    CONCAT<span class="token punctuation">(</span>daily_base<span class="token punctuation">.</span>summary_date<span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">,</span> daily_base<span class="token punctuation">.</span>blood_bank_code<span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">,</span> <span class="token keyword keyword-COALESCE">COALESCE</span><span class="token punctuation">(</span>daily_base<span class="token punctuation">.</span>blood_type_name<span class="token punctuation">,</span> <span class="token string">'ALL'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> BTS_Daily_Summary_SummaryID<span class="token punctuation">,</span>
    daily_base<span class="token punctuation">.</span>summary_date <span class="token keyword keyword-AS">AS</span> BTS_Daily_Summary_SummaryDate<span class="token punctuation">,</span>
    daily_base<span class="token punctuation">.</span>dept_name <span class="token keyword keyword-AS">AS</span> BTS_Daily_Summary_DeptName<span class="token punctuation">,</span>
    daily_base<span class="token punctuation">.</span>blood_bank_code <span class="token keyword keyword-AS">AS</span> BTS_Daily_Summary_BloodBankCode<span class="token punctuation">,</span>
    daily_base<span class="token punctuation">.</span>blood_bank_name <span class="token keyword keyword-AS">AS</span> BTS_Daily_Summary_BloodBankName<span class="token punctuation">,</span>
    daily_base<span class="token punctuation">.</span>blood_type_name <span class="token keyword keyword-AS">AS</span> BTS_Daily_Summary_BloodTypeName<span class="token punctuation">,</span>
    
    <span class="token comment">-- 核心指标</span>
    daily_base<span class="token punctuation">.</span>sample_count <span class="token keyword keyword-AS">AS</span> BTS_Daily_Summary_SampleCount<span class="token punctuation">,</span>
    <span class="token punctuation">(</span>daily_base<span class="token punctuation">.</span>blood_type_test_count <span class="token operator">+</span> daily_base<span class="token punctuation">.</span>antibody_screen_count <span class="token operator">+</span> daily_base<span class="token punctuation">.</span>cross_match_count <span class="token operator">+</span> 
     daily_base<span class="token punctuation">.</span>direct_antiglobulin_count <span class="token operator">+</span> daily_base<span class="token punctuation">.</span>difficult_sample_count <span class="token operator">+</span> daily_base<span class="token punctuation">.</span>platelet_cross_match_count <span class="token operator">+</span> 
     daily_base<span class="token punctuation">.</span>platelet_antibody_count <span class="token operator">+</span> daily_base<span class="token punctuation">.</span>antibody_titer_count <span class="token operator">+</span> daily_base<span class="token punctuation">.</span>rh_typing_count<span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> BTS_Daily_Summary_TestCount<span class="token punctuation">,</span>
    <span class="token keyword keyword-COALESCE">COALESCE</span><span class="token punctuation">(</span>blood_data<span class="token punctuation">.</span>blood_in_count<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> BTS_Daily_Summary_BloodInCount<span class="token punctuation">,</span>
    <span class="token keyword keyword-COALESCE">COALESCE</span><span class="token punctuation">(</span>blood_data<span class="token punctuation">.</span>blood_out_count<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> BTS_Daily_Summary_BloodOutCount<span class="token punctuation">,</span>
    <span class="token keyword keyword-COALESCE">COALESCE</span><span class="token punctuation">(</span>blood_data<span class="token punctuation">.</span>current_inventory<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> BTS_Daily_Summary_BloodInventoryCount<span class="token punctuation">,</span>
    
    <span class="token comment">-- 九大检测项目明细</span>
    daily_base<span class="token punctuation">.</span>blood_type_test_count <span class="token keyword keyword-AS">AS</span> BTS_Daily_Summary_BloodTypeTestCount<span class="token punctuation">,</span>
    daily_base<span class="token punctuation">.</span>antibody_screen_count <span class="token keyword keyword-AS">AS</span> BTS_Daily_Summary_AntibodyScreenCount<span class="token punctuation">,</span>
    daily_base<span class="token punctuation">.</span>cross_match_count <span class="token keyword keyword-AS">AS</span> BTS_Daily_Summary_CrossMatchCount<span class="token punctuation">,</span>
    daily_base<span class="token punctuation">.</span>direct_antiglobulin_count <span class="token keyword keyword-AS">AS</span> BTS_Daily_Summary_DirectAntiGlobulinCount<span class="token punctuation">,</span>
    daily_base<span class="token punctuation">.</span>difficult_sample_count <span class="token keyword keyword-AS">AS</span> BTS_Daily_Summary_DifficultSampleCount<span class="token punctuation">,</span>
    daily_base<span class="token punctuation">.</span>platelet_cross_match_count <span class="token keyword keyword-AS">AS</span> BTS_Daily_Summary_PlateletCrossMatchCount<span class="token punctuation">,</span>
    daily_base<span class="token punctuation">.</span>platelet_antibody_count <span class="token keyword keyword-AS">AS</span> BTS_Daily_Summary_PlateletAntibodyCount<span class="token punctuation">,</span>
    daily_base<span class="token punctuation">.</span>antibody_titer_count <span class="token keyword keyword-AS">AS</span> BTS_Daily_Summary_AntibodyTiterCount<span class="token punctuation">,</span>
    daily_base<span class="token punctuation">.</span>rh_typing_count <span class="token keyword keyword-AS">AS</span> BTS_Daily_Summary_RhTypingCount<span class="token punctuation">,</span>
    
    <span class="token comment">-- 工作量汇总</span>
    <span class="token keyword keyword-COALESCE">COALESCE</span><span class="token punctuation">(</span>work_data<span class="token punctuation">.</span>sample_work_count<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> BTS_Daily_Summary_SampleWorkCount<span class="token punctuation">,</span>
    <span class="token keyword keyword-COALESCE">COALESCE</span><span class="token punctuation">(</span>work_data<span class="token punctuation">.</span>blood_work_count<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> BTS_Daily_Summary_BloodWorkCount<span class="token punctuation">,</span>
    <span class="token keyword keyword-COALESCE">COALESCE</span><span class="token punctuation">(</span>work_data<span class="token punctuation">.</span>treatment_work_count<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> BTS_Daily_Summary_TreatmentWorkCount<span class="token punctuation">,</span>
    <span class="token keyword keyword-COALESCE">COALESCE</span><span class="token punctuation">(</span>work_data<span class="token punctuation">.</span>manage_work_count<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> BTS_Daily_Summary_ManageWorkCount<span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token keyword keyword-COALESCE">COALESCE</span><span class="token punctuation">(</span>work_data<span class="token punctuation">.</span>sample_work_count<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword keyword-COALESCE">COALESCE</span><span class="token punctuation">(</span>work_data<span class="token punctuation">.</span>blood_work_count<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> 
     <span class="token keyword keyword-COALESCE">COALESCE</span><span class="token punctuation">(</span>work_data<span class="token punctuation">.</span>treatment_work_count<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword keyword-COALESCE">COALESCE</span><span class="token punctuation">(</span>work_data<span class="token punctuation">.</span>manage_work_count<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> BTS_Daily_Summary_TotalWorkCount

<span class="token keyword keyword-FROM">FROM</span> daily_base
<span class="token keyword keyword-LEFT">LEFT</span> <span class="token keyword keyword-JOIN">JOIN</span> blood_data <span class="token keyword keyword-ON">ON</span> daily_base<span class="token punctuation">.</span>summary_date <span class="token operator">=</span> blood_data<span class="token punctuation">.</span>summary_date 
    <span class="token operator">AND</span> daily_base<span class="token punctuation">.</span>blood_bank_code <span class="token operator">=</span> blood_data<span class="token punctuation">.</span>blood_bank_code
    <span class="token operator">AND</span> daily_base<span class="token punctuation">.</span>blood_type_name <span class="token operator">=</span> blood_data<span class="token punctuation">.</span>blood_type_name
<span class="token keyword keyword-LEFT">LEFT</span> <span class="token keyword keyword-JOIN">JOIN</span> work_data <span class="token keyword keyword-ON">ON</span> daily_base<span class="token punctuation">.</span>summary_date <span class="token operator">=</span> work_data<span class="token punctuation">.</span>summary_date<span class="token punctuation">;</span>
</code></pre><h4 id="522-bts_bloodstock_monthly血液库存月度汇总生成">5.2.2 BTS_BloodStock_Monthly血液库存月度汇总生成 </h4>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token comment">-- 血液库存月度汇总表数据生成</span>
<span class="token keyword keyword-INSERT">INSERT</span> <span class="token keyword keyword-INTO">INTO</span> BTS_BloodStock_Monthly
<span class="token keyword keyword-WITH">WITH</span> monthly_inventory <span class="token keyword keyword-AS">AS</span> <span class="token punctuation">(</span>
    <span class="token keyword keyword-SELECT">SELECT</span> 
        <span class="token keyword keyword-LEFT">LEFT</span><span class="token punctuation">(</span>BTS_Blood_Detail_BloodDate<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> summary_year_month<span class="token punctuation">,</span>
        BTS_Blood_Detail_BloodBankCode<span class="token punctuation">,</span>
        BTS_Blood_Detail_BloodBankName<span class="token punctuation">,</span>
        BTS_Blood_Detail_BloodTypeName<span class="token punctuation">,</span>
        BTS_Blood_Detail_BloodABOName<span class="token punctuation">,</span>
        BTS_Blood_Detail_BloodRhName<span class="token punctuation">,</span>
        
        <span class="token comment">-- 库存核心指标</span>
        <span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword keyword-CASE">CASE</span> <span class="token keyword keyword-WHEN">WHEN</span> BTS_Blood_Detail_OperationType <span class="token operator">=</span> <span class="token string">'INBOUND'</span> <span class="token keyword keyword-THEN">THEN</span> <span class="token number">1</span> <span class="token keyword keyword-ELSE">ELSE</span> <span class="token number">0</span> <span class="token keyword keyword-END">END</span><span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> total_inbound<span class="token punctuation">,</span>
        <span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword keyword-CASE">CASE</span> <span class="token keyword keyword-WHEN">WHEN</span> BTS_Blood_Detail_OperationType <span class="token operator">=</span> <span class="token string">'OUTBOUND'</span> <span class="token keyword keyword-THEN">THEN</span> <span class="token number">1</span> <span class="token keyword keyword-ELSE">ELSE</span> <span class="token number">0</span> <span class="token keyword keyword-END">END</span><span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> total_outbound<span class="token punctuation">,</span>
        <span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword keyword-CASE">CASE</span> <span class="token keyword keyword-WHEN">WHEN</span> BTS_Blood_Detail_BloodStatusName <span class="token operator">=</span> <span class="token string">'过期'</span> <span class="token keyword keyword-THEN">THEN</span> <span class="token number">1</span> <span class="token keyword keyword-ELSE">ELSE</span> <span class="token number">0</span> <span class="token keyword keyword-END">END</span><span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> total_expired<span class="token punctuation">,</span>
        <span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword keyword-CASE">CASE</span> <span class="token keyword keyword-WHEN">WHEN</span> BTS_Blood_Detail_BloodStatusName <span class="token operator">=</span> <span class="token string">'废血'</span> <span class="token keyword keyword-THEN">THEN</span> <span class="token number">1</span> <span class="token keyword keyword-ELSE">ELSE</span> <span class="token number">0</span> <span class="token keyword keyword-END">END</span><span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> total_waste<span class="token punctuation">,</span>
        
        <span class="token comment">-- 库存金额</span>
        <span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword keyword-CASE">CASE</span> <span class="token keyword keyword-WHEN">WHEN</span> BTS_Blood_Detail_OperationType <span class="token operator">=</span> <span class="token string">'INBOUND'</span> <span class="token keyword keyword-THEN">THEN</span> BTS_Blood_Detail_BloodValue <span class="token keyword keyword-ELSE">ELSE</span> <span class="token number">0</span> <span class="token keyword keyword-END">END</span><span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> inventory_value<span class="token punctuation">,</span>
        <span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword keyword-CASE">CASE</span> <span class="token keyword keyword-WHEN">WHEN</span> BTS_Blood_Detail_BloodStatusName <span class="token operator">=</span> <span class="token string">'过期'</span> <span class="token keyword keyword-THEN">THEN</span> BTS_Blood_Detail_BloodValue <span class="token keyword keyword-ELSE">ELSE</span> <span class="token number">0</span> <span class="token keyword keyword-END">END</span><span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> expired_value<span class="token punctuation">,</span>
        <span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword keyword-CASE">CASE</span> <span class="token keyword keyword-WHEN">WHEN</span> BTS_Blood_Detail_BloodStatusName <span class="token operator">=</span> <span class="token string">'废血'</span> <span class="token keyword keyword-THEN">THEN</span> BTS_Blood_Detail_BloodValue <span class="token keyword keyword-ELSE">ELSE</span> <span class="token number">0</span> <span class="token keyword keyword-END">END</span><span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> waste_value
        
    <span class="token keyword keyword-FROM">FROM</span> BTS_Blood_Detail
    <span class="token keyword keyword-GROUP">GROUP</span> <span class="token keyword keyword-BY">BY</span> 
        <span class="token keyword keyword-LEFT">LEFT</span><span class="token punctuation">(</span>BTS_Blood_Detail_BloodDate<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        BTS_Blood_Detail_BloodBankCode<span class="token punctuation">,</span>
        BTS_Blood_Detail_BloodBankName<span class="token punctuation">,</span>
        BTS_Blood_Detail_BloodTypeName<span class="token punctuation">,</span>
        BTS_Blood_Detail_BloodABOName<span class="token punctuation">,</span>
        BTS_Blood_Detail_BloodRhName
<span class="token punctuation">)</span>
<span class="token keyword keyword-SELECT">SELECT</span> 
    <span class="token string">'001'</span> <span class="token keyword keyword-AS">AS</span> BTS_BloodStock_Monthly_MedOrgCode<span class="token punctuation">,</span>
    CONCAT<span class="token punctuation">(</span>summary_year_month<span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">,</span> BTS_Blood_Detail_BloodBankCode<span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">,</span> BTS_Blood_Detail_BloodTypeName<span class="token punctuation">)</span> <span class="token keyword keyword-AS">AS</span> BTS_BloodStock_Monthly_SummaryID<span class="token punctuation">,</span>
    summary_year_month <span class="token keyword keyword-AS">AS</span> BTS_BloodStock_Monthly_SummaryYearMonth<span class="token punctuation">,</span>
    BTS_Blood_Detail_BloodBankCode <span class="token keyword keyword-AS">AS</span> BTS_BloodStock_Monthly_BloodBankCode<span class="token punctuation">,</span>
    BTS_Blood_Detail_BloodBankName <span class="token keyword keyword-AS">AS</span> BTS_BloodStock_Monthly_BloodBankName<span class="token punctuation">,</span>
    BTS_Blood_Detail_BloodTypeName <span class="token keyword keyword-AS">AS</span> BTS_BloodStock_Monthly_BloodTypeName<span class="token punctuation">,</span>
    BTS_Blood_Detail_BloodABOName <span class="token keyword keyword-AS">AS</span> BTS_BloodStock_Monthly_BloodABOName<span class="token punctuation">,</span>
    BTS_Blood_Detail_BloodRhName <span class="token keyword keyword-AS">AS</span> BTS_BloodStock_Monthly_BloodRhName<span class="token punctuation">,</span>
    
    <span class="token comment">-- 库存流转指标</span>
    total_inbound <span class="token keyword keyword-AS">AS</span> BTS_BloodStock_Monthly_TotalInbound<span class="token punctuation">,</span>
    total_outbound <span class="token keyword keyword-AS">AS</span> BTS_BloodStock_Monthly_TotalOutbound<span class="token punctuation">,</span>
    total_expired <span class="token keyword keyword-AS">AS</span> BTS_BloodStock_Monthly_TotalExpired<span class="token punctuation">,</span>
    total_waste <span class="token keyword keyword-AS">AS</span> BTS_BloodStock_Monthly_TotalWaste<span class="token punctuation">,</span>
    
    <span class="token comment">-- 库存周转率</span>
    <span class="token keyword keyword-CASE">CASE</span> <span class="token keyword keyword-WHEN">WHEN</span> total_inbound <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword keyword-THEN">THEN</span> total_outbound <span class="token operator">*</span> <span class="token number">1.0</span> <span class="token operator">/</span> total_inbound <span class="token keyword keyword-ELSE">ELSE</span> <span class="token number">0</span> <span class="token keyword keyword-END">END</span> <span class="token keyword keyword-AS">AS</span> BTS_BloodStock_Monthly_TurnoverRate<span class="token punctuation">,</span>
    
    <span class="token comment">-- 库存金额指标</span>
    inventory_value <span class="token keyword keyword-AS">AS</span> BTS_BloodStock_Monthly_InventoryValue<span class="token punctuation">,</span>
    expired_value <span class="token keyword keyword-AS">AS</span> BTS_BloodStock_Monthly_ExpiredValue<span class="token punctuation">,</span>
    waste_value <span class="token keyword keyword-AS">AS</span> BTS_BloodStock_Monthly_WasteValue

<span class="token keyword keyword-FROM">FROM</span> monthly_inventory<span class="token punctuation">;</span>
</code></pre><h2 id="六-实施总结">六、实施总结 </h2>
<h3 id="61-设计亮点">6.1 设计亮点 </h3>
<ol>
<li><strong>充分复用LIS主题架构</strong>：直接复用已有的LIS_Sample_Main检验标本主表，避免重复建设，确保数据一致性</li>
<li><strong>血库信息维度扩展</strong>：新增血库代码和血库名称字段，支持多院区血库独立管理和分析</li>
<li><strong>日度汇总大宽表设计</strong>：通过BTS_Daily_Summary涵盖样本、检测、工作量、收入、支出等全维度指标，一表满足多种分析需求</li>
<li><strong>专门的库存管理表</strong>：BTS_BloodStock_Monthly专门针对血液库存分析，支持库存周转率、有效期管理等关键指标</li>
<li><strong>新增表标识清晰</strong>：所有新增表都有明确标识，便于识别和管理</li>
</ol>
<h3 id="62-关键指标实现">6.2 关键指标实现 </h3>
<table>
<thead>
<tr>
<th>核心指标</th>
<th>实现方式</th>
<th>数据源</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>样本数</td>
<td>复用LIS_Sample_Main按输血相关样本筛选统计</td>
<td>LIS主题表(复用)</td>
<td>通过项目代码和检测目的筛选</td>
</tr>
<tr>
<td>检测项目数</td>
<td>BTS_Daily_Summary九大检测项目明细统计</td>
<td>LIS_Sample_Main</td>
<td>血型检测、抗体筛查等9个子项目</td>
</tr>
<tr>
<td>四大类工作量</td>
<td>BTS_Work_Record按工作类型分类统计</td>
<td>多系统操作记录整合(新增)</td>
<td>样本检测、临床用血、输血治疗、血液管理</td>
</tr>
<tr>
<td>血库维度分析</td>
<td>BTS_Daily_Summary按血库代码分维度</td>
<td>BIS6_BLOODBAG_INPUT.AREA_ID</td>
<td>A001本院/A002温江/A003天府/A004锦江</td>
</tr>
<tr>
<td>库存管理指标</td>
<td>BTS_BloodStock_Monthly专门库存表</td>
<td>BTS_Blood_Detail(新增)</td>
<td>库存周转率、有效期管理、库存金额</td>
</tr>
<tr>
<td>三类收入</td>
<td>复用Fee_BillDet按项目类型分类</td>
<td>现有DC收费表</td>
<td>配血检收入、血费收入、输血治疗收入</td>
</tr>
<tr>
<td>两类支出</td>
<td>血站+试剂库系统数据集成</td>
<td>外部成本系统</td>
<td>血费支出、试剂支出</td>
</tr>
</tbody>
</table>
<h3 id="63-架构优化成果">6.3 架构优化成果 </h3>
<h4 id="631-复用vs新增对比">6.3.1 复用vs新增对比 </h4>
<table>
<thead>
<tr>
<th>表类型</th>
<th>表名</th>
<th>状态</th>
<th>优势</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>复用表</strong></td>
<td>LIS_Sample_Main</td>
<td>复用LIS主题</td>
<td>数据一致性，避免重复建设</td>
</tr>
<tr>
<td><strong>复用表</strong></td>
<td>Apply_BloodTrans</td>
<td>复用现有DC</td>
<td>标准化输血申请数据</td>
</tr>
<tr>
<td><strong>复用表</strong></td>
<td>Fee_BillDet</td>
<td>复用现有DC</td>
<td>标准化收费数据</td>
</tr>
<tr>
<td><strong>新增表</strong></td>
<td>BTS_Blood_Detail</td>
<td>新增</td>
<td>血液明细管理，支持血库维度</td>
</tr>
<tr>
<td><strong>新增表</strong></td>
<td>BTS_Work_Record</td>
<td>新增</td>
<td>工作量统计，支持绩效分析</td>
</tr>
<tr>
<td><strong>新增表</strong></td>
<td>BTS_Daily_Summary</td>
<td>新增</td>
<td>日度汇总大宽表，全维度分析</td>
</tr>
<tr>
<td><strong>新增表</strong></td>
<td>BTS_BloodStock_Monthly</td>
<td>新增</td>
<td>专门库存管理，支持周转分析</td>
</tr>
</tbody>
</table>
<h4 id="632-数据架构简化">6.3.2 数据架构简化 </h4>
<ul>
<li><strong>取消MDR月度汇总表</strong>：直接基于DC日度汇总表进行应用层查询，简化架构</li>
<li><strong>库存单独月度汇总</strong>：库存数据特殊性，独立月度汇总表便于库存管理</li>
<li><strong>日度大宽表设计</strong>：一张表涵盖多维度指标，提升查询效率</li>
</ul>
<h3 id="64-业务价值">6.4 业务价值 </h3>
<ul>
<li><strong>决策支持</strong>：日度汇总大宽表支持输血科运营分析的各种维度需求</li>
<li><strong>库存管理</strong>：专门的库存月度汇总表支持血液库存精细化管理</li>
<li><strong>多院区管理</strong>：血库维度支持本院、温江、天府、锦江四个院区独立分析</li>
<li><strong>效率提升</strong>：复用LIS主题避免重复建设，加快实施进度</li>
<li><strong>成本管控</strong>：收入支出分析支持成本结构优化和绩效评估</li>
</ul>
<h3 id="65-实施建议">6.5 实施建议 </h3>
<h4 id="651-分阶段实施">6.5.1 分阶段实施 </h4>
<ol>
<li><strong>第一阶段</strong>：建设DC层明细表（BTS_Blood_Detail、BTS_Work_Record）</li>
<li><strong>第二阶段</strong>：建设DC层汇总表（BTS_Daily_Summary、BTS_BloodStock_Monthly）</li>
<li><strong>第三阶段</strong>：基于汇总表开发应用层报表和分析功能</li>
</ol>
<h4 id="652-技术实施要点">6.5.2 技术实施要点 </h4>
<ul>
<li><strong>血库字段映射</strong>：确保BIS6_BLOODBAG_INPUT.AREA_ID正确映射到血库名称</li>
<li><strong>LIS样本筛选</strong>：制定准确的输血相关样本筛选逻辑和项目代码清单</li>
<li><strong>日度汇总ETL</strong>：建立高效的日度汇总数据生成和更新机制</li>
<li><strong>库存计算逻辑</strong>：准确计算期初期末库存、周转率等关键库存指标</li>
</ul>
<h3 id="66-预期效果">6.6 预期效果 </h3>
<p>通过本架构实施，预期能够：</p>
<ul>
<li><strong>支撑多维度分析</strong>：日度、科室、血库、血液类型等多维度运营分析</li>
<li><strong>提升库存管理</strong>：库存周转率、有效期预警等专业库存管理功能</li>
<li><strong>支持院区对比</strong>：四个院区血库的独立分析和横向对比</li>
<li><strong>复用已有资源</strong>：最大化利用LIS主题和现有DC表，减少重复建设</li>
<li><strong>为未来扩展奠定基础</strong>：标准化架构设计支持后续业务需求扩展</li>
</ul>

      </div>
      
      
    
    
    <script type="module">
// TODO: If ZenUML gets integrated into mermaid in the future,
//      we can remove the following lines.


var MERMAID_CONFIG = ({"startOnLoad":false});
if (typeof MERMAID_CONFIG !== 'undefined') {
  MERMAID_CONFIG.startOnLoad = false
  MERMAID_CONFIG.cloneCssStyles = false
  MERMAID_CONFIG.theme = "default"
}

mermaid.initialize(MERMAID_CONFIG || {})
if (typeof(window['Reveal']) !== 'undefined') {
  function mermaidRevealHelper(event) {
    var currentSlide = event.currentSlide
    var diagrams = currentSlide.querySelectorAll('.mermaid')
    for (var i = 0; i < diagrams.length; i++) {
      var diagram = diagrams[i]
      if (!diagram.hasAttribute('data-processed')) {
        mermaid.init(null, diagram, ()=> {
          Reveal.slide(event.indexh, event.indexv)
        })
      }
    }
  }
  Reveal.addEventListener('slidetransitionend', mermaidRevealHelper)
  Reveal.addEventListener('ready', mermaidRevealHelper)
  await mermaid.run({
    nodes: document.querySelectorAll('.mermaid')
  })
} else {
  await mermaid.run({
    nodes: document.querySelectorAll('.mermaid')
  })
}
</script>
    
    
    
  
    </body></html>
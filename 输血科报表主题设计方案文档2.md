# 输血科报表主题数据架构设计方案

## 一、总体架构概述

基于现有DL -> DC -> MDR的三层架构，针对输血科运营分析业务需求设计完整的数据流向：

### 1.1 业务背景
- **目标**：通过对比输血科2024-08与2024-07、本年同期（2023-08）关键指标，评估科室运营效率及成本结构
- **使用人群**：院领导、输血科主任、运营管理组、财务分析组
- **时间粒度**：月度对比，包括当月、环比、同比
- **统计范围**：输血科整体运行数据，包含样本处理、检测/项目、人工作业、血液收支及物料支出

### 1.2 核心指标体系

| 指标类别 | 核心指标 | 指标内涵 | 数据来源 |
|---------|----------|----------|----------|
| **标本数** | 标本数量 | 接收的所有要检测的标本和输血申请 | 输血管理系统按检验目的统计 |
| **检测项目数** | 项目数量 | 检测的项目数（血型检测、抗体筛查、交叉配血等） | 输血管理系统按检验目的明细统计 |
| **工作量** | 总工作量 | 标本检测+临床用血+输血治疗+血液管理四部分 | 多系统集成统计 |
| **收入** | 总收入 | 配血检收入+血费收入+输血治疗收入 | 收入主题+输血系统 |
| **支出** | 总支出 | 血费支出+试剂支出+输血治疗耗材 | 血站系统+试剂库+耗材库 |

### 1.3 数据分层说明

| 数据层级 | 数据类型 | 表名举例 | 数据来源 | 数据特点 |
|---------|----------|----------|----------|----------|
| **DL层** | 贴源数据 | BIS_REQUISITION_INFO、BIS_BLOOD_INPUT | 业务系统直接复制 | 保持源系统原始结构 |
| **DC层-明细** | 明细数据 | BTS_Requisition_Main、BTS_Blood_Detail | DL层集成处理 | 标准化字段、多医院统一 |
| **DC层-汇总** | 汇总数据 | BTS_Daily_Summary | DC明细表聚合 | 按维度预聚合，提升查询性能 |
| **MDR层** | 主题数据 | MDR_BTS_Monthly_Summary | DC层数据整合 | 面向业务分析的宽表结构 |

## 二、DC层原子指标设计原则

### 2.1 设计理念对标现有DC架构

通过分析现有datacenter设计，遵循以下设计风格：

1. **命名规范一致性**：`表名_字段名`格式，如`BTS_Requisition_Main_ApplyID`
2. **字段类型标准化**：ID统一使用VARCHAR(60)，金额使用FLOAT8，时间使用timestamp
3. **数据完整性**：每个事实表都包含完整的维度信息（机构、人员、就诊等）
4. **扩展性设计**：预留扩展字段(ExtStr1-6, ExtNum1-2, ExtDate1-2)
5. **元数据管理**：包含数据来源标识、创建时间、更新时间等字段

### 2.2 原子指标最小粒度说明

| 业务域 | 原子指标 | 最小统计粒度 | 支持聚合维度 | 设计原因 |
|--------|----------|-------------|-------------|----------|
| **申请域** | 申请数量 | 单个输血申请(ApplyID) | 日期/科室/血液类型/紧急程度 | 每个申请单是输血业务的起点 |
| **血液域** | 血袋数量 | 单个血袋(BloodBagID) | 日期/血液类型/来源/状态 | 每个血袋是库存管理的基本单元 |
| **检测域** | 检测项目数 | 单个检测项目(TestItemID) | 日期/检测类型/检测方法 | 每个检测项目是工作量统计的基础 |
| **工作量域** | 操作次数 | 单次操作行为(WorkID) | 日期/工作类型/操作人员 | 每次操作都是独立的工作量单元 |
| **收入域** | 收费金额 | 单笔收费记录(Fee_BillDet_BillDetID) | 日期/收费项目/科室 | 每笔收费都是独立的会计核算单元 |

## 三、数据血缘关系设计

### 3.1 DL层数据源（已有）
- **BIS_REQUISITION_INFO**（申请单信息表）- 输血申请数据源
- **BIS_REQUISITION_BLOOD_DETAIL**（申请血液详细表）- 血液需求明细
- **BIS_BLOOD_INPUT**（血袋表）- 血液库存数据源
- **LIS_REQUISITION_INFO**（标本信息主表）- 检验申请数据源
- **LIS_REQUISITION_ITEM**（标本项目明细表）- 检验项目明细

### 3.2 DC层设计（符合现有DC架构风格）

#### 3.2.1 明细数据表设计（DL->DC直接集成）

##### A. BTS_Requisition_Main（输血申请主表）

**建表语句**：
```sql
-- 输血申请主表 - 对标现有DC架构命名和结构
CREATE TABLE BTS_Requisition_Main (
    -- 基础标识信息
    BTS_Requisition_Main_MedOrgCode VARCHAR(60) NOT NULL,        -- 医疗机构代码
    BTS_Requisition_Main_MedOrgName VARCHAR(100),                -- 医疗机构名称
    BTS_Requisition_Main_EmpiID INT8,                            -- 人员唯一标识ID
    BTS_Requisition_Main_EmpiNo VARCHAR(60),                     -- 人员唯一号
    BTS_Requisition_Main_PersID INT8,                            -- 人员ID
    BTS_Requisition_Main_PersNo VARCHAR(60),                     -- 人员号
    BTS_Requisition_Main_VisitID INT8,                           -- 就诊ID
    BTS_Requisition_Main_VisitNo VARCHAR(60),                    -- 就诊号
    BTS_Requisition_Main_VisitTypeID VARCHAR(60),                -- 就诊类型ID
    BTS_Requisition_Main_VisitTypeName VARCHAR(60),              -- 就诊类型名称
    
    -- 申请核心信息
    BTS_Requisition_Main_ApplyID VARCHAR(60) PRIMARY KEY,        -- 申请单ID
    BTS_Requisition_Main_ApplyCode VARCHAR(60),                  -- 申请单编码
    BTS_Requisition_Main_ApplyStatusID VARCHAR(60),              -- 申请状态ID
    BTS_Requisition_Main_ApplyStatusName VARCHAR(100),           -- 申请状态名称
    BTS_Requisition_Main_BloodTypeABO VARCHAR(60),               -- ABO血型
    BTS_Requisition_Main_BloodTypeRH VARCHAR(60),                -- RH血型
    BTS_Requisition_Main_UrgencyLevel VARCHAR(60),               -- 紧急程度
    BTS_Requisition_Main_ApplyPurpose VARCHAR(200),              -- 申请目的
    
    -- 科室信息
    BTS_Requisition_Main_DeptID VARCHAR(60),                     -- 申请科室ID
    BTS_Requisition_Main_DeptCode VARCHAR(60),                   -- 申请科室代码
    BTS_Requisition_Main_DeptName VARCHAR(100),                  -- 申请科室名称
    
    -- 时间信息
    BTS_Requisition_Main_ApplyDate VARCHAR(10),                  -- 申请日期(YYYYMMDD)
    BTS_Requisition_Main_ApplyDtTm timestamp,                    -- 申请时间
    BTS_Requisition_Main_PlanUseDtTm timestamp,                  -- 预计用血时间
    
    -- 申请人员信息
    BTS_Requisition_Main_ApplyDoctorID VARCHAR(60),              -- 申请医生ID
    BTS_Requisition_Main_ApplyDoctorName VARCHAR(100),           -- 申请医生姓名
    
    -- 审核信息
    BTS_Requisition_Main_ReviewDoctorID VARCHAR(60),             -- 审核医生ID
    BTS_Requisition_Main_ReviewDoctorName VARCHAR(100),          -- 审核医生姓名
    BTS_Requisition_Main_ReviewDtTm timestamp,                   -- 审核时间
    BTS_Requisition_Main_ReviewResult VARCHAR(60),               -- 审核结果
    
    -- 标准扩展字段
    BTS_Requisition_Main_ExtStr1 VARCHAR(200),                   -- 扩展1(字符类型)
    BTS_Requisition_Main_ExtStr2 VARCHAR(200),                   -- 扩展2(字符类型)
    BTS_Requisition_Main_ExtStr3 VARCHAR(200),                   -- 扩展3(字符类型)
    BTS_Requisition_Main_ExtStr4 VARCHAR(200),                   -- 扩展4(字符类型)
    BTS_Requisition_Main_ExtStr5 VARCHAR(200),                   -- 扩展5(字符类型)
    BTS_Requisition_Main_ExtStr6 VARCHAR(200),                   -- 扩展6(字符类型)
    BTS_Requisition_Main_ExtNum1 FLOAT8,                         -- 扩展7(数值类型)
    BTS_Requisition_Main_ExtNum2 FLOAT8,                         -- 扩展8(数值类型)
    BTS_Requisition_Main_ExtDate1 timestamp,                     -- 扩展9(时间类型)
    BTS_Requisition_Main_ExtDate2 timestamp,                     -- 扩展10(时间类型)
    
    -- 数据管理字段
    BTS_Requisition_Main_DataSourceFlag VARCHAR(10),             -- 数据来源标识
    BTS_Requisition_Main_DSTable VARCHAR(60),                    -- 接入数据源的表
    BTS_Requisition_Main_DSTableKey VARCHAR(200),                -- 接入数据源的key
    BTS_Requisition_Main_DSTableValue VARCHAR(200),              -- 接入数据源的key值
    BTS_Requisition_Main_IsDeleted INT8 DEFAULT 0,               -- 数据物理删除标识
    BTS_Requisition_Main_LastUpdateDtTm timestamp DEFAULT GETDATE(), -- 最后更新时间
    BTS_Requisition_Main_DataCreateDtTm timestamp DEFAULT GETDATE()  -- 数据创建时间
);
```

##### B. BTS_Blood_Detail（血液明细表）

**建表语句**：
```sql
-- 血液明细表
CREATE TABLE BTS_Blood_Detail (
    -- 基础标识信息
    BTS_Blood_Detail_MedOrgCode VARCHAR(60) NOT NULL,            -- 医疗机构代码
    BTS_Blood_Detail_MedOrgName VARCHAR(100),                    -- 医疗机构名称
    
    -- 血液核心信息
    BTS_Blood_Detail_BloodBagID VARCHAR(60) PRIMARY KEY,         -- 血袋ID
    BTS_Blood_Detail_BloodBagCode VARCHAR(60),                   -- 血袋编码
    BTS_Blood_Detail_BloodTypeID VARCHAR(60),                    -- 血液类型ID
    BTS_Blood_Detail_BloodTypeCode VARCHAR(60),                  -- 血液类型代码
    BTS_Blood_Detail_BloodTypeName VARCHAR(100),                 -- 血液类型名称
    BTS_Blood_Detail_BloodTypeABO VARCHAR(60),                   -- ABO血型
    BTS_Blood_Detail_BloodTypeRH VARCHAR(60),                    -- RH血型
    BTS_Blood_Detail_BloodVolume FLOAT8,                         -- 血液容量
    BTS_Blood_Detail_BloodVolumeUnit VARCHAR(60),                -- 容量单位
    BTS_Blood_Detail_BloodStatusID VARCHAR(60),                  -- 血液状态ID
    BTS_Blood_Detail_BloodStatusName VARCHAR(100),               -- 血液状态名称
    
    -- 关联信息
    BTS_Blood_Detail_ApplyID VARCHAR(60),                        -- 申请单ID
    BTS_Blood_Detail_SourceID VARCHAR(60),                       -- 血液来源ID
    BTS_Blood_Detail_SourceName VARCHAR(100),                    -- 血液来源名称
    
    -- 时间信息
    BTS_Blood_Detail_BloodDate VARCHAR(10),                      -- 血液日期(YYYYMMDD)
    BTS_Blood_Detail_InStockDtTm timestamp,                      -- 入库时间
    BTS_Blood_Detail_OutStockDtTm timestamp,                     -- 出库时间
    BTS_Blood_Detail_ExpireDtTm timestamp,                       -- 过期时间
    
    -- 操作人员信息
    BTS_Blood_Detail_InStockPersID VARCHAR(60),                  -- 入库人员ID
    BTS_Blood_Detail_InStockPersName VARCHAR(100),               -- 入库人员姓名
    BTS_Blood_Detail_OutStockPersID VARCHAR(60),                 -- 出库人员ID
    BTS_Blood_Detail_OutStockPersName VARCHAR(100),              -- 出库人员姓名
    
    -- 财务信息
    BTS_Blood_Detail_BloodCost FLOAT8,                           -- 血液成本
    BTS_Blood_Detail_BloodPrice FLOAT8,                          -- 血液价格
    
    -- 标准扩展字段
    BTS_Blood_Detail_ExtStr1 VARCHAR(200),                       -- 扩展1
    BTS_Blood_Detail_ExtStr2 VARCHAR(200),                       -- 扩展2
    BTS_Blood_Detail_ExtStr3 VARCHAR(200),                       -- 扩展3
    BTS_Blood_Detail_ExtStr4 VARCHAR(200),                       -- 扩展4
    BTS_Blood_Detail_ExtStr5 VARCHAR(200),                       -- 扩展5
    BTS_Blood_Detail_ExtStr6 VARCHAR(200),                       -- 扩展6
    BTS_Blood_Detail_ExtNum1 FLOAT8,                             -- 扩展7
    BTS_Blood_Detail_ExtNum2 FLOAT8,                             -- 扩展8
    BTS_Blood_Detail_ExtDate1 timestamp,                         -- 扩展9
    BTS_Blood_Detail_ExtDate2 timestamp,                         -- 扩展10
    
    -- 数据管理字段
    BTS_Blood_Detail_DataSourceFlag VARCHAR(10),                 -- 数据来源标识
    BTS_Blood_Detail_IsDeleted INT8 DEFAULT 0,                   -- 数据物理删除标识
    BTS_Blood_Detail_LastUpdateDtTm timestamp DEFAULT GETDATE(), -- 最后更新时间
    BTS_Blood_Detail_DataCreateDtTm timestamp DEFAULT GETDATE()  -- 数据创建时间
);
```

#### 3.2.2 汇总数据表设计（DC内部聚合）

##### BTS_Daily_Summary（输血日度汇总表）

**建表语句**：
```sql
-- 输血日度汇总表
CREATE TABLE BTS_Daily_Summary (
    -- 维度信息
    BTS_Daily_Summary_SummaryID VARCHAR(60) PRIMARY KEY,         -- 汇总ID
    BTS_Daily_Summary_MedOrgCode VARCHAR(60) NOT NULL,           -- 医疗机构代码
    BTS_Daily_Summary_SummaryDate VARCHAR(10) NOT NULL,          -- 汇总日期(YYYYMMDD)
    BTS_Daily_Summary_DeptID VARCHAR(60),                        -- 科室ID
    BTS_Daily_Summary_DeptName VARCHAR(100),                     -- 科室名称
    BTS_Daily_Summary_BloodTypeCode VARCHAR(60),                 -- 血液类型代码
    BTS_Daily_Summary_BloodTypeName VARCHAR(100),                -- 血液类型名称
    
    -- 标本数指标
    BTS_Daily_Summary_RequisitionCount INT8 DEFAULT 0,           -- 申请数量
    BTS_Daily_Summary_SampleCount INT8 DEFAULT 0,                -- 标本数量
    
    -- 检测项目数指标
    BTS_Daily_Summary_BloodTypeTestCount INT8 DEFAULT 0,         -- 血型检测数
    BTS_Daily_Summary_AntibodyScreenCount INT8 DEFAULT 0,        -- 抗体筛查数
    BTS_Daily_Summary_CrossMatchCount INT8 DEFAULT 0,            -- 交叉配血数
    BTS_Daily_Summary_DirectAntiGlobulinCount INT8 DEFAULT 0,    -- 直接抗人球蛋白试验数
    BTS_Daily_Summary_DifficultSampleCount INT8 DEFAULT 0,       -- 疑难标本数
    BTS_Daily_Summary_PlateletCrossMatchCount INT8 DEFAULT 0,    -- 血小板交叉配血数
    BTS_Daily_Summary_TotalTestCount INT8 DEFAULT 0,             -- 总检测项目数
    
    -- 工作量指标
    BTS_Daily_Summary_SampleTestWorkload INT8 DEFAULT 0,         -- 标本检测工作量
    BTS_Daily_Summary_BloodManageWorkload INT8 DEFAULT 0,        -- 临床用血工作量
    BTS_Daily_Summary_TransfusionWorkload INT8 DEFAULT 0,        -- 输血治疗工作量
    BTS_Daily_Summary_QualityManageWorkload INT8 DEFAULT 0,      -- 血液管理工作量
    BTS_Daily_Summary_TotalWorkload INT8 DEFAULT 0,              -- 总工作量
    
    -- 血液数量指标
    BTS_Daily_Summary_BloodReserveCount INT8 DEFAULT 0,          -- 血液预约次数
    BTS_Daily_Summary_BloodInStockCount INT8 DEFAULT 0,          -- 血液入库袋数
    BTS_Daily_Summary_BloodOutStockCount INT8 DEFAULT 0,         -- 血液出库袋数
    BTS_Daily_Summary_BloodInventoryCount INT8 DEFAULT 0,        -- 血液盘存袋数
    BTS_Daily_Summary_PlasmaThawCount INT8 DEFAULT 0,            -- 血浆/冷沉淀融化袋数
    
    -- 收入指标（单位：元）
    BTS_Daily_Summary_CrossMatchIncome FLOAT8 DEFAULT 0,         -- 配血检收入
    BTS_Daily_Summary_BloodFeeIncome FLOAT8 DEFAULT 0,           -- 血费收入
    BTS_Daily_Summary_TransfusionIncome FLOAT8 DEFAULT 0,        -- 输血治疗收入
    BTS_Daily_Summary_TotalIncome FLOAT8 DEFAULT 0,              -- 总收入
    
    -- 支出指标（单位：元）
    BTS_Daily_Summary_BloodCost FLOAT8 DEFAULT 0,                -- 血费支出
    BTS_Daily_Summary_ReagentCost FLOAT8 DEFAULT 0,              -- 试剂支出
    BTS_Daily_Summary_ConsumableCost FLOAT8 DEFAULT 0,           -- 输血治疗耗材支出
    BTS_Daily_Summary_TotalCost FLOAT8 DEFAULT 0,                -- 总支出
    
    -- 数据管理字段
    BTS_Daily_Summary_DataSourceFlag VARCHAR(10),                -- 数据来源标识
    BTS_Daily_Summary_IsDeleted INT8 DEFAULT 0,                  -- 数据物理删除标识
    BTS_Daily_Summary_LastUpdateDtTm timestamp DEFAULT GETDATE(), -- 最后更新时间
    BTS_Daily_Summary_DataCreateDtTm timestamp DEFAULT GETDATE()  -- 数据创建时间
);
```

## 四、MDR层主题设计

### 4.1 MDR_BTS_Monthly_Summary（输血科月度汇总主题表）

**建表语句**：
```sql
-- 输血科月度汇总主题表
CREATE TABLE MDR_BTS_Monthly_Summary (
    -- 维度信息
    MDR_BTS_Monthly_Summary_SummaryID VARCHAR(60) PRIMARY KEY,   -- 汇总ID
    MDR_BTS_Monthly_Summary_MedOrgCode VARCHAR(60) NOT NULL,     -- 医疗机构代码
    MDR_BTS_Monthly_Summary_SummaryMonth VARCHAR(6) NOT NULL,    -- 汇总月份(YYYYMM)
    MDR_BTS_Monthly_Summary_DeptID VARCHAR(60),                  -- 科室ID
    MDR_BTS_Monthly_Summary_DeptName VARCHAR(100),               -- 科室名称
    
    -- 当月指标
    MDR_BTS_Monthly_Summary_CurrentSampleCount INT8,             -- 当月标本数
    MDR_BTS_Monthly_Summary_CurrentTestCount INT8,               -- 当月检测项目数
    MDR_BTS_Monthly_Summary_CurrentWorkload INT8,                -- 当月工作量
    MDR_BTS_Monthly_Summary_CurrentBloodIncome FLOAT8,           -- 当月血液收入
    MDR_BTS_Monthly_Summary_CurrentReagentCost FLOAT8,           -- 当月试剂支出
    MDR_BTS_Monthly_Summary_CurrentTotalIncome FLOAT8,           -- 当月总收入
    
    -- 环比指标（与上月对比）
    MDR_BTS_Monthly_Summary_MoMSampleCount INT8,                 -- 环比标本数
    MDR_BTS_Monthly_Summary_MoMTestCount INT8,                   -- 环比检测项目数
    MDR_BTS_Monthly_Summary_MoMWorkload INT8,                    -- 环比工作量
    MDR_BTS_Monthly_Summary_MoMBloodIncome FLOAT8,               -- 环比血液收入
    MDR_BTS_Monthly_Summary_MoMReagentCost FLOAT8,               -- 环比试剂支出
    MDR_BTS_Monthly_Summary_MoMTotalIncome FLOAT8,               -- 环比总收入
    MDR_BTS_Monthly_Summary_MoMSampleCountPct FLOAT8,            -- 环比标本数百分比
    MDR_BTS_Monthly_Summary_MoMTestCountPct FLOAT8,              -- 环比检测项目数百分比
    MDR_BTS_Monthly_Summary_MoMWorkloadPct FLOAT8,               -- 环比工作量百分比
    MDR_BTS_Monthly_Summary_MoMBloodIncomePct FLOAT8,            -- 环比血液收入百分比
    MDR_BTS_Monthly_Summary_MoMReagentCostPct FLOAT8,            -- 环比试剂支出百分比
    MDR_BTS_Monthly_Summary_MoMTotalIncomePct FLOAT8,            -- 环比总收入百分比
    
    -- 同比指标（与去年同期对比）
    MDR_BTS_Monthly_Summary_YoYSampleCount INT8,                 -- 同比标本数
    MDR_BTS_Monthly_Summary_YoYTestCount INT8,                   -- 同比检测项目数
    MDR_BTS_Monthly_Summary_YoYWorkload INT8,                    -- 同比工作量
    MDR_BTS_Monthly_Summary_YoYBloodIncome FLOAT8,               -- 同比血液收入
    MDR_BTS_Monthly_Summary_YoYReagentCost FLOAT8,               -- 同比试剂支出
    MDR_BTS_Monthly_Summary_YoYTotalIncome FLOAT8,               -- 同比总收入
    MDR_BTS_Monthly_Summary_YoYSampleCountPct FLOAT8,            -- 同比标本数百分比
    MDR_BTS_Monthly_Summary_YoYTestCountPct FLOAT8,              -- 同比检测项目数百分比
    MDR_BTS_Monthly_Summary_YoYWorkloadPct FLOAT8,               -- 同比工作量百分比
    MDR_BTS_Monthly_Summary_YoYBloodIncomePct FLOAT8,            -- 同比血液收入百分比
    MDR_BTS_Monthly_Summary_YoYReagentCostPct FLOAT8,            -- 同比试剂支出百分比
    MDR_BTS_Monthly_Summary_YoYTotalIncomePct FLOAT8,            -- 同比总收入百分比
    
    -- 数据管理字段
    MDR_BTS_Monthly_Summary_DataSourceFlag VARCHAR(10),          -- 数据来源标识
    MDR_BTS_Monthly_Summary_IsDeleted INT8 DEFAULT 0,            -- 数据物理删除标识
    MDR_BTS_Monthly_Summary_LastUpdateDtTm timestamp DEFAULT GETDATE(), -- 最后更新时间
    MDR_BTS_Monthly_Summary_DataCreateDtTm timestamp DEFAULT GETDATE()  -- 数据创建时间
);
```

## 五、数据处理逻辑

### 5.1 DL->DC数据集成逻辑

#### 步骤1：输血申请数据集成
```sql
INSERT INTO BTS_Requisition_Main
SELECT 
    hospital_id AS BTS_Requisition_Main_MedOrgCode,
    apply_id AS BTS_Requisition_Main_ApplyID,
    apply_date AS BTS_Requisition_Main_ApplyDate,
    patient_id AS BTS_Requisition_Main_PersID,
    dept_id AS BTS_Requisition_Main_DeptID,
    apply_doctor AS BTS_Requisition_Main_ApplyDoctorName,
    blood_type_abo AS BTS_Requisition_Main_BloodTypeABO,
    blood_type_rh AS BTS_Requisition_Main_BloodTypeRH,
    urgency_level AS BTS_Requisition_Main_UrgencyLevel,
    apply_purpose AS BTS_Requisition_Main_ApplyPurpose,
    apply_time AS BTS_Requisition_Main_ApplyDtTm
FROM BIS_REQUISITION_INFO
WHERE hospital_id IS NOT NULL;
```

#### 步骤2：血液明细数据集成
```sql
INSERT INTO BTS_Blood_Detail
SELECT 
    hospital_id AS BTS_Blood_Detail_MedOrgCode,
    blood_bag_id AS BTS_Blood_Detail_BloodBagID,
    blood_type_code AS BTS_Blood_Detail_BloodTypeCode,
    blood_type_name AS BTS_Blood_Detail_BloodTypeName,
    blood_volume AS BTS_Blood_Detail_BloodVolume,
    in_stock_time AS BTS_Blood_Detail_InStockDtTm,
    out_stock_time AS BTS_Blood_Detail_OutStockDtTm,
    blood_cost AS BTS_Blood_Detail_BloodCost
FROM BIS_BLOOD_INPUT
WHERE blood_bag_id IS NOT NULL;
```

### 5.2 DC->MDR数据聚合逻辑

#### 月度汇总数据生成
```sql
INSERT INTO MDR_BTS_Monthly_Summary
WITH monthly_data AS (
    SELECT 
        BTS_Daily_Summary_MedOrgCode,
        SUBSTRING(BTS_Daily_Summary_SummaryDate, 1, 6) AS summary_month,
        BTS_Daily_Summary_DeptID,
        BTS_Daily_Summary_DeptName,
        SUM(BTS_Daily_Summary_SampleCount) AS total_sample_count,
        SUM(BTS_Daily_Summary_TotalTestCount) AS total_test_count,
        SUM(BTS_Daily_Summary_TotalWorkload) AS total_workload,
        SUM(BTS_Daily_Summary_BloodFeeIncome) AS total_blood_income,
        SUM(BTS_Daily_Summary_ReagentCost) AS total_reagent_cost,
        SUM(BTS_Daily_Summary_TotalIncome) AS total_income
    FROM BTS_Daily_Summary
    GROUP BY 
        BTS_Daily_Summary_MedOrgCode,
        SUBSTRING(BTS_Daily_Summary_SummaryDate, 1, 6),
        BTS_Daily_Summary_DeptID,
        BTS_Daily_Summary_DeptName
),
mom_data AS (
    SELECT 
        *,
        LAG(total_sample_count) OVER (PARTITION BY BTS_Daily_Summary_MedOrgCode, BTS_Daily_Summary_DeptID ORDER BY summary_month) AS prev_month_sample_count,
        LAG(total_test_count) OVER (PARTITION BY BTS_Daily_Summary_MedOrgCode, BTS_Daily_Summary_DeptID ORDER BY summary_month) AS prev_month_test_count,
        LAG(total_workload) OVER (PARTITION BY BTS_Daily_Summary_MedOrgCode, BTS_Daily_Summary_DeptID ORDER BY summary_month) AS prev_month_workload,
        LAG(total_blood_income) OVER (PARTITION BY BTS_Daily_Summary_MedOrgCode, BTS_Daily_Summary_DeptID ORDER BY summary_month) AS prev_month_blood_income,
        LAG(total_reagent_cost) OVER (PARTITION BY BTS_Daily_Summary_MedOrgCode, BTS_Daily_Summary_DeptID ORDER BY summary_month) AS prev_month_reagent_cost,
        LAG(total_income) OVER (PARTITION BY BTS_Daily_Summary_MedOrgCode, BTS_Daily_Summary_DeptID ORDER BY summary_month) AS prev_month_total_income
    FROM monthly_data
),
yoy_data AS (
    SELECT 
        *,
        LAG(total_sample_count, 12) OVER (PARTITION BY BTS_Daily_Summary_MedOrgCode, BTS_Daily_Summary_DeptID ORDER BY summary_month) AS last_year_sample_count,
        LAG(total_test_count, 12) OVER (PARTITION BY BTS_Daily_Summary_MedOrgCode, BTS_Daily_Summary_DeptID ORDER BY summary_month) AS last_year_test_count,
        LAG(total_workload, 12) OVER (PARTITION BY BTS_Daily_Summary_MedOrgCode, BTS_Daily_Summary_DeptID ORDER BY summary_month) AS last_year_workload,
        LAG(total_blood_income, 12) OVER (PARTITION BY BTS_Daily_Summary_MedOrgCode, BTS_Daily_Summary_DeptID ORDER BY summary_month) AS last_year_blood_income,
        LAG(total_reagent_cost, 12) OVER (PARTITION BY BTS_Daily_Summary_MedOrgCode, BTS_Daily_Summary_DeptID ORDER BY summary_month) AS last_year_reagent_cost,
        LAG(total_income, 12) OVER (PARTITION BY BTS_Daily_Summary_MedOrgCode, BTS_Daily_Summary_DeptID ORDER BY summary_month) AS last_year_total_income
    FROM mom_data
)
SELECT 
    BTS_Daily_Summary_MedOrgCode + '_' + summary_month + '_' + COALESCE(BTS_Daily_Summary_DeptID, 'ALL') AS MDR_BTS_Monthly_Summary_SummaryID,
    BTS_Daily_Summary_MedOrgCode AS MDR_BTS_Monthly_Summary_MedOrgCode,
    summary_month AS MDR_BTS_Monthly_Summary_SummaryMonth,
    BTS_Daily_Summary_DeptID AS MDR_BTS_Monthly_Summary_DeptID,
    BTS_Daily_Summary_DeptName AS MDR_BTS_Monthly_Summary_DeptName,
    
    -- 当月指标
    total_sample_count AS MDR_BTS_Monthly_Summary_CurrentSampleCount,
    total_test_count AS MDR_BTS_Monthly_Summary_CurrentTestCount,
    total_workload AS MDR_BTS_Monthly_Summary_CurrentWorkload,
    total_blood_income AS MDR_BTS_Monthly_Summary_CurrentBloodIncome,
    total_reagent_cost AS MDR_BTS_Monthly_Summary_CurrentReagentCost,
    total_income AS MDR_BTS_Monthly_Summary_CurrentTotalIncome,
    
    -- 环比指标
    prev_month_sample_count AS MDR_BTS_Monthly_Summary_MoMSampleCount,
    prev_month_test_count AS MDR_BTS_Monthly_Summary_MoMTestCount,
    prev_month_workload AS MDR_BTS_Monthly_Summary_MoMWorkload,
    prev_month_blood_income AS MDR_BTS_Monthly_Summary_MoMBloodIncome,
    prev_month_reagent_cost AS MDR_BTS_Monthly_Summary_MoMReagentCost,
    prev_month_total_income AS MDR_BTS_Monthly_Summary_MoMTotalIncome,
    
    -- 环比百分比
    CASE WHEN prev_month_sample_count > 0 THEN 
        (total_sample_count - prev_month_sample_count) * 100.0 / prev_month_sample_count 
    ELSE NULL END AS MDR_BTS_Monthly_Summary_MoMSampleCountPct,
    
    CASE WHEN prev_month_test_count > 0 THEN 
        (total_test_count - prev_month_test_count) * 100.0 / prev_month_test_count 
    ELSE NULL END AS MDR_BTS_Monthly_Summary_MoMTestCountPct,
    
    -- 同比指标
    last_year_sample_count AS MDR_BTS_Monthly_Summary_YoYSampleCount,
    last_year_test_count AS MDR_BTS_Monthly_Summary_YoYTestCount,
    last_year_workload AS MDR_BTS_Monthly_Summary_YoYWorkload,
    last_year_blood_income AS MDR_BTS_Monthly_Summary_YoYBloodIncome,
    last_year_reagent_cost AS MDR_BTS_Monthly_Summary_YoYReagentCost,
    last_year_total_income AS MDR_BTS_Monthly_Summary_YoYTotalIncome,
    
    -- 同比百分比
    CASE WHEN last_year_sample_count > 0 THEN 
        (total_sample_count - last_year_sample_count) * 100.0 / last_year_sample_count 
    ELSE NULL END AS MDR_BTS_Monthly_Summary_YoYSampleCountPct,
    
    CASE WHEN last_year_test_count > 0 THEN 
        (total_test_count - last_year_test_count) * 100.0 / last_year_test_count 
    ELSE NULL END AS MDR_BTS_Monthly_Summary_YoYTestCountPct
    
FROM yoy_data;
```

## 六、收入数据集成方案

### 6.1 收入数据关联设计

基于现有收入主题Fee_BillDet表，通过收费项目ID关联输血相关收费：

```sql
-- 收入数据集成到BTS_Daily_Summary
UPDATE BTS_Daily_Summary 
SET 
    BTS_Daily_Summary_CrossMatchIncome = income_data.cross_match_income,
    BTS_Daily_Summary_BloodFeeIncome = income_data.blood_fee_income,
    BTS_Daily_Summary_TransfusionIncome = income_data.transfusion_income,
    BTS_Daily_Summary_TotalIncome = income_data.total_income
FROM (
    SELECT 
        FORMAT(fbd.Fee_BillDet_BillDate, 'yyyyMMdd') AS bill_date,
        fbd.Fee_BillDet_DeptID AS dept_id,
        
        -- 配血检收入（LIS相关收费项目）
        SUM(CASE WHEN fbd.Fee_BillDet_ChargeItemID IN (
            'LIS07068', 'LIS05', 'LIS0300255', 'LIS0300114',  -- 血型检测
            'LIS07073',  -- 抗体筛查
            'LIS07156', 'LIS07157', 'LIS07153',  -- 交叉配血
            'LIS07079'   -- 直接抗人球蛋白试验
        ) THEN fbd.Fee_BillDet_Amount ELSE 0 END) AS cross_match_income,
        
        -- 血费收入（血液制品相关收费项目）
        SUM(CASE WHEN fbd.Fee_BillDet_ChargeItemID LIKE '%血液%' 
                   OR fbd.Fee_BillDet_ChargeItemID LIKE '%红细胞%'
                   OR fbd.Fee_BillDet_ChargeItemID LIKE '%血浆%'
                   OR fbd.Fee_BillDet_ChargeItemID LIKE '%血小板%'
             THEN fbd.Fee_BillDet_Amount ELSE 0 END) AS blood_fee_income,
        
        -- 输血治疗收入
        SUM(CASE WHEN fbd.Fee_BillDet_ChargeItemID IN (
            '666600613',  -- 血液稀释疗法
            '666000570',  -- 全血
            '666000571',  -- Rh(-)全血
            '666600598',  -- 血浆置换术
            '666000510'   -- 血细胞分离单采
        ) THEN fbd.Fee_BillDet_Amount ELSE 0 END) AS transfusion_income,
        
        -- 总收入
        SUM(fbd.Fee_BillDet_Amount) AS total_income
        
    FROM Fee_BillDet fbd
    WHERE fbd.Fee_BillDet_DeptID = '输血科部门ID'  -- 根据实际情况调整
       OR fbd.Fee_BillDet_ChargeItemID IN (
           -- 输血相关收费项目ID列表
           'LIS07068', 'LIS05', 'LIS0300255', 'LIS0300114',
           'LIS07073', 'LIS07156', 'LIS07157', 'LIS07153', 'LIS07079',
           '666600613', '666000570', '666000571', '666600598', '666000510'
       )
    GROUP BY 
        FORMAT(fbd.Fee_BillDet_BillDate, 'yyyyMMdd'),
        fbd.Fee_BillDet_DeptID
) income_data
WHERE BTS_Daily_Summary.BTS_Daily_Summary_SummaryDate = income_data.bill_date
  AND BTS_Daily_Summary.BTS_Daily_Summary_DeptID = income_data.dept_id;
```

## 七、实施计划

### 7.1 实施阶段

| 阶段 | 工作内容 | 预计时间 | 交付物 |
|------|----------|----------|--------|
| **第一阶段** | 建立DC层核心明细表 | 2周 | BTS_Requisition_Main, BTS_Blood_Detail |
| **第二阶段** | 完善检验和工作量表 | 2周 | BTS_Lab_Test, BTS_Work_Record |
| **第三阶段** | 建立汇总表和MDR主题表 | 1周 | BTS_Daily_Summary, MDR_BTS_Monthly_Summary |
| **第四阶段** | 完善收入集成和报表应用 | 1周 | 收入数据集成, 报表开发 |

### 7.2 关键里程碑

1. **DC层基础架构完成**：能够支持基础的申请和血液数据查询
2. **工作量统计上线**：能够统计4类工作量指标
3. **月度汇总功能上线**：能够生成月度对比分析报表
4. **收入集成完成**：能够提供完整的收入成本分析

### 7.3 验收标准

1. **数据准确性**：与业务系统核对误差＜±0.5%
2. **性能要求**：完整页面加载＜5s，明细筛选＜2s
3. **功能完整性**：支持环比、同比分析，支持按科室、血液类型筛选
4. **可扩展性**：预留扩展字段，支持后续业务需求变更

## 八、总结

本方案基于现有DL->DC->MDR三层架构，为输血科运营分析需求设计了完整的数据架构：

1. **遵循现有DC架构标准**：命名规范、字段类型、扩展字段等完全对标现有设计
2. **支持业务需求**：覆盖标本数、检测项目数、工作量、收入支出等核心指标
3. **数据血缘清晰**：从输血管理系统、LIS系统到最终主题表的完整链路
4. **性能优化设计**：通过DC层汇总表提升查询性能
5. **扩展性良好**：预留扩展字段，支持未来业务发展需要

通过这些详细的表结构设计和数据处理逻辑，可以精确支撑输血科的月度运营分析，为科室管理和决策提供准确的数据支撑。 
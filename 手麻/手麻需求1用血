-- 基于参考SQL重构的手麻需求用血查询（去掉不存在的血制品表）
SELECT
    ssks.department_chinese_name AS "手术科室",
    COALESCE(ieg.ipi_registration_no, opc.opc_registration_no) AS "患者住院号",
    info.patient_name AS "患者姓名",
    xb.s_xb_cmc AS "性别",
    -- 年龄计算修复：直接从varchar提取年份计算，避免时区问题
    CASE 
        WHEN info.birthday IS NOT NULL AND info.scheduled_date IS NOT NULL 
            AND length(info.birthday) >= 4 AND length(info.scheduled_date) >= 4
        THEN CAST(CAST(substr(info.scheduled_date, 1, 4) AS integer) - CAST(substr(info.birthday, 1, 4) AS integer) AS varchar)
        ELSE ''
    END AS "年龄",
    info.bed_no AS "床号",
    -- 台次计算适配presto
    ROW_NUMBER() OVER(PARTITION BY info.room_id, substr(info.scheduled_date, 1, 10) ORDER BY info.in_oproom_date, info.operator_begin_date) AS "台次",
    info.in_oproom_date AS "入室时间",  
    info.out_oproom_date AS "出室时间",
    info.operator_begin_date AS "手术开始时间",
    info.operator_end_date AS "手术结束时间",
    info.ana_beging_date AS "麻醉开始时间",
    info.ana_end_date AS "麻醉结束时间",
    info.oper_name AS "手术名称",
    info.oper_code AS "手术编码", 
    info.main_diag AS "诊断",
    ssem.employee_name AS "主刀医生",
    mzem.employee_name AS "麻醉医生",
    mzem1.employee_name AS "麻醉助手1",
    mzem2.employee_name AS "麻醉助手2", 
    xhdoc.employee_name AS "巡回护士",
    xsdoc.employee_name AS "洗手护士",
    mzfs.mzfs_cmc AS "麻醉方式",
    info.asa AS "ASA分级",
    rm.oper_room AS "手术间",
    CASE WHEN info.emergency = '1' THEN '急诊' ELSE '择期' END AS "手术类型",
    info.qkdj AS "切口等级",
    info.ssdj AS "手术等级",
    
    -- 通过麻醉事件表的事件正文获取血液制品信息
    CASE 
        WHEN ae.event_text LIKE '%红细胞%' OR ae.event_text LIKE '%RBC%' OR ae.event_text LIKE '%红血球%' THEN '红细胞'
        WHEN ae.event_text LIKE '%血浆%' OR ae.event_text LIKE '%PLASMA%' OR ae.event_text LIKE '%血清%' THEN '血浆'
        WHEN ae.event_text LIKE '%血小板%' OR ae.event_text LIKE '%PLT%' OR ae.event_text LIKE '%血小%' THEN '血小板'
        WHEN ae.event_text LIKE '%冷沉淀%' OR ae.event_text LIKE '%CRYO%' OR ae.event_text LIKE '%冷凝%' THEN '冷沉淀'
        WHEN ae.event_text LIKE '%全血%' OR ae.event_text LIKE '%WHOLE%' THEN '全血'
        WHEN ae.event_text IS NOT NULL AND ae.s_mzsjlb_dm = '31' THEN ae.event_text
        ELSE ''
    END AS "血液制品类型",
    COALESCE(CAST(ae.single_dose AS varchar), '') AS "输血量",
        -- 输血量单位中文名称（新增，通过字典表解析）
    COALESCE(jldw.s_jldw_cmc, ae.single_dose_unit, '') AS "输血量单位",
    COALESCE(ae.ordered_date, '') AS "输血时间" -- 输血时间

FROM (
    SELECT 
        a.id as apply_id,
        MAX(a.is_reject) as is_reject,
        MAX(ar.id) as anar_id,
        MAX(a.is_emergency) as emergency,
        MAX(reg.ipi_registration_id) as ipi_registration_id,
        MAX(reg.opc_registration_id) as opc_registration_id,
        MAX(reg.patient_name) as patient_name,
        MAX(o.operation_name) as operation_name,
        MAX(a.is_emergency) as is_emergency,
        MAX(reg.s_xb_dm) as s_xb_dm,
        MAX(reg.sam_room_id) as room_id,
        MAX(a.s_sssyzt_dm) as s_sssyzt_dm,
        MAX(reg.bed_no) as bed_no,
        MAX(a.scheduled_date) as scheduled_date,
        MAX(reg.birthday) as birthday,
        MAX(reg.main_diag) as main_diag,
        MAX(o.operator_doctor_id) as ssdoc_id,
        MAX(o.narcotic_doctor_id) as mzdoc_id,
        MAX(o.narcotic_assistant_1) as mzzs1_id,
        MAX(o.narcotic_assistant_2) as mzzs2_id,
        MAX(o.circuit_nurse_01) as xhdoc_id,
        MAX(o.scrub_nurse_01) as xsdoc_id,
        MAX(o.s_asamzfj_dm) as asa,
        MAX(o.s_ssjb_dm) as ssdj,
        MAX(o.s_ssqk_dj_dm) as qkdj,
        MAX(o.operation_code) as oper_code,
        -- 手术名称聚合，适配presto语法
        array_join(array_agg(o.operation_name ORDER BY a.id), ';') as oper_name,
        MAX(reg.patient_dept_id) as dept_id,
        MAX(ar.in_oproom_date) as in_oproom_date,
        MAX(ar.out_oproom_date) as out_oproom_date,
        MAX(ar.oper_beging_date) as operator_begin_date,
        MAX(ar.oper_end_date) as operator_end_date,
        MAX(ar.ana_beging_date) as ana_beging_date,
        MAX(ar.ana_end_date) as ana_end_date
    FROM hid0101_orcl_operaanesthisa_emrhis.sam_apply a
    LEFT JOIN hid0101_orcl_operaanesthisa_emrhis.sam_reg reg 
        ON reg.id = a.id AND reg.isdeleted = '0'
    LEFT JOIN hid0101_orcl_operaanesthisa_emrhis.ipi_registration ig
        ON ig.id = reg.ipi_registration_id AND ig.isdeleted = '0'
    LEFT JOIN hid0101_orcl_operaanesthisa_emrhis.opc_registration og
        ON og.id = reg.opc_registration_id AND og.isdeleted = '0'
    LEFT JOIN hid0101_orcl_operaanesthisa_emrhis.sam_reg_op o 
        ON reg.id = o.sam_reg_id AND o.isdeleted = '0'
    LEFT JOIN hid0101_orcl_operaanesthisa_emrhis.sam_anar ar 
        ON a.id = ar.sam_apply_id AND ar.isdeleted = '0'
    WHERE a.health_service_org_id = 'HXSSMZK'
        AND a.oper_type = 'ROOM_OPER' 
        AND a.s_sssyzt_dm = '90'
        AND a.is_reject = '2'
        AND a.isdeleted = '0'
        -- 日期条件可根据需要调整
        AND a.scheduled_date >= '2024-01-01 00:00:00'
        AND a.scheduled_date <= '2024-12-31 23:59:59'
    GROUP BY a.id
) info
LEFT JOIN hid0101_orcl_operaanesthisa_emrhis.ipi_registration ieg 
    ON ieg.id = info.ipi_registration_id AND ieg.isdeleted = '0'
LEFT JOIN hid0101_orcl_operaanesthisa_emrhis.opc_registration opc 
    ON opc.id = info.opc_registration_id AND opc.isdeleted = '0'
LEFT JOIN hid0101_orcl_operaanesthisa_emrhis.sam_room rm  
    ON rm.id = info.room_id AND rm.isdeleted = '0'
LEFT JOIN hid0101_orcl_operaanesthisa_emrhis.hrm_employee ssem 
    ON ssem.id = info.ssdoc_id AND ssem.isdeleted = '0'
-- 手术科室关联（通过主刀医生所属科室）
LEFT JOIN hid0101_orcl_operaanesthisa_emrhis.hra00_department ssks 
    ON ssks.id = ssem.department_id AND ssks.isdeleted = '0'
LEFT JOIN hid0101_orcl_operaanesthisa_emrhis.hrm_employee mzem 
    ON mzem.id = info.mzdoc_id AND mzem.isdeleted = '0'
LEFT JOIN hid0101_orcl_operaanesthisa_emrhis.hrm_employee mzem1 
    ON mzem1.id = info.mzzs1_id AND mzem1.isdeleted = '0'
LEFT JOIN hid0101_orcl_operaanesthisa_emrhis.hrm_employee mzem2 
    ON mzem2.id = info.mzzs2_id AND mzem2.isdeleted = '0'
LEFT JOIN hid0101_orcl_operaanesthisa_emrhis.hrm_employee xhdoc 
    ON xhdoc.id = info.xhdoc_id AND xhdoc.isdeleted = '0'
LEFT JOIN hid0101_orcl_operaanesthisa_emrhis.hrm_employee xsdoc 
    ON xsdoc.id = info.xsdoc_id AND xsdoc.isdeleted = '0'
LEFT JOIN hid0101_orcl_operaanesthisa_emrhis.gb_t_2261_1_2003 xb 
    ON xb.s_xb_dm = info.s_xb_dm AND xb.isdeleted = '0'
LEFT JOIN (
    SELECT 
        r.sam_apply_id,
        array_join(array_agg(n.node_value ORDER BY n.id), ';') as mzfs_cmc
    FROM hid0101_orcl_operaanesthisa_emrhis.sam_emr_rec r
    LEFT JOIN hid0101_orcl_operaanesthisa_emrhis.sam_emr_rec_nv n
        ON n.sam_emr_rec_id = r.id AND n.isdeleted = '0'
    WHERE r.rss_emr_type_id = 'sam_mzfs'
        AND n.node_name = 'S_MZFS_DM'
        AND r.isdeleted = '0'
    GROUP BY r.sam_apply_id
) mzfs ON mzfs.sam_apply_id = info.apply_id

-- 关联麻醉事件表获取输血信息（不依赖血制品目录表）
LEFT JOIN hid0101_orcl_operaanesthisa_emrhis.sam_anar_enent ae 
    ON info.apply_id = ae.sam_apply_id 
    AND ae.s_mzsjlb_dm = '31'  -- 输血事件类别代码
    AND ae.isdeleted = '0'

    -- 关联计量单位字典表获取单位中文名称
LEFT JOIN hid0101_orcl_operaanesthisa_emrhis.pub_jldw jldw 
    ON jldw.s_jldw_dm = ae.single_dose_unit 
    AND jldw.isdeleted = '0'

ORDER BY info.scheduled_date DESC, info.apply_id, ae.exec_date
LIMIT 100;